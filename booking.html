<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å¿«æ¨‚å°ç‹— Pinyuï½œé ç´„è¨­å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* ========== å…¨åŸŸæ¨£å¼ ========== */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f7fc;
      color: #333;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }

    header {
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
      border-bottom: 1px solid #d0e2ff;
      color: #144a7e;
      background: #ffffff;
    }

    /* ========== æ­¥é©ŸæŒ‡ç¤ºå™¨ ========== */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 12px 8px 0;
      font-size: 12px;
      color: #7a8baa;
      flex-wrap: wrap;
    }

    .step-dot {
      display: flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }

    .step-circle {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #d1e4ff;
    }

    .step-dot.active .step-circle { background: #48a2e8; }
    .step-dot.active span { color: #225f9f; font-weight: 600; }

    .step-sep { color: #c4d7f1; font-size: 12px; }

    /* ========== å…§å®¹å€ ========== */
    .content {
      padding: 12px 16px 16px;
      flex: 1;
      overflow-y: auto;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #123456;
    }

    .section-sub {
      font-size: 13px;
      color: #667a95;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    /* ========== è¡¨å–®æ¬„ä½ ========== */
    .field-group { margin-bottom: 16px; }

    .field-label {
      font-size: 14px;
      margin-bottom: 6px;
      color: #3f4f66;
    }

    .text-input,
    .date-input,
    textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #cfe0f5;
      background: #ffffff;
      font-size: 14px;
      box-sizing: border-box;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    .text-input:focus,
    .date-input:focus,
    textarea:focus {
      border-color: #48a2e8;
      outline: none;
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-row span {
      font-size: 12px;
      color: #7a8baa;
    }

    /* ========== é¸é …å¡ ========== */
    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .option-card {
      border-radius: 14px;
      border: 1px solid #d1e4ff;
      background: #ffffff;
      padding: 12px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s ease;
      user-select: none;
    }

    .option-card.active {
      background: #e9f3ff;
      border-color: #48a2e8;
      box-shadow: 0 2px 8px rgba(72, 162, 232, 0.25);
    }

    .option-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .option-title {
      font-size: 15px;
      font-weight: 600;
      color: #123456;
    }

    .option-desc {
      font-size: 12px;
      color: #6c7a8f;
    }

    .option-tag {
      font-size: 11px;
      background: #dff0ff;
      padding: 3px 8px;
      border-radius: 999px;
      color: #1c5b9f;
    }

    /* ========== æ‘˜è¦æ¡† ========== */
    .summary-box {
      background: #f0f6ff;
      border: 1px solid #d1e4ff;
      padding: 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.7;
      margin-bottom: 16px;
      color: #3f4f66;
    }

    .summary-box strong { color: #123456; }

    /* ========== Step4ï¼šæ¯æ—¥æ™‚æ®µ ========== */
    .day-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .day-row {
      background: #f7fbff;
      border: 1px solid #dce8fa;
      border-radius: 12px;
      padding: 10px 12px;
    }

    .day-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 14px;
      color: #123456;
      gap: 10px;
    }

    .day-row-header span:last-child {
      font-size: 12px;
      color: #738099;
      white-space: nowrap;
    }

    .slot-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .slot-chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cfe3fb;
      background: #ffffff;
      font-size: 12px;
      cursor: pointer;
      color: #3f4f66;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .slot-chip small {
      font-size: 10px;
      margin-left: 3px;
      color: #8695a8;
    }

    .slot-chip.active {
      background: #dff0ff;
      border-color: #48a2e8;
      color: #1d5fae;
    }

    .minute-select {
      border: 1px solid #cfe3fb;
      border-radius: 999px;
      padding: 4px 8px;
      background: #fff;
      font-size: 12px;
      cursor: pointer;
      color: #1d5fae;
    }

    /* ========== å‹¾é¸æ¡†åˆ—è¡¨ ========== */
    .checkbox-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checkbox-item {
      font-size: 14px;
      color: #3f4f66;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      line-height: 1.5;
    }

    /* ========== Quote Card ========== */
    .quote-card {
      border-radius: 16px;
      border: 1px solid #d3e3f8;
      background: #ffffff;
      padding: 16px 14px 12px;
      font-size: 13px;
    }

    .quote-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .quote-range {
      font-size: 15px;
      font-weight: 700;
      color: #123456;
    }

    .quote-service-type {
      font-size: 12px;
      color: #6d7b90;
    }

    .quote-total {
      font-size: 20px;
      font-weight: 700;
      color: #e28c27;
      white-space: nowrap;
    }

    .quote-section {
      border-top: 1px dashed #cbd8ee;
      padding-top: 10px;
      margin-top: 10px;
    }

    .quote-section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #123456;
    }

    .quote-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
      color: #4b5e7c;
      gap: 10px;
    }

    .quote-line span:first-child { color: #7a8baa; }

    .quote-subtotal {
      margin-top: 8px;
      font-size: 15px;
      font-weight: 700;
      text-align: right;
      color: #123456;
    }

    .highlight-text { color: #e28c27; font-weight: 700; }

    /* ========== åº•éƒ¨æŒ‰éˆ•å€ ========== */
    .bottom-bar {
      padding: 12px 16px 18px;
      border-top: 1px solid #d0e2ff;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .primary-btn,
    .secondary-btn {
      width: 100%;
      border-radius: 999px;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      border: none;
    }

    .primary-btn {
      background: #48a2e8;
      color: #ffffff;
      box-shadow: 0 3px 8px rgba(72, 162, 232, 0.25);
    }

    .primary-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    .secondary-btn {
      background: #e9f3ff;
      color: #234e7d;
    }

    .sub-text {
      font-size: 12px;
      text-align: center;
      color: #6c7a8f;
      line-height: 1.6;
    }

    .hidden { display: none; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #d1e4ff;
      background: #fff;
      font-size: 13px;
      color: #234e7d;
    }

    .muted { color: #6c7a8f; font-size: 12px; }
  </style>
</head>

<body>
  <div class="page">

    <header>è¨­å®šé ç´„éœ€æ±‚</header>

    <!-- Step Indicator -->
<div class="step-indicator">
  <div class="step-dot" data-ind="1">
    <div class="step-circle"></div><span>è»Šé¦¬è²»</span>
  </div>
  <span class="step-sep">â€º</span>

  <div class="step-dot" data-ind="2">
    <div class="step-circle"></div><span>æœå‹™æ—¥æœŸ</span>
  </div>
  <span class="step-sep">â€º</span>

  <div class="step-dot" data-ind="3">
    <div class="step-circle"></div><span>é »ç‡</span>
  </div>
  <span class="step-sep">â€º</span>

  <div class="step-dot" data-ind="4">
    <div class="step-circle"></div><span>æœå‹™æ–¹æ¡ˆ</span>
  </div>
  <span class="step-sep">â€º</span>

  <div class="step-dot" data-ind="5">
    <div class="step-circle"></div><span>åŠ è³¼é …ç›®</span>
  </div>
  <span class="step-sep">â€º</span>

  <div class="step-dot" data-ind="6">
    <div class="step-circle"></div><span>è©¦ç®—å ±åƒ¹</span>
  </div>
</div>


    <div class="content">


      <!-- STEP 0ï¼šæ–°å®¢é ˆçŸ¥ + è·é›¢è©¦ç®—ï¼ˆèˆŠå®¢è·³éï¼‰ -->
      <div class="step-panel" id="step0">
        <div class="section-title">é ç´„é ˆçŸ¥ï¼ˆæ–°å®¢ï¼‰</div>
        <div class="section-sub">ç‚ºäº†è®“ç…§é¡§æ›´é †åˆ©ï¼Œè«‹å…ˆé–±è®€ä¸¦åŒæ„ä»¥ä¸‹é ˆçŸ¥ã€‚</div>

        <div class="summary-box">
          <strong>ğŸ¾ é ç´„å‰è«‹ç•™æ„</strong><br>
          1) æœå‹™ä»¥æ¯›å­©å®‰å…¨ç‚ºå„ªå…ˆï¼Œå¦‚é‡ç·Šæ€¥ç‹€æ³æœƒå…ˆè¯çµ¡é£¼ä¸»ï¼Œå¿…è¦æ™‚å”åŠ©å°±é†«ã€‚<br>
          2) åˆ°åºœæœå‹™éœ€æä¾›å¯é€²å‡ºæ–¹å¼ï¼ˆé‘°åŒ™ï¼é–€ç¦ï¼ä»£æ”¶ï¼‰èˆ‡åŸºæœ¬æ¸…æ½”è€—æï¼ˆåƒåœ¾è¢‹ã€è²“ç ‚è¢‹ç­‰ï¼‰ã€‚<br>
          3) ç³»çµ±è©¦ç®—ç‚ºé ä¼°é‡‘é¡ï¼Œå¯¦éš›ä»ä»¥ Pinyu æœ€çµ‚ç¢ºèªç‚ºä¸»ã€‚<br>
          4) è‹¥éœ€è‡¨æ™‚æ”¹æ™‚æ®µæˆ–åŠ å–®ï¼Œå°‡ä¾ç•¶æ—¥å‹•ç·šèˆ‡æª”æœŸå®‰æ’ç‚ºæº–ã€‚<br>
        </div>

        <div class="section-title" style="font-size:16px;margin-top:6px;">è»Šé¦¬è²»è©¦ç®—</div>
        <div class="section-sub">æ–°å®¢è«‹è¼¸å…¥ Google Mapsã€Œä¸­å±±æ·é‹ç«™ â†’ æ‚¨çš„åœ°å€ã€æ©Ÿè»Šæ¨¡å¼çš„å…¬é‡Œæ•¸ï¼ˆå°æ•¸æœƒå››æ¨äº”å…¥ï¼‰ã€‚</div>

        <div class="field-group">
          <div class="field-label">è«‹è¼¸å…¥å…¬é‡Œæ•¸</div>
          <input type="number" step="0.1" id="distanceKm" class="text-input" placeholder="ä¾‹å¦‚ï¼š4.7 æˆ– 12.3">
        </div>

        <div class="summary-box" id="fareResultBox">å°šæœªè¼¸å…¥å…¬é‡Œæ•¸ã€‚</div>

        <label class="checkbox-item" style="margin-top:6px;">
          <input type="checkbox" id="agreeNotice">
          <span>æˆ‘å·²é–±è®€ä¸¦åŒæ„ä»¥ä¸Šé ç´„é ˆçŸ¥</span>
        </label>
      </div>

      <!-- STEP 1ï¼šæ—¥æœŸ -->
      <div class="step-panel hidden" id="step1">
        <div class="section-title">é¸æ“‡æœå‹™æ—¥æœŸ</div>
        <div class="section-sub">å…ˆé¸æ—¥æœŸå€é–“ï¼Œä¹‹å¾Œå†é¸æœå‹™é¡å‹èˆ‡é »ç‡ã€‚</div>

        <div class="field-group">
          <div class="field-label">æœå‹™æ—¥æœŸå€é–“</div>
          <div class="date-row">
            <input type="date" id="startDate" class="date-input">
            <span>è‡³</span>
            <input type="date" id="endDate" class="date-input">
          </div>
        </div>

        <div class="summary-box" id="step1Summary">å°šæœªé¸æ“‡æ—¥æœŸã€‚</div>
      </div>

      <!-- STEP 2ï¼šä¸»è¦æœå‹™é¡å‹ -->
      <div class="step-panel hidden" id="step2">
        <div class="section-title">é¸æ“‡ä¸»è¦æœå‹™é¡å‹</div>
        <div class="section-sub">æ•´æ®µæœŸé–“æ¡ç”¨ç›¸åŒæœå‹™é¡å‹ã€‚</div>

        <div class="options-grid" id="serviceTypeGrid">
          <div class="option-card" data-service="åˆ°åºœç…§é¡§">
            <div class="option-main">
              <div class="option-title">åˆ°åºœç…§é¡§</div>
              <div class="option-desc">é¤µé£Ÿï½œè£œæ°´ï½œæ¸…æ½”ï½œé™ªä¼´ï½œç…§ç‰‡å›å ±</div>
            </div>
            <div class="option-tag">æœ€å¸¸è¦‹</div>
          </div>

          <div class="option-card" data-service="é›ç‹—æ•£æ­¥">
            <div class="option-main">
              <div class="option-title">é›ç‹—æ•£æ­¥</div>
              <div class="option-desc">æ•£æ­¥ï½œæ’ä¾¿è§€å¯Ÿï½œå®‰å…¨äº’å‹•</div>
            </div>
            <div class="option-tag">å¤–å‡º</div>
          </div>

          <div class="option-card" data-service="é•·æ™‚é–“é™ªä¼´">
            <div class="option-main">
              <div class="option-title">é•·æ™‚é–“é™ªä¼´</div>
              <div class="option-desc">é©åˆåˆ†é›¢ç„¦æ…®ã€éœ€è¦é™ªä¼´çš„æ¯›å­©</div>
            </div>
            <div class="option-tag">åŠ å¼·å®‰å…¨æ„Ÿ</div>
          </div>
        </div>

        <div class="summary-box" id="serviceTypeSummary">å°šæœªé¸æ“‡æœå‹™é¡å‹ã€‚</div>
      </div>

      <!-- STEP 3ï¼šé è¨­åˆ†é˜ -->
      <div class="step-panel hidden" id="step3">
        <div class="section-title">é¸æ“‡é è¨­æ¯æ¬¡åˆ†é˜æ–¹æ¡ˆ</div>
        <div class="section-sub">
          é€™æ˜¯ã€Œé è¨­å€¼ã€ï¼šä¸‹ä¸€æ­¥å¯é‡å°æ¯æ¬¡åˆ°è¨ªï¼ˆæ—©/åˆ/æ™š/æ·±å¤œï¼‰å–®ç¨èª¿æ•´åˆ†é˜ã€‚
        </div>

        <div class="options-grid" id="minutesGrid">
          <div class="option-card" data-minutes="30">
            <div class="option-main">
              <div class="option-title">30 åˆ†é˜</div>
              <div class="option-desc">åŸºç¤ç…§è­·ï¼šé¤µé£Ÿã€è£œæ°´ã€æ¸…æ½”ã€ç´€éŒ„</div>
            </div>
            <div class="option-tag">åŸºç¤</div>
          </div>

          <div class="option-card" data-minutes="45">
            <div class="option-main">
              <div class="option-title">45 åˆ†é˜</div>
              <div class="option-desc">æ›´å……è£•çš„æ¸…æ½”èˆ‡äº’å‹•æ™‚é–“</div>
            </div>
            <div class="option-tag">åŠ å¼·</div>
          </div>

          <div class="option-card" data-minutes="60">
            <div class="option-main">
              <div class="option-title">60 åˆ†é˜</div>
              <div class="option-desc">é«˜éœ€æ±‚æ¯›å­©æˆ–é•·æ™‚é–“é™ªä¼´</div>
            </div>
            <div class="option-tag">ç†±é–€</div>
          </div>
        </div>

        <div class="summary-box" id="minutesSummary">å°šæœªé¸æ“‡é è¨­åˆ†é˜ã€‚</div>
      </div>

      <!-- STEP 4ï¼šé »ç‡æ¨¡æ¿ + æ¯æ—¥æ™‚æ®µï¼ˆæ¯æ¬¡åˆ°è¨ªå¯æ”¹åˆ†é˜ï¼‰ -->
      <div class="step-panel hidden" id="step4">
        <div class="section-title">é¸æ“‡é »ç‡ä¸¦èª¿æ•´åˆ°è¨ªæ™‚æ®µ</div>
        <div class="section-sub">
          å…ˆé¸é è¨­é »ç‡æ¨¡æ¿ï¼Œç³»çµ±æœƒè‡ªå‹•å‹¾é¸æ™‚æ®µï¼›ä½ ä¹Ÿå¯ä»¥é€æ—¥å¾®èª¿ã€‚<br>
          <span class="muted">æç¤ºï¼šå‹¾é¸æŸå€‹æ™‚æ®µå¾Œï¼Œå¯åœ¨è©²æ™‚æ®µæ—é¸æ“‡é€™æ¬¡è¦ç”¨çš„åˆ†é˜ã€‚</span>
        </div>

        <div class="field-group">
          <div class="field-label">é è¨­é »ç‡</div>
          <div class="options-grid" id="templateGrid">
            <div class="option-card" data-template="daily1-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 1 æ¬¡ï¼ˆé è¨­æ™šä¸Šï¼‰</div>
                <div class="option-desc">é©åˆçŸ­æš«å¤–å‡ºã€æ¯›å­©ä½œæ¯ç©©å®šã€‚</div>
              </div>
              <div class="option-tag">å¸¸è¦‹</div>
            </div>

            <div class="option-card" data-template="daily2-morning-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 2 æ¬¡ï¼ˆæ—©ï¼‹æ™šï¼‰</div>
                <div class="option-desc">æ—©æ™šå„ä¸€è¶Ÿï¼Œå…¼é¡§è£œæ°´æ¸…æ½”èˆ‡é™ªä¼´ã€‚</div>
              </div>
              <div class="option-tag">æœ€å¤šäººé¸</div>
            </div>

            <div class="option-card" data-template="daily3-morning-afternoon-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 3 æ¬¡ï¼ˆæ—©ï¼‹åˆï¼‹æ™šï¼‰</div>
                <div class="option-desc">éœ€è¦æ›´å¤šé—œå¿ƒæ™‚åˆ»çš„æ¯›å­©ã€‚</div>
              </div>
              <div class="option-tag">åŠ å¼·</div>
            </div>

            <div class="option-card" data-template="custom-empty">
              <div class="option-main">
                <div class="option-title">å®Œå…¨è‡ªè¨‚</div>
                <div class="option-desc">è‡ªç”±å‹¾é¸æ¯å¤©è¦åˆ°è¨ªçš„æ™‚æ®µã€‚</div>
              </div>
              <div class="option-tag">å½ˆæ€§</div>
            </div>
          </div>
        </div>

        <div class="summary-box" id="step4Summary">å°šæœªé¸æ“‡é »ç‡æ¨¡æ¿ã€‚</div>

        <div id="dayList" class="day-list"></div>

        <div class="summary-box" id="step4VisitSummary">å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚</div>
      </div>

      <!-- STEP 5ï¼šæ¯›å­©æ•¸é‡ -->
      <div class="step-panel hidden" id="step5">
        <div class="section-title">æ¯›å­©è³‡è¨Š</div>
        <div class="section-sub">ä»¥ä¸‹è³‡è¨Šå½±éŸ¿éƒ¨åˆ†åŠ åƒ¹é …ç›®ã€‚</div>

        <div class="field-group">
          <div class="field-label">ç‹—ç‹—éš»æ•¸ï¼ˆé›ç‹—æ•£æ­¥ç¬¬äºŒéš»èµ· +100ï¼è¨ªè¦–ï¼‰</div>
          <input type="number" id="dogCount" class="text-input" min="0" value="0">
        </div>

        <div class="field-group">
          <div class="field-label">è²“å’ªéš»æ•¸ï¼ˆç¬¬ä¸‰éš»ä»¥ä¸Šè¦–æƒ…æ³åŠ åƒ¹ï¼‰</div>
          <input type="number" id="catCount" class="text-input" min="0" value="0">
        </div>

        <div class="summary-box" id="multiPetSummary">å°šæœªè¼¸å…¥æ¯›å­©æ•¸é‡ã€‚</div>
      </div>

      <!-- STEP 6ï¼šåŠ è³¼ -->
      <div class="step-panel hidden" id="step6">
        <div class="section-title">åŠ è³¼é …ç›®ï¼ˆå¯é¸ï¼‰</div>
        <div class="section-sub">è‹¥æ¯›å­©æœ‰é¡å¤–éœ€æ±‚ï¼Œå¯æ–¼æ­¤è™•åŠ è³¼ã€‚</div>

        <div class="checkbox-list">
          <label class="checkbox-item">
            <input type="checkbox" data-addon="medicine" data-price="50">
            <span>é¤µè—¥æœå‹™ï¼ˆ+50ï¼æ¬¡ï¼‰</span>
          </label>

          <label class="checkbox-item" id="addonMultiDogRow">
            <input type="checkbox" data-addon="multi-dog" data-price="100">
            <span>å¤šçŠ¬åŠ åƒ¹ï¼ˆç¬¬äºŒéš»ç‹—èµ· +100ï¼æ¬¡ï¼‰<br><span class="muted">åƒ…é›ç‹—æ•£æ­¥é©ç”¨</span></span>
          </label>
        </div>

        <div class="summary-box" id="addonSummary">å°šæœªé¸æ“‡åŠ è³¼é …ç›®ã€‚</div>
      </div>

      <!-- STEP 7ï¼šå‚™è¨» + è©¦ç®— + é€å‡º -->
      <div class="step-panel hidden" id="step7">
        <div class="section-title">å‚™è¨»èˆ‡è©¦ç®—å ±åƒ¹</div>
        <div class="section-sub">
          è‹¥æœ‰å¸Œæœ›çš„åˆ°è¨ªæ™‚æ®µã€æ¯›å­©ç‹€æ³æˆ–ç…§é¡§éœ€æ±‚ï¼Œè«‹åœ¨ä¸‹æ–¹å‚™è¨»ã€‚<br>
          ç³»çµ±è©¦ç®—ç‚ºé ä¼°é‡‘é¡ï¼Œå¯¦éš›ä»ä»¥ Pinyu æœ€çµ‚ç¢ºèªç‚ºä¸» ğŸ’›
        </div>

        <div class="field-group">
          <div class="field-label">å‚™è¨»ï¼ˆé¸å¡«ï¼‰</div>
          <textarea id="noteText" placeholder="ä½ å¯ä»¥å¯«ï¼š
- å¸Œæœ›åˆ°è¨ªæ™‚é–“åå¥½ï¼ˆä¾‹å¦‚ï¼šæ™šä¸Š7é»å‰ï¼æ—©ä¸Šè¶Šæ—©è¶Šå¥½ï¼‰
- æ¯›å­©ç‹€æ³ï¼ˆæ€•ç”Ÿã€æœƒèº²ã€éœ€è¦æ…¢æ…¢é è¿‘ã€æ˜¯å¦æœƒå’¬/è­·é£Ÿï¼‰
- æœ¬æ¬¡éœ€æ±‚ï¼ˆè£œæ°´ã€æ¸…è²“ç ‚ã€é™ªç©10åˆ†é˜ã€æ‹ç…§å›å ±ï¼‰
- å…¶ä»–ï¼ˆæ¿•é£Ÿæ²’åƒå®Œè¦ä¸è¦æ”¶ã€åƒåœ¾æ”¾å“ªè£¡ç­‰ï¼‰"></textarea>
        </div>

        <div class="quote-card">
          <div class="quote-header">
            <div>
              <div class="quote-range" id="quoteRange"></div>
              <div class="quote-service-type" id="quoteServiceType"></div>
            </div>
            <div class="quote-total" id="quoteTotal"></div>
          </div>

          <div class="quote-section">
            <div class="quote-section-title">1. æœå‹™æ˜ç´°</div>

            <div class="quote-line"><span>æœå‹™æ—¥æœŸ</span><span id="quoteDateRangeText"></span></div>
            <div class="quote-line"><span>åˆ°è¨ªæ¬¡æ•¸</span><span id="quoteVisitCount"></span></div>
            <div class="quote-line"><span>åˆ†é˜åˆ†ä½ˆ</span><span id="quoteMinuteDist"></span></div>
            <div class="quote-line"><span>æœå‹™è²»</span><span id="quoteServiceFee"></span></div>
            <div class="quote-line"><span>è»Šé¦¬è²»</span><span id="quoteFareText"></span></div>
            <div class="quote-line"><span>å¤šå¯µåŠ åƒ¹</span><span id="quoteMultiPet"></span></div>
            <div class="quote-line"><span>åŠ è³¼é …ç›®</span><span id="quoteAddons"></span></div>

            <div class="quote-subtotal" id="quoteSubtotal"></div>
          </div>

          <div class="quote-section">
            <div class="quote-line"><span>è¨‚é‡‘</span><span id="quoteDepositText" class="highlight-text"></span></div>
            <div class="quote-line"><span>å‚™è¨»</span><span>æ­¤ç‚ºç³»çµ±è©¦ç®—é‡‘é¡ï¼Œå¯¦éš›ä»éœ€ç”± Pinyu æœ€çµ‚ç¢ºèªã€‚</span></div>
          </div>
        </div>

        <div class="summary-box" id="quoteDebugBox">ï¼ˆé–‹ç™¼ç”¨ï¼‰é€å‡ºæ™‚å°‡ä¸€ä½µå‚³é€å®Œæ•´æ˜ç´°ã€‚</div>
      </div>

    </div>

    <!-- Bottom Bar -->
    <div class="bottom-bar">
      <button class="secondary-btn hidden" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
      <button class="primary-btn" id="nextBtn">ä¸‹ä¸€æ­¥</button>
      <div class="sub-text" id="hintText">æœƒå…ˆå»ºç«‹é ç´„éœ€æ±‚ï¼Œä¿å§†ç¢ºèªå¾Œå†èˆ‡æ‚¨æ•²å®šå¯¦éš›é‡‘é¡èˆ‡æ™‚é–“ ğŸ¾</div>
    </div>
  </div>

  <!-- ç¬¬2/3æ®µï¼šJSï¼ˆä¸ŠåŠï¼‰è²¼åœ¨é€™è£¡ -->
<script>
/* ============================================================
   å…¨åŸŸç‹€æ…‹
============================================================ */

// æ¨¡æ“¬ userIdï¼ˆä¹‹å¾Œæ›æˆ LIFF å–å¾—ï¼‰
const mockUserId = "TEST_USER";

// å¾Œç«¯å›ä¾†çš„è³‡æ–™
let familyId = "";
let isNewCustomer = true;
let farePerVisit = 0;
let depositText = "éœ€è¨‚é‡‘ï¼ˆå¯¦éš›é‡‘é¡ç”± Pinyu å‘ŠçŸ¥ï¼‰";

// ä½¿ç”¨è€…é¸æ“‡
let startDate = null;
let endDate = null;

let serviceType = ""; // åˆ°åºœç…§é¡§ / é›ç‹—æ•£æ­¥ / é•·æ™‚é–“é™ªä¼´
let defaultMinutes = null; // Step3 é è¨­åˆ†é˜

let selectedTemplate = null;

// schedule çµæ§‹ï¼šschedule[dateKey][slotId] = { minutes: 30 }
let schedule = {};

// æ¯›å­©æ•¸é‡
let dogCountValue = 0;
let catCountValue = 0;
let dogExtraFeePerVisit = 0;
let catRequireEval = false;

// åŠ è³¼
let addons = {}; // { medicine: 50, "multi-dog": 100 }

// Step æ§åˆ¶
let currentStep = 0;

/* ============================================================
   åƒ¹æ ¼è¡¨ï¼ˆåˆ†é˜ â†’ å–®åƒ¹ï¼‰
   ä½ æ—¥å¾Œè¦æ”¹åƒ¹ï¼Œå°±æ”¹é€™è£¡å³å¯
============================================================ */
const PRICE_TABLE = {
  "åˆ°åºœç…§é¡§": { 30: 400, 45: 500, 60: 550 },
  "é›ç‹—æ•£æ­¥": { 30: 400, 45: 500, 60: 550 },
  "é•·æ™‚é–“é™ªä¼´": { 120: 900 },
};

const MINUTE_OPTIONS = [30, 45, 60];

/* ============================================================
   æ™‚æ®µå®šç¾©
============================================================ */
const SLOT_DEFS = [
  { id: "MORNING",   label: "æ—©ä¸Š", range: "09:00â€“12:00" },
  { id: "AFTERNOON", label: "ä¸‹åˆ", range: "13:00â€“17:00" },
  { id: "EVENING",   label: "æ™šä¸Š", range: "18:00â€“21:00" },
  { id: "LATE",      label: "æ·±å¤œ", range: "22:00â€“23:00" },
];

/* ============================================================
   DOM
============================================================ */
const stepDots = document.querySelectorAll(".step-dot");
  
// âœ… æ”¾é€™è£¡ï¼šå…ˆå®£å‘Š mapping
function getIndicatorIndex(step) {
  if (step === 0) return 1; // é ˆçŸ¥/è»Šé¦¬è²»
  if (step === 1) return 2; // æ—¥æœŸ
  if (step === 4) return 3; // é »ç‡/æ™‚æ®µ
  if (step === 2 || step === 3) return 4; // æœå‹™é¡å‹ + é è¨­åˆ†é˜ â†’ éƒ½ç®—ã€Œæœå‹™æ–¹æ¡ˆã€
  if (step === 5 || step === 6) return 5; // æ¯›å­© + åŠ è³¼ â†’ éƒ½ç®—ã€ŒåŠ è³¼é …ç›®ã€
  if (step === 7) return 6; // è©¦ç®—å ±åƒ¹/é€å‡º
  return 1;
}
  


const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const hintText = document.getElementById("hintText");

const stepPanels = {
  0: document.getElementById("step0"),
  1: document.getElementById("step1"),
  2: document.getElementById("step2"),
  3: document.getElementById("step3"),
  4: document.getElementById("step4"),
  5: document.getElementById("step5"),
  6: document.getElementById("step6"),
  7: document.getElementById("step7"),
};

// Step0
const distanceInput = document.getElementById("distanceKm");
const fareResultBox = document.getElementById("fareResultBox");
const agreeNotice = document.getElementById("agreeNotice");
let hasValidDistance = false;

// Step1
const startInput = document.getElementById("startDate");
const endInput = document.getElementById("endDate");
const step1Summary = document.getElementById("step1Summary");

// Step2
const serviceTypeCards = document.querySelectorAll("#serviceTypeGrid .option-card");
const serviceTypeSummary = document.getElementById("serviceTypeSummary");

// Step3
const minuteCards = document.querySelectorAll("#minutesGrid .option-card");
const minutesSummary = document.getElementById("minutesSummary");

// Step4
const templateCards = document.querySelectorAll("#templateGrid .option-card");
const step4Summary = document.getElementById("step4Summary");
const dayList = document.getElementById("dayList");
const step4VisitSummary = document.getElementById("step4VisitSummary");

// Step5
const dogCountInput = document.getElementById("dogCount");
const catCountInput = document.getElementById("catCount");
const multiPetSummary = document.getElementById("multiPetSummary");

// Step6
const addonInputs = document.querySelectorAll('#step6 input[type="checkbox"]');
const addonSummary = document.getElementById("addonSummary");
const addonMultiDogRow = document.getElementById("addonMultiDogRow");

// Step7
const noteText = document.getElementById("noteText");
const quoteRange = document.getElementById("quoteRange");
const quoteServiceType = document.getElementById("quoteServiceType");
const quoteTotal = document.getElementById("quoteTotal");
const quoteDateRangeText = document.getElementById("quoteDateRangeText");
const quoteVisitCount = document.getElementById("quoteVisitCount");
const quoteMinuteDist = document.getElementById("quoteMinuteDist");
const quoteServiceFee = document.getElementById("quoteServiceFee");
const quoteFareText = document.getElementById("quoteFareText");
const quoteMultiPet = document.getElementById("quoteMultiPet");
const quoteAddons = document.getElementById("quoteAddons");
const quoteSubtotal = document.getElementById("quoteSubtotal");
const quoteDepositText = document.getElementById("quoteDepositText");
const quoteDebugBox = document.getElementById("quoteDebugBox");

/* ============================================================
   Step UI
============================================================ */
function updateStepUI() {
  Object.values(stepPanels).forEach(p => p.classList.add("hidden"));
  stepPanels[currentStep].classList.remove("hidden");

  // Indicator active
  const ind = getIndicatorIndex(currentStep);

stepDots.forEach(dot => {
  const n = Number(dot.dataset.ind);   // âœ… ç”¨ ind
  dot.classList.toggle("active", n === ind);
});

  // èˆŠå®¢ä¸é¡¯ç¤º Step0 çš„ indicator ä¹Ÿå¯ä»¥ï¼šé€™è£¡ç°¡åŒ–ä¿ç•™é¡¯ç¤ºï¼Œä½†æœƒç›´æ¥è·³é
  // ä½ è‹¥è¦éš±è—ä¹Ÿè¡Œï¼Œæˆ‘ä¹‹å¾Œå†å¹«ä½ æ”¹ã€‚

  // Buttons + hints
  prevBtn.classList.toggle("hidden", currentStep === 0);

  if (currentStep === 0) {
    prevBtn.classList.add("hidden");
    nextBtn.textContent = "é–‹å§‹é ç´„";
    hintText.textContent = "è«‹å…ˆé–±è®€é ˆçŸ¥ä¸¦å®Œæˆè»Šé¦¬è²»è©¦ç®— ğŸ¾";
  } else if (currentStep === 1) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "å…ˆé¸æ—¥æœŸï¼Œå†é¸æœå‹™é¡å‹èˆ‡é »ç‡ ğŸ’›";
  } else if (currentStep === 2) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "é¸æ“‡ä¸»è¦æœå‹™é¡å‹ã€‚";
  } else if (currentStep === 3) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "å…ˆé¸é è¨­åˆ†é˜ï¼Œä¸‹ä¸€æ­¥å¯é‡å°æ¯æ¬¡åˆ°è¨ªèª¿æ•´ã€‚";
  } else if (currentStep === 4) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "è«‹ç¢ºèªé »ç‡èˆ‡æ¯æ¬¡åˆ°è¨ªæ™‚æ®µï¼ˆå¯èª¿æ•´åˆ†é˜ï¼‰ã€‚";
  } else if (currentStep === 5) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "è¼¸å…¥æ¯›å­©æ•¸é‡ä»¥è¨ˆç®—æ˜¯å¦åŠ åƒ¹ã€‚";
  } else if (currentStep === 6) {
    nextBtn.textContent = "ä¸‹ä¸€æ­¥";
    hintText.textContent = "å¦‚éœ€é¤µè—¥ç­‰éœ€æ±‚ï¼Œå¯åŠ è³¼ã€‚";
  } else if (currentStep === 7) {
    nextBtn.textContent = "é€å‡ºé ç´„éœ€æ±‚";
    hintText.textContent = "é€å‡ºå¾Œæˆ‘æœƒå†èˆ‡æ‚¨ç¢ºèªç´°ç¯€èˆ‡æœ€çµ‚é‡‘é¡ ğŸ¾";
  }

  // Step6ï¼šä¾æœå‹™é¡å‹é¡¯ç¤ºåŠ è³¼åˆ—
  if (currentStep === 6) updateAddonVisibility();
}

/* ============================================================
   initBookingï¼šå‘å¾Œç«¯å–å¾—èˆŠå®¢/æ–°å®¢è³‡æ–™
   - æˆåŠŸï¼šè‹¥èˆŠå®¢ â†’ è·³åˆ° Step1ï¼›æ–°å®¢ â†’ ç•™åœ¨ Step0
   - å¤±æ•—ï¼šç•¶ä½œæ–°å®¢
============================================================ */
function initBooking() {
  fetch("/api/booking", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "initBooking",
      userId: mockUserId,
    }),
  })
  .then(r => r.json())
  .then(data => {
    if (!data || !data.ok) throw new Error("initBooking not ok");

    isNewCustomer = !!data.isNewCustomer;
    familyId = data.familyId || "";
    farePerVisit = Number(data.farePerVisit || 0);

    depositText = data.isRegular
      ? "å…è¨‚é‡‘ï¼ˆå¸¸å®¢ï¼‰"
      : "éœ€è¨‚é‡‘ï¼ˆå¯¦éš›é‡‘é¡ç”± Pinyu å‘ŠçŸ¥ï¼‰";

    // èˆŠå®¢ï¼šç›´æ¥è·³åˆ° Step1
    if (!isNewCustomer) currentStep = 1;
    updateStepUI();
  })
  .catch(err => {
    console.warn("initBooking failed:", err);
    // å¤±æ•—å°±ç•¶ä½œæ–°å®¢
    isNewCustomer = true;
    currentStep = 0;
    updateStepUI();
  });
}

/* ============================================================
   Step0ï¼šæ–°å®¢è»Šé¦¬è²»è©¦ç®—
============================================================ */
function calcFareFromDistance(kmValue) {
  const roundedKm = Math.round(kmValue);
  if (roundedKm <= 5) return { km: roundedKm, fare: 0 };
  return { km: roundedKm, fare: (roundedKm - 5) * 40 };
}

distanceInput.addEventListener("input", () => {
  const km = parseFloat(distanceInput.value);

  if (isNaN(km) || km <= 0) {
    fareResultBox.textContent = "å°šæœªè¼¸å…¥å…¬é‡Œæ•¸ã€‚";
    farePerVisit = 0;
    hasValidDistance = false;
    return;
  }

  const result = calcFareFromDistance(km);
  farePerVisit = result.fare;
  hasValidDistance = true;

  fareResultBox.innerHTML = `
    å››æ¨äº”å…¥å¾Œè·é›¢ï¼š<strong>${result.km} å…¬é‡Œ</strong><br>
    é ä¼°è»Šé¦¬è²»ï¼š<strong>${result.fare} å…ƒ / æ¬¡</strong>
  `;
});

/* ============================================================
   Step1ï¼šæ—¥æœŸ
============================================================ */
startInput.addEventListener("change", handleDateChange);
endInput.addEventListener("change", handleDateChange);

function handleDateChange() {
  startDate = parseDateStr(startInput.value);
  endDate = parseDateStr(endInput.value);

  if (startDate && endDate && endDate < startDate) {
    alert("çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ");
    endInput.value = "";
    endDate = null;
  }

  updateStep1Summary();
}

function updateStep1Summary() {
  if (!startDate || !endDate) {
    step1Summary.textContent = "å°šæœªé¸æ“‡æ—¥æœŸã€‚";
    return;
  }
  const days = getDateRangeArray(startDate, endDate).length;
  step1Summary.innerHTML = `å·²é¸æ“‡ï¼š<strong>${startInput.value} ï½ ${endInput.value}</strong>ï¼ˆå…± ${days} å¤©ï¼‰`;
}

/* ============================================================
   Step2ï¼šæœå‹™é¡å‹
============================================================ */
serviceTypeCards.forEach(card => {
  card.addEventListener("click", () => {
    serviceTypeCards.forEach(c => c.classList.remove("active"));
    card.classList.add("active");
    serviceType = card.dataset.service;

    serviceTypeSummary.textContent = `æ‚¨é¸æ“‡ï¼š${serviceType}`;

    // æœå‹™é¡å‹è®Šæ›´ â†’ é‡æ–°è¨ˆç®—æ¯›å­©åŠ åƒ¹ã€åŠ è³¼é¡¯ç¤º
    updateMultiPet();
    updateAddonVisibility();

    // è‹¥å·²ç¶“æœ‰ defaultMinutesï¼Œæ›´æ–° Step3 summary æ–‡å­—
    if (defaultMinutes) {
      const unit = PRICE_TABLE[serviceType]?.[defaultMinutes] ?? 0;
      minutesSummary.textContent = `é è¨­æ¯æ¬¡ ${defaultMinutes} åˆ†é˜ï¼ˆNT.${unit} / æ¬¡ï¼‰`;
      
    }
    if (!serviceType) {
  alert("è«‹å…ˆé¸æ“‡ä¸»è¦æœå‹™é¡å‹");
  return;
}

  });
});

/* ============================================================
   Step3ï¼šé è¨­åˆ†é˜
============================================================ */
minuteCards.forEach(card => {
  card.addEventListener("click", () => {
    minuteCards.forEach(c => c.classList.remove("active"));
    card.classList.add("active");

    defaultMinutes = Number(card.dataset.minutes);
    const unit = PRICE_TABLE[serviceType]?.[defaultMinutes] ?? 0;

    minutesSummary.textContent = `é è¨­æ¯æ¬¡ ${defaultMinutes} åˆ†é˜ï¼ˆNT.${unit} / æ¬¡ï¼‰`;

    // è‹¥ Step4 å·²ç¶“æœ‰é¸é scheduleï¼Œæœªä¾†è¦ä¸è¦è‡ªå‹•åŒæ­¥ï¼Ÿ
    // é€™è£¡æ¡ã€Œä¸å¼·åˆ¶è¦†è“‹ã€ï¼šé¿å…ä½¿ç”¨è€…å·²ç¶“æ¯æ¬¡å¾®èª¿åˆ†é˜è¢«é‡ç½®ã€‚
  });
});

/* ============================================================
   Step4ï¼šé »ç‡æ¨¡æ¿
============================================================ */
templateCards.forEach(card => {
  card.addEventListener("click", () => {
    templateCards.forEach(c => c.classList.remove("active"));
    card.classList.add("active");
    selectedTemplate = card.dataset.template;

    updateStep4Summary();

    // å¥—æ¨¡æ¿ä¸¦æ¸²æŸ“ day list
    applyTemplateToSchedule(selectedTemplate);
    renderDayList();
  });
});

function updateStep4Summary() {
  if (!selectedTemplate) {
    step4Summary.textContent = "å°šæœªé¸æ“‡é »ç‡æ¨¡æ¿ã€‚";
    return;
  }
  const map = {
    "daily1-evening": "æ¯æ—¥ 1 æ¬¡ï¼ˆæ™šä¸Šï¼‰",
    "daily2-morning-evening": "æ¯æ—¥ 2 æ¬¡ï¼ˆæ—©ï¼‹æ™šï¼‰",
    "daily3-morning-afternoon-evening": "æ¯æ—¥ 3 æ¬¡ï¼ˆæ—©ï¼‹åˆï¼‹æ™šï¼‰",
    "custom-empty": "å®Œå…¨è‡ªè¨‚",
  };
  step4Summary.innerHTML = `å·²é¸æ“‡é è¨­é »ç‡ï¼š<strong>${map[selectedTemplate] || selectedTemplate}</strong>`;
}

/* ============================================================
   Step5ï¼šæ¯›å­©æ•¸é‡
============================================================ */
dogCountInput.addEventListener("input", updateMultiPet);
catCountInput.addEventListener("input", updateMultiPet);

function updateMultiPet() {
  dogCountValue = Number(dogCountInput.value || 0);
  catCountValue = Number(catCountInput.value || 0);

  if (serviceType === "é›ç‹—æ•£æ­¥") {
    dogExtraFeePerVisit = Math.max(dogCountValue - 1, 0) * 100;
  } else {
    dogExtraFeePerVisit = 0;
  }

  catRequireEval = catCountValue >= 3;

  let text = `ç‹—ç‹—åŠ åƒ¹ï¼š+${dogExtraFeePerVisit} å…ƒ / è¨ªè¦–<br>`;
  text += catRequireEval ? `è²“å’ªï¼šç¬¬ä¸‰éš»ä»¥ä¸Šç”± Pinyu è©•ä¼°æ˜¯å¦åŠ åƒ¹ï¼ˆæœªè‡ªå‹•è¨ˆç®—ï¼‰` : `è²“å’ªï¼šæœªé”åŠ åƒ¹æ¢ä»¶`;

  multiPetSummary.innerHTML = text;
}

/* ============================================================
   Step6ï¼šåŠ è³¼
============================================================ */
addonInputs.forEach(box => {
  box.addEventListener("change", () => {
    const key = box.dataset.addon;
    const price = Number(box.dataset.price);

    if (box.checked) addons[key] = price;
    else delete addons[key];

    updateAddonSummary();
  });
});

function updateAddonVisibility() {
  // multi-dog åªåœ¨é›ç‹—æ•£æ­¥é¡¯ç¤ºï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆ always é¡¯ç¤ºä½† disabledï¼‰
  const show = serviceType === "é›ç‹—æ•£æ­¥";
  addonMultiDogRow.classList.toggle("hidden", !show);

  // è‹¥åˆ‡æ›æˆéæ•£æ­¥ï¼Œé †ä¾¿æŠŠ multi-dog å–æ¶ˆå‹¾é¸èˆ‡ç§»é™¤
  if (!show) {
    const multiDogCheckbox = addonMultiDogRow.querySelector('input[type="checkbox"]');
    if (multiDogCheckbox) multiDogCheckbox.checked = false;
    delete addons["multi-dog"];
    updateAddonSummary();
  }
}

function updateAddonSummary() {
  const text = Object.entries(addons)
    .map(([k, p]) => `${k} (+${p})`)
    .join("ã€");
  addonSummary.textContent = text || "å°šæœªé¸æ“‡åŠ è³¼é …ç›®ã€‚";
}

/* ============================================================
   Step Buttons
============================================================ */
nextBtn.addEventListener("click", () => {
  // Step0ï¼ˆæ–°å®¢ gateï¼‰
  if (currentStep === 0) {
    if (!agreeNotice.checked) {
      alert("è«‹å…ˆå‹¾é¸åŒæ„é ç´„é ˆçŸ¥");
      return;
    }
    if (isNewCustomer && !hasValidDistance) {
      alert("è«‹å…ˆè¼¸å…¥å…¬é‡Œæ•¸ä»¥è©¦ç®—è»Šé¦¬è²»");
      return;
    }
    currentStep = 1;
    updateStepUI();
    return;
  }

  if (currentStep === 1) {
    if (!startDate || !endDate) {
      alert("è«‹å…ˆé¸æ“‡æ—¥æœŸå€é–“");
      return;
    }
    currentStep = 2;
    updateStepUI();
    return;
  }

  if (currentStep === 2) {
    if (!serviceType) {
      alert("è«‹å…ˆé¸æ“‡ä¸»è¦æœå‹™é¡å‹");
      return;
    }
    currentStep = 3;
    updateStepUI();
    return;
  }

  if (currentStep === 3) {
    if (!defaultMinutes) {
      alert("è«‹å…ˆé¸æ“‡é è¨­åˆ†é˜ï¼ˆ30/45/60ï¼‰");
      return;
    }
    currentStep = 4;
    updateStepUI();
    return;
  }

  if (currentStep === 4) {
    if (!selectedTemplate) {
      alert("è«‹å…ˆé¸æ“‡é è¨­é »ç‡");
      return;
    }
    if (buildVisitArray().length === 0) {
      alert("è«‹è‡³å°‘å‹¾é¸ä¸€å€‹åˆ°è¨ªæ™‚æ®µ");
      return;
    }
    currentStep = 5;
    updateStepUI();
    return;
  }

  if (currentStep === 5) {
    currentStep = 6;
    updateStepUI();
    return;
  }

  if (currentStep === 6) {
    // é€²å…¥ Step7 å°±å…ˆè©¦ç®—ä¸€æ¬¡
    currentStep = 7;
    calculatePrice();
    updateStepUI();
    return;
  }

  if (currentStep === 7) {
    // æœ€çµ‚é€å‡º
    const payload = buildPayload();
    alert("å°‡é€å‡ºé ç´„éœ€æ±‚ï¼ˆç¤ºç¯„ï¼‰ï¼š\n" + JSON.stringify(payload, null, 2));

    // ä¹‹å¾Œä½ æ¥å›å¾Œç«¯å¯æ‰“é–‹é€™æ®µ
    /*
    fetch("/api/booking", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "createBooking", data: payload }),
    })
    .then(r => r.json())
    .then(res => {
      alert("é ç´„å·²é€å‡º");
    })
    .catch(err => {
      alert("é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      console.warn(err);
    });
    */
    return;
  }
});

prevBtn.addEventListener("click", () => {
  if (currentStep <= 0) return;

  // èˆŠå®¢å¾ Step1 å¾€å›ä¸è¦å› Step0
  if (!isNewCustomer && currentStep === 1) return;

  currentStep--;
  updateStepUI();
});

/* ============================================================
   åˆå§‹åŒ–
============================================================ */
updateStepUI();
initBooking();
</script>

<!-- ç¬¬3/3æ®µï¼šJSï¼ˆä¸‹åŠï¼‰è²¼åœ¨é€™è£¡ -->
<script>
/* ============================================================
   æ—¥æœŸå·¥å…·
============================================================ */
function formatDateKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

function parseDateStr(str) {
  if (!str) return null;
  const [y, m, d] = str.split("-").map(Number);
  return new Date(y, m - 1, d);
}

function getDateRangeArray(start, end) {
  const arr = [];
  let cur = new Date(start);
  while (cur <= end) {
    arr.push(new Date(cur));
    cur.setDate(cur.getDate() + 1);
  }
  return arr;
}

function getWeekdayName(d) {
  return ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][d.getDay()];
}

/* ============================================================
   schedule helpersï¼ˆæ¯æ¬¡åˆ°è¨ª minutesï¼‰
============================================================ */
function ensureDayObj(dateKey) {
  if (!schedule[dateKey]) schedule[dateKey] = {};
}

function setVisit(dateKey, slotId, minutes) {
  ensureDayObj(dateKey);
  schedule[dateKey][slotId] = { minutes: Number(minutes || defaultMinutes || 30) };
}

function removeVisit(dateKey, slotId) {
  if (!schedule[dateKey]) return;
  delete schedule[dateKey][slotId];
  if (Object.keys(schedule[dateKey]).length === 0) delete schedule[dateKey];
}

function applyTemplateToSchedule(templateId) {
  schedule = {};
  if (!startDate || !endDate) return;

  const dates = getDateRangeArray(startDate, endDate);

  dates.forEach(d => {
    const key = formatDateKey(d);

    if (templateId === "daily1-evening") {
      setVisit(key, "EVENING");
    } else if (templateId === "daily2-morning-evening") {
      setVisit(key, "MORNING");
      setVisit(key, "EVENING");
    } else if (templateId === "daily3-morning-afternoon-evening") {
      setVisit(key, "MORNING");
      setVisit(key, "AFTERNOON");
      setVisit(key, "EVENING");
    } else if (templateId === "custom-empty") {
      // ç©ºç™½
    }
  });
}

/* ============================================================
   Step4ï¼šæ¸²æŸ“æ¯æ—¥æ™‚æ®µ UIï¼ˆå‹¾é¸å¾Œå¯é¸åˆ†é˜ï¼‰
============================================================ */
function renderDayList() {
  if (!startDate || !endDate) return;

  dayList.innerHTML = "";
  const dates = getDateRangeArray(startDate, endDate);

  dates.forEach(d => {
    const key = formatDateKey(d);
    if (!schedule[key]) schedule[key] = {}; // å…ˆç¢ºä¿æ—¥æœŸå­˜åœ¨ï¼ˆä¾¿æ–¼ renderï¼‰

    const row = document.createElement("div");
    row.className = "day-row";

    const header = document.createElement("div");
    header.className = "day-row-header";
    header.innerHTML = `
      <span>${d.getMonth() + 1}/${d.getDate()}ï¼ˆ${getWeekdayName(d)}ï¼‰</span>
      <span>é»é¸å‹¾é¸ / å–æ¶ˆ</span>
    `;
    row.appendChild(header);

    const chipsWrapper = document.createElement("div");
    chipsWrapper.className = "slot-chips";

    SLOT_DEFS.forEach(slot => {
      const selected = !!schedule[key][slot.id];
      const minutes = selected
        ? Number(schedule[key][slot.id].minutes || defaultMinutes || 30)
        : Number(defaultMinutes || 30);

      const chip = document.createElement("div");
      chip.className = "slot-chip" + (selected ? " active" : "");
      chip.dataset.date = key;
      chip.dataset.slot = slot.id;

      chip.innerHTML = `
        <span>${slot.label} <small>${slot.range}</small></span>
        ${selected ? `
          <select class="minute-select" data-date="${key}" data-slot="${slot.id}">
            ${MINUTE_OPTIONS.map(m => `<option value="${m}" ${m === minutes ? "selected" : ""}>${m}åˆ†</option>`).join("")}
          </select>
        ` : ``}
      `;

      // é» chip åˆ‡æ›é¸å–ï¼ˆé» select ä¸è¦è§¸ç™¼å–æ¶ˆï¼‰
chip.addEventListener("click", (e) => {
  if (e.target.closest && e.target.closest(".minute-select")) return;
  toggleVisit(key, slot.id);
});

      chipsWrapper.appendChild(chip);
    });

    row.appendChild(chipsWrapper);
    dayList.appendChild(row);
  });

  // minute select change
  dayList.querySelectorAll(".minute-select").forEach(sel => {
    sel.addEventListener("change", () => {
      const dateKey = sel.dataset.date;
      const slotId = sel.dataset.slot;
      const m = Number(sel.value);

      if (schedule[dateKey] && schedule[dateKey][slotId]) {
        schedule[dateKey][slotId].minutes = m;
      }

      updateStep4VisitSummary();
    });
  });

  updateStep4VisitSummary();
}

function toggleVisit(dateKey, slotId) {
  const selected = !!(schedule[dateKey] && schedule[dateKey][slotId]);

  if (selected) removeVisit(dateKey, slotId);
  else setVisit(dateKey, slotId, defaultMinutes || 30);

  renderDayList(); // é‡ç•«ä»¥é¡¯ç¤º/ç§»é™¤ minute select
}

function updateStep4VisitSummary() {
  const visits = buildVisitArray();
  const total = visits.length;

  if (total === 0) {
    step4VisitSummary.textContent = "å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚";
    return;
  }

  let countMorning = 0, countAfternoon = 0, countEvening = 0, countLate = 0;
  const minuteCount = {};

  visits.forEach(v => {
    if (v.slot === "MORNING") countMorning++;
    if (v.slot === "AFTERNOON") countAfternoon++;
    if (v.slot === "EVENING") countEvening++;
    if (v.slot === "LATE") countLate++;

    minuteCount[v.minutes] = (minuteCount[v.minutes] || 0) + 1;
  });

  const minuteText = Object.keys(minuteCount)
    .sort((a,b) => Number(a)-Number(b))
    .map(m => `${m}åˆ†Ã—${minuteCount[m]}`)
    .join("ã€");

  step4VisitSummary.textContent =
    `å…± ${total} æ¬¡ï¼šæ—©${countMorning}ã€åˆ${countAfternoon}ã€æ™š${countEvening}ã€æ·±å¤œ${countLate} ï½œ åˆ†é˜ï¼š${minuteText}`;
}

/* ============================================================
   Visits & Payload
============================================================ */
function buildVisitArray() {
  const visits = [];

  Object.entries(schedule).forEach(([dateKey, slotsObj]) => {
    Object.entries(slotsObj).forEach(([slotId, info]) => {
      const minutes = Number(info.minutes || defaultMinutes || 30);
      const unitPrice = PRICE_TABLE[serviceType]?.[minutes] ?? 0;

      visits.push({ date: dateKey, slot: slotId, minutes, unitPrice });
    });
  });

  // æ’åºè®“è¼¸å‡ºç©©å®š
  visits.sort((a,b) => (a.date + a.slot).localeCompare(b.date + b.slot));
  return visits;
}

function buildPayload() {
  return {
    familyId,
    isNewCustomer,

    startDate: startInput.value,
    endDate: endInput.value,

    serviceType,
    defaultMinutes,

    farePerVisit,

    dogCount: dogCountValue,
    catCount: catCountValue,
    dogExtraPerVisit: dogExtraFeePerVisit,
    catRequireEval,

    addons,

    noteText: (noteText?.value || "").trim(),

    visits: buildVisitArray(),

    depositText,
    agreedToNotice: isNewCustomer ? !!agreeNotice.checked : true,
  };
}

/* ============================================================
   è©¦ç®—å ±åƒ¹ï¼ˆStep7 é€²å…¥æ™‚æœƒå‘¼å«ï¼‰
============================================================ */
function calculatePrice() {
  const visits = buildVisitArray();
  const visitCount = visits.length;

  const serviceTotal = visits.reduce((sum, v) => sum + v.unitPrice, 0);
  const fareTotal = farePerVisit * visitCount;
  const dogExtraTotal = dogExtraFeePerVisit * visitCount;

  const addonPerVisit = Object.values(addons).reduce((s, p) => s + p, 0);
  const addonTotal = addonPerVisit * visitCount;

  const total = serviceTotal + fareTotal + dogExtraTotal + addonTotal;

  // UI
  quoteRange.textContent = `${startInput.value} ï½ ${endInput.value}`;
  quoteServiceType.textContent = `${serviceType}`;
  quoteTotal.textContent = `${total.toLocaleString("zh-TW")} å…ƒ`;

  const days = (startDate && endDate) ? getDateRangeArray(startDate, endDate).length : 0;
  quoteDateRangeText.textContent = `${days} å¤©`;
  quoteVisitCount.textContent = `${visitCount} æ¬¡`;

  // åˆ†é˜åˆ†ä½ˆ
  const minuteCount = {};
  visits.forEach(v => minuteCount[v.minutes] = (minuteCount[v.minutes] || 0) + 1);
  const minuteText = Object.keys(minuteCount).length
    ? Object.keys(minuteCount).sort((a,b)=>Number(a)-Number(b)).map(m => `${m}åˆ†Ã—${minuteCount[m]}`).join("ã€")
    : "-";
  quoteMinuteDist.textContent = minuteText;

  // æœå‹™è²»æ˜ç´°ï¼ˆæŒ‰åˆ†é˜å½™ç¸½ï¼‰
  const breakdown = {};
  visits.forEach(v => {
    const k = String(v.minutes);
    if (!breakdown[k]) breakdown[k] = { count: 0, unit: v.unitPrice };
    breakdown[k].count += 1;
  });

  const serviceText = Object.keys(breakdown).length
    ? Object.entries(breakdown)
        .sort((a,b)=>Number(a[0])-Number(b[0]))
        .map(([m, obj]) => `${m}åˆ† ${obj.unit}Ã—${obj.count}=${obj.unit*obj.count}`)
        .join("ï¼›")
    : "-";
  quoteServiceFee.textContent = serviceText;

  quoteFareText.textContent = `${farePerVisit} Ã— ${visitCount} = ${fareTotal}`;

  quoteMultiPet.textContent =
    `ç‹—ï¼š+${dogExtraFeePerVisit} Ã— ${visitCount} = ${dogExtraTotal}` +
    (catRequireEval ? "ï½œè²“ï¼šç¬¬ä¸‰éš»éœ€ Pinyu è©•ä¼°" : "");

  quoteAddons.textContent = addonPerVisit
    ? `æ¯æ¬¡ +${addonPerVisit}ï¼Œå…± ${addonTotal}`
    : "ç„¡";

  quoteSubtotal.textContent = `è©¦ç®—ç¸½é¡ï¼š${total.toLocaleString("zh-TW")} å…ƒ`;
  quoteDepositText.textContent = depositText;

  quoteDebugBox.textContent =
    "DEBUGï¼ˆé€å‡º payloadï¼‰\n" +
    JSON.stringify(buildPayload(), null, 2);
}
</script>

</body>
</html>
