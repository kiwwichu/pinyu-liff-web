<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é ç´„è¨­å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #333;
    }
    .page {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }
    header {
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid #e0ebf7;
      color: #144a7e;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px 0;
      font-size: 12px;
      color: #7a8baa;
    }
    .step-dot {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .step-circle {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #d1e4ff;
    }
    .step-dot.active .step-circle {
      background: #48a2e8;
    }
    .step-dot.active span {
      color: #225f9f;
      font-weight: 600;
    }

    .content {
      padding: 12px 16px 16px;
      flex: 1;
      overflow-y: auto;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #123456;
    }
    .section-sub {
      font-size: 12px;
      color: #7a8baa;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .field-group {
      margin-bottom: 16px;
    }
    .field-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #4b5e7c;
    }
    .text-input, .date-input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cfe3fb;
      font-size: 13px;
      outline: none;
      box-sizing: border-box;
    }
    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-row input[type="date"] {
      flex: 1;
    }
    .date-row span {
      font-size: 12px;
      color: #7a8baa;
    }

    .pill {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f3f7fc;
      font-size: 11px;
      color: #4b5e7c;
    }

    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .option-card {
      border-radius: 14px;
      border: 1px solid #d1e4ff;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.15s ease;
    }
    .option-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .option-title {
      font-weight: 600;
      color: #123456;
    }
    .option-desc {
      font-size: 11px;
      color: #7a8baa;
    }
    .option-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e4f2ff;
      color: #225f9f;
    }
    .option-card.active {
      border-color: #48a2e8;
      background: #f3f8ff;
      box-shadow: 0 3px 10px rgba(72, 162, 232, 0.18);
    }

    .day-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .day-row {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #e0ebf7;
      background: #f8fbff;
    }
    .day-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
      color: #123456;
    }
    .day-row-header span:last-child {
      font-size: 11px;
      color: #7a8baa;
    }
    .slot-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .slot-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #cfe3fb;
      font-size: 11px;
      cursor: pointer;
      background: #ffffff;
      color: #4b5e7c;
      white-space: nowrap;
    }
    .slot-chip small {
      font-size: 10px;
      color: #9ba8bd;
    }
    .slot-chip.active {
      border-color: #48a2e8;
      background: #e4f2ff;
      color: #225f9f;
    }

    .summary-box {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #cfe3fb;
      background: #f5f9ff;
      font-size: 12px;
      color: #4b5e7c;
      line-height: 1.5;
    }

    .quote-card {
      border-radius: 16px;
      border: 1px solid #e0ebf7;
      background: #ffffff;
      padding: 12px 12px 10px;
      font-size: 13px;
    }
    .quote-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .quote-range {
      font-weight: 600;
      color: #123456;
    }
    .quote-service-type {
      font-size: 12px;
      color: #7a8baa;
    }
    .quote-total {
      font-size: 16px;
      font-weight: 700;
      color: #e28c27;
    }
    .quote-section {
      border-top: 1px dashed #e0ebf7;
      padding-top: 8px;
      margin-top: 8px;
    }
    .quote-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .quote-line {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
      font-size: 12px;
    }
    .quote-line span:first-child {
      color: #7a8baa;
    }
    .quote-subtotal {
      margin-top: 4px;
      text-align: right;
      font-size: 13px;
      font-weight: 600;
      color: #123456;
    }
    .highlight-text {
      color: #e28c27;
      font-weight: 600;
    }

    .bottom-bar {
      padding: 10px 16px 18px;
      border-top: 1px solid #e0ebf7;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .primary-btn,
    .secondary-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .primary-btn {
      background: #48a2e8;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(72, 162, 232, 0.25);
    }
    .primary-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    .secondary-btn {
      background: #f3f7fc;
      color: #4b5e7c;
    }
    .sub-text {
      font-size: 11px;
      color: #7a8baa;
      text-align: center;
      line-height: 1.5;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="page">
    <header>è¨­å®šé ç´„éœ€æ±‚</header>

    <!-- æ­¥é©ŸæŒ‡ç¤º -->
    <div class="step-indicator">
      <div class="step-dot" data-step="1">
        <div class="step-circle"></div><span>åœ°å€ / è»Šé¦¬è²»</span>
      </div>
      <div class="step-dot" data-step="2">
        <div class="step-circle"></div><span>æœŸé–“èˆ‡é »ç‡</span>
      </div>
      <div class="step-dot" data-step="3">
        <div class="step-circle"></div><span>æ¯æ—¥æ™‚æ®µ</span>
      </div>
      <div class="step-dot" data-step="4">
        <div class="step-circle"></div><span>è©¦ç®—å ±åƒ¹</span>
      </div>
    </div>

    <div class="content">
      <!-- STEP 1ï¼šåœ°å€ / è»Šé¦¬è²» -->
      <div class="step-panel" id="step1">
        <div class="section-title">ç¢ºèªæœå‹™åœ°å€èˆ‡è»Šé¦¬è²»</div>
        <div class="section-sub" id="regionHint">
          è«‹å…ˆç¢ºèªæ­¤æ¬¡æœå‹™çš„åœ°é»ï¼Œç³»çµ±æœƒä¾è·é›¢è©¦ç®—æ¯æ¬¡åˆ°åºœçš„è»Šé¦¬è²»ã€‚
        </div>

        <!-- èˆŠå®¢ç”¨ï¼šåªé¡¯ç¤ºæ‘˜è¦ -->
        <div class="summary-box hidden" id="existingCustomerBox">
          <div id="existingCustomerText"></div>
        </div>

        <!-- æ–°å®¢ç”¨ï¼šæ‰‹å‹•è¼¸å…¥åœ°å€ï¼‹è©¦ç®— -->
        <div id="newCustomerForm">
          <div class="field-group">
            <div class="field-label">æœå‹™åœ°å€ï¼ˆç¸£å¸‚ã€å€èˆ‡è¡—é“é–€ç‰Œï¼‰</div>
            <input type="text" id="serviceAddress" class="text-input" placeholder="ä¾‹ï¼šå°åŒ—å¸‚å¤§åŒå€â—‹â—‹è·¯123è™Ÿ">
          </div>
          <button class="secondary-btn" id="calcFareBtn">è©¦ç®—è»Šé¦¬è²»</button>
          <div class="summary-box" id="fareSummaryBox">
            å°šæœªè©¦ç®—è»Šé¦¬è²»ã€‚
          </div>
        </div>
      </div>

      <!-- STEP 2ï¼šæœŸé–“èˆ‡é è¨­é »ç‡ -->
      <div class="step-panel hidden" id="step2">
        <div class="section-title">é¸æ“‡æœå‹™æœŸé–“èˆ‡é »ç‡</div>
        <div class="section-sub">
          å…ˆè¨­å®šæ­¤æ¬¡ç…§é¡§çš„æ—¥æœŸå€é–“èˆ‡å¤§è‡´é »ç‡ï¼Œä¸‹ä¸€æ­¥å¯ä»¥å†é‡å°å€‹åˆ¥æ—¥æœŸå¾®èª¿æ™‚æ®µã€‚
        </div>

        <div class="field-group">
          <div class="field-label">æœå‹™æ—¥æœŸå€é–“</div>
          <div class="date-row">
            <input type="date" id="startDate" class="date-input">
            <span>è‡³</span>
            <input type="date" id="endDate" class="date-input">
          </div>
        </div>

        <div class="field-group">
          <div class="field-label">é è¨­é »ç‡</div>
          <div class="options-grid">
            <div class="option-card" data-template="daily1-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 1 æ¬¡ï¼ˆé è¨­æ™šä¸Šï¼‰</div>
                <div class="option-desc">æ•´æ®µæœŸé–“æ¯å¤© 1 æ¬¡ï¼Œåˆ°è¨ªæ™‚é–“é è¨­ç‚ºæ™šä¸Š 18:00â€“21:00ã€‚</div>
              </div>
              <div class="option-tag">ä¸€èˆ¬å‡ºéŠ</div>
            </div>

            <div class="option-card" data-template="daily2-morning-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 2 æ¬¡ï¼ˆæ—©ï¼‹æ™šï¼‰</div>
                <div class="option-desc">æ•´æ®µæœŸé–“æ¯å¤©æ—©ä¸Š 1 æ¬¡ï¼‹æ™šä¸Š 1 æ¬¡ã€‚</div>
              </div>
              <div class="option-tag">æœ€å¸¸è¦‹</div>
            </div>

            <div class="option-card" data-template="daily3-morning-afternoon-evening">
              <div class="option-main">
                <div class="option-title">æ¯æ—¥ 3 æ¬¡ï¼ˆæ—©ï¼‹åˆï¼‹æ™šï¼‰</div>
                <div class="option-desc">æ•´æ®µæœŸé–“æ—©ä¸Šã€ä¸‹åˆã€æ™šä¸Šå„ 1 æ¬¡ã€‚</div>
              </div>
              <div class="option-tag">éœ€å¯†é›†ç…§é¡§</div>
            </div>

            <div class="option-card" data-template="custom-empty">
              <div class="option-main">
                <div class="option-title">å®Œå…¨è‡ªè¨‚</div>
                <div class="option-desc">ä¸‹ä¸€æ­¥æœƒé¡¯ç¤ºæ¯ä¸€å¤©ï¼Œæ‚¨å¯ä»¥è‡ªç”±å‹¾é¸æ—© / åˆ / æ™š / æ·±å¤œã€‚</div>
              </div>
              <div class="option-tag">é ­å°¾è¼ƒè¤‡é›œ</div>
            </div>
          </div>
        </div>

        <div class="summary-box" id="step2Summary">
          å°šæœªé¸æ“‡æœŸé–“èˆ‡é »ç‡ã€‚
        </div>
      </div>

      <!-- STEP 3ï¼šæ¯æ—¥æ™‚æ®µå¾®èª¿ -->
      <div class="step-panel hidden" id="step3">
        <div class="section-title">èª¿æ•´æ¯æ—¥åˆ°è¨ªæ™‚æ®µ</div>
        <div class="section-sub">
          å·²ä¾ç…§æ‚¨é¸æ“‡çš„é »ç‡å¥—ç”¨é è¨­æ’ç¨‹ï¼Œå¦‚ä¸éœ€è¦çš„æ™‚æ®µå¯ä»¥å–æ¶ˆå‹¾é¸ã€‚<br>
          ç¯„åœï¼šæ—©ä¸Š 09:00â€“12:00ã€ä¸‹åˆ 13:00â€“17:00ã€æ™šä¸Š 18:00â€“21:00ã€æ·±å¤œ 22:00â€“23:00ã€‚
        </div>

        <div class="day-list" id="dayList"></div>

        <div class="summary-box" id="step3Summary">
          å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚
        </div>
      </div>

      <!-- STEP 4ï¼šè©¦ç®—å ±åƒ¹ -->
      <div class="step-panel hidden" id="step4">
        <div class="section-title">è©¦ç®—æœ¬æ¬¡é ç´„é‡‘é¡</div>
        <div class="section-sub">
          ä»¥ä¸‹ç‚ºç³»çµ±ä¾ç…§æ‚¨é¸æ“‡çš„æ—¥æœŸèˆ‡æ™‚æ®µè©¦ç®—ä¹‹é‡‘é¡ï¼Œå¯¦éš›æœå‹™æ™‚é–“èˆ‡é‡‘é¡ä»éœ€ç”± Pinyu æœ€çµ‚ç¢ºèªå”· ğŸ’›
        </div>

        <div class="quote-card">
          <div class="quote-header">
            <div>
              <div class="quote-range" id="quoteRange"></div>
              <div class="quote-service-type" id="quoteServiceType"></div>
            </div>
            <div class="quote-total" id="quoteTotal"></div>
          </div>

          <div class="quote-section">
            <div class="quote-section-title">1. æœå‹™é …ç›®</div>
            <div class="quote-line">
              <span>æœå‹™æ—¥æœŸ</span>
              <span id="quoteDateRangeText"></span>
            </div>
            <div class="quote-line">
              <span>æ™‚æ•¸</span>
              <span id="quoteDuration"></span>
            </div>
            <div class="quote-line">
              <span>æœå‹™æ¬¡æ•¸</span>
              <span id="quoteVisitCount"></span>
            </div>
            <div class="quote-line">
              <span>æœå‹™å–®åƒ¹</span>
              <span id="quoteUnitPriceText"></span>
            </div>
            <div class="quote-line">
              <span>è»Šé¦¬è²»</span>
              <span id="quoteFareText"></span>
            </div>
            <div class="quote-subtotal" id="quoteSubtotal"></div>
          </div>

          <div class="quote-section">
            <div class="quote-line">
              <span>è¨‚é‡‘</span>
              <span id="quoteDepositText" class="highlight-text">å…è¨‚é‡‘ï¼ˆå¸¸å®¢ï¼‰</span>
            </div>
            <div class="quote-line">
              <span>å‚™è¨»</span>
              <span>æ­¤ç‚ºç³»çµ±è©¦ç®—é‡‘é¡ï¼Œå¯¦éš›é‡‘é¡èˆ‡æ’ç¨‹ä»ä»¥ Pinyu æœ€çµ‚ç¢ºèªç‚ºä¸»å”· ğŸ’›</span>
            </div>
          </div>
        </div>

        <div class="summary-box" id="quoteDebugBox">
          ï¼ˆé–‹ç™¼ç”¨ï¼‰é€å‡ºæ™‚å°‡ä¸€ä½µå‚³é€å®Œæ•´æ—¥æœŸèˆ‡æ™‚æ®µæ˜ç´°ã€‚
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨æŒ‰éˆ• -->
    <div class="bottom-bar">
      <button class="secondary-btn hidden" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
      <button class="primary-btn" id="nextBtn">ä¸‹ä¸€æ­¥</button>
      <div class="sub-text" id="hintText">
        æœƒå…ˆå»ºç«‹é ç´„éœ€æ±‚ï¼Œä¿å§†ç¢ºèªå¾Œå†èˆ‡æ‚¨æ•²å®šå¯¦éš›æ™‚é–“èˆ‡é‡‘é¡ ğŸ¾
      </div>
    </div>
  </div>

  <script>
    // ===== ä½ ä¹‹å¾Œå¯ä»¥æ”¹æˆå¾ initBooking å¸¶å…¥ =====
    const WEB_APP_URL = 'https://script.google.com/macros/s/XXXXX/exec'; // æ”¹æˆä½ çš„
    const SERVICE_TYPE_LABEL = 'åˆ°åºœç…§é¡§';
    const SERVICE_DURATION_LABEL = '30 åˆ†';
    const SERVICE_UNIT_PRICE = 350; // å–®æ¬¡æœå‹™è²»
    let depositText = 'å…è¨‚é‡‘ï¼ˆå¸¸å®¢ï¼‰';

    // ===== æ™‚æ®µå®šç¾© =====
    const SLOT_DEFS = [
      { id: 'MORNING',   label: 'æ—©ä¸Š', range: '09:00â€“12:00' },
      { id: 'AFTERNOON', label: 'ä¸‹åˆ', range: '13:00â€“17:00' },
      { id: 'EVENING',   label: 'æ™šä¸Š', range: '18:00â€“21:00' },
      { id: 'LATE',      label: 'æ·±å¤œ', range: '22:00â€“23:00' }
    ];

    let currentStep = 1;

    // å¾å¾Œç«¯ä¾†çš„è³‡è¨Š
    let isNewCustomer = true;       // å…ˆé è¨­æ–°å®¢ï¼Œç­‰ initBooking å›ä¾†å†æ”¹
    let farePerVisit = 0;           // æ¯æ¬¡è»Šé¦¬è²»
    let existingAddress = '';
    let ownerName = '';
    let familyId = '';

    // æœŸé–“ / é »ç‡ / æ™‚æ®µ
    let startDate = null;
    let endDate = null;
    let selectedTemplate = null;
    // schedule: { 'YYYY-MM-DD': Set(['MORNING','EVENING',...]) }
    let schedule = {};

    // DOM å…ƒç´ 
    const stepPanels = {
      1: document.getElementById('step1'),
      2: document.getElementById('step2'),
      3: document.getElementById('step3'),
      4: document.getElementById('step4')
    };
    const stepDots = document.querySelectorAll('.step-dot');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const hintText = document.getElementById('hintText');

    // Step1
    const regionHint = document.getElementById('regionHint');
    const existingCustomerBox = document.getElementById('existingCustomerBox');
    const existingCustomerText = document.getElementById('existingCustomerText');
    const newCustomerForm = document.getElementById('newCustomerForm');
    const addressInput = document.getElementById('serviceAddress');
    const calcFareBtn = document.getElementById('calcFareBtn');
    const fareSummaryBox = document.getElementById('fareSummaryBox');

    // Step2
    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const optionCards = document.querySelectorAll('.option-card');
    const step2Summary = document.getElementById('step2Summary');

    // Step3
    const dayList = document.getElementById('dayList');
    const step3Summary = document.getElementById('step3Summary');

    // Step4
    const quoteRange = document.getElementById('quoteRange');
    const quoteServiceType = document.getElementById('quoteServiceType');
    const quoteTotal = document.getElementById('quoteTotal');
    const quoteDateRangeText = document.getElementById('quoteDateRangeText');
    const quoteDuration = document.getElementById('quoteDuration');
    const quoteVisitCount = document.getElementById('quoteVisitCount');
    const quoteUnitPriceText = document.getElementById('quoteUnitPriceText');
    const quoteFareText = document.getElementById('quoteFareText');
    const quoteSubtotal = document.getElementById('quoteSubtotal');
    const quoteDepositText = document.getElementById('quoteDepositText');
    const quoteDebugBox = document.getElementById('quoteDebugBox');

    // ===== å·¥å…·å‡½å¼ =====
    function formatDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function parseDateStr(str) {
      if (!str) return null;
      const [y, m, d] = str.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function getDateRangeArray(start, end) {
      const arr = [];
      let cur = new Date(start);
      while (cur <= end) {
        arr.push(new Date(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return arr;
    }

    function getWeekdayName(d) {
      const names = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      return names[d.getDay()];
    }

    function updateStepUI() {
      Object.values(stepPanels).forEach(p => p.classList.add('hidden'));
      stepPanels[currentStep].classList.remove('hidden');

      stepDots.forEach(dot => {
        const step = Number(dot.getAttribute('data-step'));
        dot.classList.toggle('active', step === currentStep);
      });

      if (currentStep === 1) {
        prevBtn.classList.add('hidden');
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
        hintText.textContent = 'å…ˆç¢ºèªæ­¤æ¬¡æœå‹™åœ°å€èˆ‡è»Šé¦¬è²»ï¼Œå†é€²å…¥æ—¥æœŸè¨­å®š ğŸ¾';
      } else if (currentStep === 2) {
        prevBtn.classList.remove('hidden');
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
        hintText.textContent = 'ä¹‹å¾Œé‚„å¯ä»¥é‡å°å€‹åˆ¥æ—¥æœŸèª¿æ•´æ™‚æ®µå”· ğŸ’›';
      } else if (currentStep === 3) {
        prevBtn.classList.remove('hidden');
        nextBtn.textContent = 'è©¦ç®—å ±åƒ¹';
        hintText.textContent = 'æœƒä¾æ‚¨å‹¾é¸çš„æ™‚æ®µè©¦ç®—æœå‹™æ¬¡æ•¸èˆ‡é‡‘é¡ã€‚';
      } else if (currentStep === 4) {
        prevBtn.classList.remove('hidden');
        nextBtn.textContent = 'é€å‡ºé ç´„éœ€æ±‚';
        hintText.textContent = 'é€å‡ºå¾Œæœƒå…ˆå»ºç«‹é ç´„éœ€æ±‚ï¼Œå¯¦éš›æ™‚é–“èˆ‡é‡‘é¡ä»ç”± Pinyu èˆ‡æ‚¨ç¢ºèª ğŸ¾';
      }
    }

    function updateStep2Summary() {
      if (!startDate || !endDate) {
        step2Summary.textContent = 'å°šæœªé¸æ“‡æœŸé–“èˆ‡é »ç‡ã€‚';
        return;
      }
      const days = getDateRangeArray(startDate, endDate).length;
      let freqText = 'å°šæœªé¸æ“‡é »ç‡';
      if (selectedTemplate === 'daily1-evening') freqText = 'æ¯æ—¥ 1 æ¬¡ï¼ˆæ™šä¸Šï¼‰';
      else if (selectedTemplate === 'daily2-morning-evening') freqText = 'æ¯æ—¥ 2 æ¬¡ï¼ˆæ—©ï¼‹æ™šï¼‰';
      else if (selectedTemplate === 'daily3-morning-afternoon-evening') freqText = 'æ¯æ—¥ 3 æ¬¡ï¼ˆæ—©ï¼‹åˆï¼‹æ™šï¼‰';
      else if (selectedTemplate === 'custom-empty') freqText = 'å®Œå…¨è‡ªè¨‚ï¼ˆä¸‹ä¸€æ­¥å‹¾é¸ï¼‰';

      step2Summary.textContent =
        `å·²é¸æ“‡æœŸé–“ï¼š${startInput.value} ï½ ${endInput.value}ï¼ˆå…± ${days} å¤©ï¼‰ï¼Œé è¨­é »ç‡ï¼š${freqText}ã€‚`;
    }

    function applyTemplateToSchedule(templateId) {
      schedule = {};
      if (!startDate || !endDate) return;
      const dates = getDateRangeArray(startDate, endDate);

      dates.forEach(d => {
        const key = formatDateKey(d);
        schedule[key] = new Set();

        if (templateId === 'daily1-evening') {
          schedule[key].add('EVENING');
        } else if (templateId === 'daily2-morning-evening') {
          schedule[key].add('MORNING');
          schedule[key].add('EVENING');
        } else if (templateId === 'daily3-morning-afternoon-evening') {
          schedule[key].add('MORNING');
          schedule[key].add('AFTERNOON');
          schedule[key].add('EVENING');
        } else if (templateId === 'custom-empty') {
          // ç©ºç™½ï¼Œç•™çµ¦ä½¿ç”¨è€…è‡ªå·±å‹¾
        }
      });
    }

    function renderDayList() {
      if (!startDate || !endDate) return;
      dayList.innerHTML = '';

      const dates = getDateRangeArray(startDate, endDate);

      dates.forEach(d => {
        const key = formatDateKey(d);
        if (!schedule[key]) schedule[key] = new Set();

        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const header = document.createElement('div');
        header.className = 'day-row-header';
        header.innerHTML = `
          <span>${d.getMonth() + 1}/${d.getDate()}ï¼ˆ${getWeekdayName(d)}ï¼‰</span>
          <span>é»é¸ä¸‹æ–¹æ™‚æ®µå¯å‹¾é¸ / å–æ¶ˆ</span>
        `;
        dayRow.appendChild(header);

        const chipsWrapper = document.createElement('div');
        chipsWrapper.className = 'slot-chips';

        SLOT_DEFS.forEach(slot => {
          const chip = document.createElement('div');
          chip.className = 'slot-chip';
          chip.setAttribute('data-date', key);
          chip.setAttribute('data-slot', slot.id);

          if (schedule[key].has(slot.id)) chip.classList.add('active');

          chip.innerHTML = `
            ${slot.label}
            <small>${slot.range}</small>
          `;

          chip.addEventListener('click', () => {
            const dateKey = chip.getAttribute('data-date');
            const slotId = chip.getAttribute('data-slot');
            const set = schedule[dateKey] || new Set();

            if (set.has(slotId)) {
              set.delete(slotId);
              chip.classList.remove('active');
            } else {
              set.add(slotId);
              chip.classList.add('active');
            }
            schedule[dateKey] = set;
            updateStep3Summary();
          });

          chipsWrapper.appendChild(chip);
        });

        dayRow.appendChild(chipsWrapper);
        dayList.appendChild(dayRow);
      });

      updateStep3Summary();
    }

    function updateStep3Summary() {
      let total = 0;
      let morning = 0, afternoon = 0, evening = 0, late = 0;

      Object.values(schedule).forEach(set => {
        set.forEach(slotId => {
          total++;
          if (slotId === 'MORNING') morning++;
          else if (slotId === 'AFTERNOON') afternoon++;
          else if (slotId === 'EVENING') evening++;
          else if (slotId === 'LATE') late++;
        });
      });

      if (total === 0) {
        step3Summary.textContent = 'å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚';
        return;
      }

      step3Summary.textContent =
        `æœ¬æ¬¡å…±é ç´„ ${total} æ¬¡åˆ°åºœæœå‹™ï¼šæ—©ä¸Š ${morning} æ¬¡ã€ä¸‹åˆ ${afternoon} æ¬¡ã€æ™šä¸Š ${evening} æ¬¡ã€æ·±å¤œ ${late} æ¬¡ã€‚`;
    }

    function buildPayload() {
      const visits = [];
      Object.entries(schedule).forEach(([dateKey, set]) => {
        if (set.size > 0) {
          visits.push({
            date: dateKey,
            slots: Array.from(set)
          });
        }
      });

      return {
        familyId,
        startDate: startInput.value,
        endDate: endInput.value,
        farePerVisit,
        serviceType: SERVICE_TYPE_LABEL,
        serviceDuration: SERVICE_DURATION_LABEL,
        unitPrice: SERVICE_UNIT_PRICE,
        visits
      };
    }

    function renderQuote() {
      const payload = buildPayload();
      const visitsCount = payload.visits.reduce((sum, v) => sum + v.slots.length, 0);
      const serviceSubtotal = SERVICE_UNIT_PRICE * visitsCount;
      const fareSubtotal = farePerVisit * visitsCount;
      const total = serviceSubtotal + fareSubtotal;

      quoteRange.textContent = `${payload.startDate}â€“${payload.endDate}`;
      quoteServiceType.textContent = SERVICE_TYPE_LABEL;
      quoteTotal.textContent = total.toLocaleString('zh-TW') + ' å…ƒ';

      const days = getDateRangeArray(startDate, endDate).length;
      quoteDateRangeText.textContent = `${payload.startDate}ï½${payload.endDate}ï¼ˆå…± ${days} å¤©ï¼‰`;
      quoteDuration.textContent = SERVICE_DURATION_LABEL;
      quoteVisitCount.textContent = `${visitsCount} æ¬¡`;
      quoteUnitPriceText.textContent = `${SERVICE_UNIT_PRICE} å…ƒï¼æ¬¡ Ã— ${visitsCount} æ¬¡`;
      quoteFareText.textContent = `${farePerVisit} å…ƒï¼æ¬¡ Ã— ${visitsCount} æ¬¡`;
      quoteSubtotal.textContent = `æœ¬æ¬¡é è¨‚é‡‘é¡è©¦ç®— ${total.toLocaleString('zh-TW')} å…ƒ`;
      quoteDepositText.textContent = depositText;

      quoteDebugBox.textContent = 'DEBUGï¼šé€å‡ºå…§å®¹\n' + JSON.stringify(payload, null, 2);
    }

    // ===== äº‹ä»¶ç¶å®š =====
    startInput.addEventListener('change', () => {
      startDate = parseDateStr(startInput.value);
      endDate = parseDateStr(endInput.value);
      if (startDate && endDate && endDate < startDate) {
        alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
        endInput.value = '';
        endDate = null;
      }
      updateStep2Summary();
    });

    endInput.addEventListener('change', () => {
      startDate = parseDateStr(startInput.value);
      endDate = parseDateStr(endInput.value);
      if (startDate && endDate && endDate < startDate) {
        alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
        endInput.value = '';
        endDate = null;
      }
      updateStep2Summary();
    });

    optionCards.forEach(card => {
      card.addEventListener('click', () => {
        optionCards.forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        selectedTemplate = card.getAttribute('data-template');
        updateStep2Summary();
      });
    });

    prevBtn.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentStep === 1) {
        if (isNewCustomer) {
          if (!farePerVisit || farePerVisit <= 0) {
            alert('è«‹å…ˆè©¦ç®—è»Šé¦¬è²»');
            return;
          }
        }
        currentStep = 2;
        updateStepUI();
      } else if (currentStep === 2) {
        startDate = parseDateStr(startInput.value);
        endDate = parseDateStr(endInput.value);
        if (!startDate || !endDate) {
          alert('è«‹å…ˆé¸æ“‡æœå‹™æœŸé–“');
          return;
        }
        if (!selectedTemplate) {
          alert('è«‹å…ˆé¸æ“‡é è¨­é »ç‡');
          return;
        }
        applyTemplateToSchedule(selectedTemplate);
        renderDayList();
        currentStep = 3;
        updateStepUI();
      } else if (currentStep === 3) {
        const payload = buildPayload();
        if (!payload.visits.length) {
          alert('å°šæœªé¸æ“‡ä»»ä½•æ™‚æ®µï¼Œè«‹è‡³å°‘å‹¾é¸ä¸€å€‹ã€‚');
          return;
        }
        renderQuote();
        currentStep = 4;
        updateStepUI();
      } else if (currentStep === 4) {
        const payload = buildPayload();
        alert('å°‡é€å‡ºä»¥ä¸‹é ç´„éœ€æ±‚ï¼š\n' + JSON.stringify(payload, null, 2));

        // ä¹‹å¾Œå¯ä»¥æ”¹æˆçœŸçš„é€åˆ° Apps Script
        /*
        fetch(WEB_APP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'createBooking',
            data: payload
          })
        }).then(r => r.json()).then(res => {
          // é¡¯ç¤ºæˆåŠŸç•«é¢æˆ–é—œé–‰ LIFF
        });
        */
      }
    });

    // è©¦ç®—è»Šé¦¬è²»ï¼ˆæ–°å®¢ï¼‰
    calcFareBtn.addEventListener('click', () => {
      const addr = addressInput.value.trim();
      if (!addr) {
        alert('è«‹å…ˆè¼¸å…¥æœå‹™åœ°å€');
        return;
      }
      fareSummaryBox.textContent = 'è©¦ç®—ä¸­â€¦è«‹ç¨å€™';

      fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'calcFare',
          address: addr
        })
      }).then(r => r.json()).then(data => {
        if (!data.ok) {
          fareSummaryBox.textContent = 'è©¦ç®—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æ”¹ç”¨æ–‡å­—å‚™è¨»å‘ŠçŸ¥ Pinyuã€‚';
          return;
        }
        farePerVisit = data.farePerVisit || 0;
        fareSummaryBox.textContent =
          `ä¾æ‚¨å¡«å¯«çš„åœ°å€è©¦ç®—ï¼šæ¯æ¬¡è»Šé¦¬è²»ç´„ ${farePerVisit} å…ƒï¼ˆåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ä»¥ Pinyu ç¢ºèªç‚ºä¸»ï¼‰ã€‚`;
      }).catch(() => {
        fareSummaryBox.textContent = 'è©¦ç®—å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      });
    });

    // ===== åˆå§‹åŒ–ï¼šå‘ Apps Script å• initBookingï¼ˆèˆŠå®¢/æ–°å®¢ & è»Šé¦¬è²»ï¼‰ =====
    function initBooking() {
      // å¦‚æœä½ æœ‰ LIFFï¼Œå¯ä»¥æ‹¿ liff.getContext().userId
      const mockUserId = 'Uxxxx'; // å…ˆæš«æ™‚å¯«æ­»

      fetch(WEB_APP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'initBooking',
          userId: mockUserId
        })
      }).then(r => r.json()).then(data => {
        if (!data.ok) return;

        isNewCustomer = data.isNewCustomer;
        farePerVisit = data.farePerVisit || 0;
        existingAddress = data.address || '';
        ownerName = data.ownerName || '';
        familyId = data.familyId || '';

        if (data.isRegular) {
          depositText = 'å…è¨‚é‡‘ï¼ˆå¸¸å®¢ï¼‰';
        } else {
          depositText = 'éœ€è¨‚é‡‘ï¼ˆå¯¦éš›é‡‘é¡ç”± Pinyu å‘ŠçŸ¥ï¼‰';
        }

        // UI åˆ‡æ›
        if (!isNewCustomer) {
          // èˆŠå®¢ï¼šç”¨å®¶åº­ä¸»æª”çš„è»Šé¦¬è²»ï¼Œä¸éœ€è¦å†å¡«åœ°å€
          newCustomerForm.classList.add('hidden');
          existingCustomerBox.classList.remove('hidden');
          existingCustomerText.textContent =
            `ç›®å‰ç™»è¨˜åœ°å€ï¼š${existingAddress || 'ï¼ˆæœªå¡«å¯«ï¼‰'}ï¼›æ¯æ¬¡è»Šé¦¬è²»ï¼š${farePerVisit} å…ƒã€‚è‹¥æœ‰è®Šæ›´åœ°å€ï¼Œå¯åœ¨å‚™è¨»ä¸­å‘ŠçŸ¥ Pinyuã€‚`;
          regionHint.textContent =
            'å·²ç‚ºå¸¸å®¢ï¼Œä»¥ä¸‹ç‚ºç›®å‰ç™»è¨˜çš„æœå‹™åœ°å€èˆ‡è»Šé¦¬è²»ã€‚å¦‚æœ‰ç•°å‹•å¯åœ¨å‚™è¨»èªªæ˜ã€‚';
        } else {
          // æ–°å®¢ï¼šéœ€è¦è¼¸å…¥åœ°å€ï¼‹è©¦ç®—
          newCustomerForm.classList.remove('hidden');
          existingCustomerBox.classList.add('hidden');
          regionHint.textContent =
            'æ–°å®¢æˆ¶é¦–æ¬¡é ç´„ï¼Œè«‹å…ˆå¡«å¯«æœå‹™åœ°å€ä¸¦è©¦ç®—è»Šé¦¬è²»ï¼Œå¯¦éš›é‡‘é¡ä»ä»¥ Pinyu ç¢ºèªç‚ºä¸»ã€‚';
        }

        quoteDepositText.textContent = depositText;
      }).catch(() => {
        // çœŸçš„æ›æ‰å°±ç•¶æ–°å®¢è™•ç†
        isNewCustomer = true;
      });
    }

    // åˆå§‹åŒ–
    updateStepUI();
    initBooking();
  </script>
</body>
</html>
