<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é ç´„æ™‚é–“è¨­å®š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #333;
    }
    .page {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #ffffff;
    }
    header {
      padding: 12px 16px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      border-bottom: 1px solid #e0ebf7;
      color: #144a7e;
    }

    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 10px 16px 0;
      font-size: 12px;
      color: #7a8baa;
    }
    .step-dot {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .step-circle {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #d1e4ff;
    }
    .step-dot.active .step-circle {
      background: #48a2e8;
    }
    .step-dot.active span {
      color: #225f9f;
      font-weight: 600;
    }

    .content {
      padding: 12px 16px 16px;
      flex: 1;
      overflow-y: auto;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #123456;
    }
    .section-sub {
      font-size: 12px;
      color: #7a8baa;
      margin-bottom: 12px;
    }

    .field-group {
      margin-bottom: 16px;
    }
    .field-label {
      font-size: 13px;
      margin-bottom: 4px;
      color: #4b5e7c;
    }
    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .date-row input[type="date"] {
      flex: 1;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #cfe3fb;
      font-size: 13px;
      outline: none;
    }
    .date-row span {
      font-size: 12px;
      color: #7a8baa;
    }

    .options-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .option-card {
      border-radius: 14px;
      border: 1px solid #d1e4ff;
      padding: 10px 12px;
      font-size: 13px;
      cursor: pointer;
      background: #ffffff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.15s ease;
    }
    .option-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .option-title {
      font-weight: 600;
      color: #123456;
    }
    .option-desc {
      font-size: 11px;
      color: #7a8baa;
    }
    .option-tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #e4f2ff;
      color: #225f9f;
    }
    .option-card.active {
      border-color: #48a2e8;
      background: #f3f8ff;
      box-shadow: 0 3px 10px rgba(72, 162, 232, 0.18);
    }

    .day-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .day-row {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #e0ebf7;
      background: #f8fbff;
    }
    .day-row-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 13px;
      color: #123456;
    }
    .day-row-header span:last-child {
      font-size: 11px;
      color: #7a8baa;
    }
    .slot-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .slot-chip {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #cfe3fb;
      font-size: 11px;
      cursor: pointer;
      background: #ffffff;
      color: #4b5e7c;
      white-space: nowrap;
    }
    .slot-chip small {
      font-size: 10px;
      color: #9ba8bd;
    }
    .slot-chip.active {
      border-color: #48a2e8;
      background: #e4f2ff;
      color: #225f9f;
    }

    .summary-box {
      margin-top: 12px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px dashed #cfe3fb;
      background: #f5f9ff;
      font-size: 12px;
      color: #4b5e7c;
    }

    .bottom-bar {
      padding: 10px 16px 18px;
      border-top: 1px solid #e0ebf7;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .primary-btn,
    .secondary-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    .primary-btn {
      background: #48a2e8;
      color: #ffffff;
      box-shadow: 0 4px 10px rgba(72, 162, 232, 0.25);
    }
    .primary-btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }
    .secondary-btn {
      background: #f3f7fc;
      color: #4b5e7c;
    }
    .sub-text {
      font-size: 11px;
      color: #7a8baa;
      text-align: center;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="page">
    <header>è¨­å®šé ç´„æœŸé–“èˆ‡æ™‚é–“</header>

    <div class="step-indicator">
      <div class="step-dot" data-step="1">
        <div class="step-circle"></div><span>æœŸé–“</span>
      </div>
      <div class="step-dot" data-step="2">
        <div class="step-circle"></div><span>é »ç‡</span>
      </div>
      <div class="step-dot" data-step="3">
        <div class="step-circle"></div><span>æ¯æ—¥æ™‚æ®µ</span>
      </div>
    </div>

    <div class="content">
      <!-- STEP 1ï¼šé¸æœŸé–“ -->
      <div class="step-panel" id="step1">
        <div class="section-title">é¸æ“‡æœå‹™æœŸé–“</div>
        <div class="section-sub">è«‹å…ˆé¸æ“‡æ­¤æ¬¡ç…§é¡§çš„é–‹å§‹èˆ‡çµæŸæ—¥æœŸï¼Œå¾ŒçºŒå¯å†ç´°èª¿æ¯å¤©çš„æ™‚æ®µã€‚</div>

        <div class="field-group">
          <div class="field-label">æœå‹™æ—¥æœŸå€é–“</div>
          <div class="date-row">
            <input type="date" id="startDate">
            <span>è‡³</span>
            <input type="date" id="endDate">
          </div>
        </div>

        <div class="summary-box" id="step1Summary">
          å°šæœªé¸æ“‡æœŸé–“ã€‚
        </div>
      </div>

      <!-- STEP 2ï¼šé¸é »ç‡ -->
      <div class="step-panel hidden" id="step2">
        <div class="section-title">é¸æ“‡é€™æ®µæœŸé–“çš„é è¨­é »ç‡</div>
        <div class="section-sub">ç³»çµ±æœƒå…ˆå¹«æ‚¨å¥—ç”¨ä¸€å€‹å¸¸è¦‹çš„æ’ç¨‹ï¼Œä¸‹ä¸€æ­¥å¯ä»¥é‡å°å€‹åˆ¥æ—¥æœŸå¾®èª¿ã€‚</div>

        <div class="options-grid">
          <div class="option-card" data-template="daily1-evening">
            <div class="option-main">
              <div class="option-title">æ¯æ—¥ 1 æ¬¡ï¼ˆé è¨­æ™šä¸Šï¼‰</div>
              <div class="option-desc">æ•´æ®µæœŸé–“æ¯å¤© 1 æ¬¡ï¼Œåˆ°è¨ªæ™‚é–“é è¨­ç‚ºæ™šä¸Š 18:00â€“21:00ã€‚</div>
            </div>
            <div class="option-tag">æ¨è–¦çµ¦ä¸€èˆ¬å‡ºéŠ</div>
          </div>

          <div class="option-card" data-template="daily2-morning-evening">
            <div class="option-main">
              <div class="option-title">æ¯æ—¥ 2 æ¬¡ï¼ˆæ—©ï¼‹æ™šï¼‰</div>
              <div class="option-desc">æ•´æ®µæœŸé–“æ¯å¤©æ—©ä¸Š 1 æ¬¡ï¼‹æ™šä¸Š 1 æ¬¡ã€‚</div>
            </div>
            <div class="option-tag">æœ€å¸¸è¦‹</div>
          </div>

          <div class="option-card" data-template="daily3-morning-afternoon-evening">
            <div class="option-main">
              <div class="option-title">æ¯æ—¥ 3 æ¬¡ï¼ˆæ—©ï¼‹åˆï¼‹æ™šï¼‰</div>
              <div class="option-desc">æ•´æ®µæœŸé–“æ—©ä¸Šã€ä¸‹åˆã€æ™šä¸Šå„ 1 æ¬¡ã€‚</div>
            </div>
            <div class="option-tag">éœ€è¦å¯†é›†ç…§é¡§æ™‚</div>
          </div>

          <div class="option-card" data-template="custom-empty">
            <div class="option-main">
              <div class="option-title">å®Œå…¨è‡ªè¨‚</div>
              <div class="option-desc">ä¸‹ä¸€æ­¥æœƒé¡¯ç¤ºæ¯ä¸€å¤©ï¼Œæ‚¨å¯ä»¥è‡ªç”±å‹¾é¸æ—© / åˆ / æ™š / æ·±å¤œã€‚</div>
            </div>
            <div class="option-tag">é ­å°¾ç‰¹åˆ¥è¤‡é›œæ™‚</div>
          </div>
        </div>
      </div>

      <!-- STEP 3ï¼šé€æ—¥å‹¾é¸æ™‚æ®µ -->
      <div class="step-panel hidden" id="step3">
        <div class="section-title">èª¿æ•´æ¯æ—¥åˆ°è¨ªæ™‚æ®µ</div>
        <div class="section-sub">
          å·²ä¾ç…§æ‚¨é¸æ“‡çš„é »ç‡å¥—ç”¨é è¨­æ’ç¨‹ï¼Œå¦‚ä¸éœ€è¦çš„æ™‚æ®µå¯ä»¥å–æ¶ˆå‹¾é¸ã€‚<br>
          ç¯„åœï¼šæ—©ä¸Š 09:00â€“12:00ã€ä¸‹åˆ 13:00â€“17:00ã€æ™šä¸Š 18:00â€“21:00ã€æ·±å¤œ 22:00â€“23:00ã€‚
        </div>

        <div class="day-list" id="dayList"></div>

        <div class="summary-box" id="step3Summary">
          å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚
        </div>
      </div>
    </div>

    <div class="bottom-bar">
      <button class="secondary-btn hidden" id="prevBtn">â† ä¸Šä¸€æ­¥</button>
      <button class="primary-btn" id="nextBtn">ä¸‹ä¸€æ­¥</button>
      <div class="sub-text" id="hintText">
        æœƒå…ˆå»ºç«‹é ç´„éœ€æ±‚ï¼Œä¿å§†ç¢ºèªå¾Œå†èˆ‡æ‚¨æ•²å®šå¯¦éš›æ™‚é–“èˆ‡é‡‘é¡ ğŸ¾
      </div>
    </div>
  </div>

  <script>
    // ===== æ™‚æ®µå®šç¾© =====
    const SLOT_DEFS = [
      { id: 'MORNING', label: 'æ—©ä¸Š', range: '09:00â€“12:00' },
      { id: 'AFTERNOON', label: 'ä¸‹åˆ', range: '13:00â€“17:00' },
      { id: 'EVENING', label: 'æ™šä¸Š', range: '18:00â€“21:00' },
      { id: 'LATE', label: 'æ·±å¤œ', range: '22:00â€“23:00' }
    ];

    let currentStep = 1;
    let startDate = null;
    let endDate = null;
    let selectedTemplate = null;

    // schedule: { 'YYYY-MM-DD': Set(['MORNING','EVENING',...]) }
    let schedule = {};

    const stepPanels = {
      1: document.getElementById('step1'),
      2: document.getElementById('step2'),
      3: document.getElementById('step3')
    };
    const stepDots = document.querySelectorAll('.step-dot');

    const startInput = document.getElementById('startDate');
    const endInput = document.getElementById('endDate');
    const step1Summary = document.getElementById('step1Summary');

    const optionCards = document.querySelectorAll('.option-card');

    const dayList = document.getElementById('dayList');
    const step3Summary = document.getElementById('step3Summary');

    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const hintText = document.getElementById('hintText');

    // ===== å·¥å…·å‡½å¼ =====
    function formatDateKey(d) {
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function parseDateStr(str) {
      if (!str) return null;
      const [y, m, d] = str.split('-').map(Number);
      return new Date(y, m - 1, d);
    }

    function getDateRangeArray(start, end) {
      const arr = [];
      let cur = new Date(start);
      while (cur <= end) {
        arr.push(new Date(cur));
        cur.setDate(cur.getDate() + 1);
      }
      return arr;
    }

    function getWeekdayName(d) {
      const names = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      return names[d.getDay()];
    }

    function updateStepUI() {
      Object.values(stepPanels).forEach(p => p.classList.add('hidden'));
      stepPanels[currentStep].classList.remove('hidden');

      stepDots.forEach(dot => {
        const step = Number(dot.getAttribute('data-step'));
        dot.classList.toggle('active', step === currentStep);
      });

      if (currentStep === 1) {
        prevBtn.classList.add('hidden');
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
      } else if (currentStep === 2) {
        prevBtn.classList.remove('hidden');
        nextBtn.textContent = 'ä¸‹ä¸€æ­¥';
      } else if (currentStep === 3) {
        prevBtn.classList.remove('hidden');
        nextBtn.textContent = 'é€å‡ºé ç´„éœ€æ±‚';
      }
    }

    function updateStep1Summary() {
      if (!startDate || !endDate) {
        step1Summary.textContent = 'å°šæœªé¸æ“‡æœŸé–“ã€‚';
        return;
      }
      const rangeDays = getDateRangeArray(startDate, endDate).length;
      step1Summary.textContent =
        `å·²é¸æ“‡æœŸé–“ï¼š${startInput.value} ï½ ${endInput.value}ï¼ˆå…± ${rangeDays} å¤©ï¼‰`;
    }

    function applyTemplateToSchedule(templateId) {
      schedule = {}; // å…ˆæ¸…ç©º
      if (!startDate || !endDate) return;
      const dates = getDateRangeArray(startDate, endDate);

      dates.forEach(d => {
        const key = formatDateKey(d);
        schedule[key] = new Set();

        if (templateId === 'daily1-evening') {
          schedule[key].add('EVENING');
        } else if (templateId === 'daily2-morning-evening') {
          schedule[key].add('MORNING');
          schedule[key].add('EVENING');
        } else if (templateId === 'daily3-morning-afternoon-evening') {
          schedule[key].add('MORNING');
          schedule[key].add('AFTERNOON');
          schedule[key].add('EVENING');
        } else if (templateId === 'custom-empty') {
          // å…¨ç©ºï¼Œç”±ä½¿ç”¨è€…è‡ªå·±å‹¾
        }
      });
    }

    function renderDayList() {
      if (!startDate || !endDate) return;
      dayList.innerHTML = '';

      const dates = getDateRangeArray(startDate, endDate);

      dates.forEach(d => {
        const key = formatDateKey(d);
        if (!schedule[key]) schedule[key] = new Set();

        const dayRow = document.createElement('div');
        dayRow.className = 'day-row';

        const header = document.createElement('div');
        header.className = 'day-row-header';
        header.innerHTML = `
          <span>${d.getMonth() + 1}/${d.getDate()}ï¼ˆ${getWeekdayName(d)}ï¼‰</span>
          <span>é»é¸ä¸‹æ–¹æ™‚æ®µå¯å‹¾é¸ / å–æ¶ˆ</span>
        `;
        dayRow.appendChild(header);

        const chipsWrapper = document.createElement('div');
        chipsWrapper.className = 'slot-chips';

        SLOT_DEFS.forEach(slot => {
          const chip = document.createElement('div');
          chip.className = 'slot-chip';
          chip.setAttribute('data-date', key);
          chip.setAttribute('data-slot', slot.id);

          if (schedule[key].has(slot.id)) {
            chip.classList.add('active');
          }

          chip.innerHTML = `
            ${slot.label}
            <small>${slot.range}</small>
          `;

          chip.addEventListener('click', () => {
            const dateKey = chip.getAttribute('data-date');
            const slotId = chip.getAttribute('data-slot');
            const set = schedule[dateKey] || new Set();

            if (set.has(slotId)) {
              set.delete(slotId);
              chip.classList.remove('active');
            } else {
              set.add(slotId);
              chip.classList.add('active');
            }
            schedule[dateKey] = set;
            updateStep3Summary();
          });

          chipsWrapper.appendChild(chip);
        });

        dayRow.appendChild(chipsWrapper);
        dayList.appendChild(dayRow);
      });

      updateStep3Summary();
    }

    function updateStep3Summary() {
      let total = 0;
      let morning = 0, afternoon = 0, evening = 0, late = 0;

      Object.values(schedule).forEach(set => {
        set.forEach(slotId => {
          total++;
          if (slotId === 'MORNING') morning++;
          else if (slotId === 'AFTERNOON') afternoon++;
          else if (slotId === 'EVENING') evening++;
          else if (slotId === 'LATE') late++;
        });
      });

      if (total === 0) {
        step3Summary.textContent = 'å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µã€‚';
        return;
      }

      step3Summary.textContent =
        `æœ¬æ¬¡å…±é ç´„ ${total} æ¬¡åˆ°åºœæœå‹™ï¼šæ—©ä¸Š ${morning} æ¬¡ã€ä¸‹åˆ ${afternoon} æ¬¡ã€æ™šä¸Š ${evening} æ¬¡ã€æ·±å¤œ ${late} æ¬¡ã€‚`;
    }

    // ===== äº‹ä»¶ç¶å®š =====
    startInput.addEventListener('change', () => {
      startDate = parseDateStr(startInput.value);
      endDate = parseDateStr(endInput.value);
      if (startDate && endDate && endDate < startDate) {
        alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
        endInput.value = '';
        endDate = null;
      }
      updateStep1Summary();
    });

    endInput.addEventListener('change', () => {
      startDate = parseDateStr(startInput.value);
      endDate = parseDateStr(endInput.value);
      if (startDate && endDate && endDate < startDate) {
        alert('çµæŸæ—¥æœŸä¸å¯æ—©æ–¼é–‹å§‹æ—¥æœŸ');
        endInput.value = '';
        endDate = null;
      }
      updateStep1Summary();
    });

    optionCards.forEach(card => {
      card.addEventListener('click', () => {
        optionCards.forEach(c => c.classList.remove('active'));
        card.classList.add('active');
        selectedTemplate = card.getAttribute('data-template');
      });
    });

    prevBtn.addEventListener('click', () => {
      if (currentStep > 1) {
        currentStep--;
        updateStepUI();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentStep === 1) {
        startDate = parseDateStr(startInput.value);
        endDate = parseDateStr(endInput.value);
        if (!startDate || !endDate) {
          alert('è«‹å…ˆé¸æ“‡æœå‹™æœŸé–“');
          return;
        }
        currentStep = 2;
        updateStepUI();
      } else if (currentStep === 2) {
        if (!selectedTemplate) {
          alert('è«‹å…ˆé¸æ“‡ä¸€å€‹é è¨­é »ç‡');
          return;
        }
        applyTemplateToSchedule(selectedTemplate);
        renderDayList();
        currentStep = 3;
        updateStepUI();
      } else if (currentStep === 3) {
        // çµ„æˆè¦é€å‡ºçš„è³‡æ–™
        const payload = {
          startDate: startInput.value,
          endDate: endInput.value,
          visits: []
        };

        Object.entries(schedule).forEach(([dateKey, set]) => {
          if (set.size > 0) {
            payload.visits.push({
              date: dateKey,
              slots: Array.from(set) // ä¾‹å¦‚ ["MORNING","EVENING"]
            });
          }
        });

        if (payload.visits.length === 0) {
          alert('å°šæœªé¸æ“‡ä»»ä½•åˆ°è¨ªæ™‚æ®µï¼Œè«‹è‡³å°‘å‹¾é¸ä¸€å€‹ã€‚');
          return;
        }

        // é€™è£¡å…ˆç”¨ alert çœ‹è³‡æ–™é•·ä»€éº¼æ¨£ï¼Œä¹‹å¾Œå¯ä»¥æ”¹æˆ fetch/LIFF å‚³çµ¦ Apps Script
        alert('å°‡é€å‡ºä»¥ä¸‹é ç´„è³‡æ–™ï¼š\n' + JSON.stringify(payload, null, 2));

        /*
        ç¯„ä¾‹ï¼šé€åˆ° Apps Script
        fetch('ä½ çš„ Apps Script ç¶²å€', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        }).then(res => res.json())
          .then(result => {
            // é¡¯ç¤ºæˆåŠŸç•«é¢ or è·³è½‰
          });
        */
      }
    });

    // åˆå§‹åŒ–
    updateStepUI();
    updateStep1Summary();
  </script>
</body>
</html>
