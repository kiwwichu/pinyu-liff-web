<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ­·å²è¨‚å–®æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* æ•´é«”ç‰ˆå‹ï¼šé–å®šåœ¨æ‰‹æ©Ÿå¯¬åº¦ï¼Œä¸æœƒå¤ªç©º */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f5f5;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f5f5f5;
    }

    header {
      padding: 10px 16px;
      background: #48a2e8;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      letter-spacing: 2px;
    }

    #root {
      flex: 1;
      padding: 10px 10px 16px;
      box-sizing: border-box;
    }

    /* ä¸Šæ–¹æœå°‹åˆ—ï¼šå–®ä¸€é—œéµå­—æœå°‹ï¼ˆæ¨¡ç³Šæœå°‹æ—¥æœŸï¼‰ */
    .filter-bar {
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      margin-bottom: 10px;
      font-size: 12px;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      white-space: nowrap;
      color: #555;
      font-size: 12px;
    }

    .filter-input {
      flex: 1;
    }

    .filter-input input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .filter-input input::placeholder {
      color: #bbb;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #48a2e8;
      color: #fff;
    }

    .btn-secondary {
      background-color: #e5e5e5;
      color: #444;
    }

    /* è‡ªå‹•ç”¢ç”Ÿçš„æ—¥æœŸå¿«é€Ÿé¸å–® */
    .quick-dates {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-date-chip {
      border: none;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      background-color: #f2f7ff;
      color: #336699;
      cursor: pointer;
      white-space: nowrap;
    }

    .quick-date-chip:hover {
      background-color: #e0efff;
    }

    /* åˆ—è¡¨æ¨™é¡Œåˆ—ï¼ˆæœå‹™æ—¥æœŸï¼ç¸½é‡‘é¡ï¼‰ */
    .list-header {
      display: flex;
      justify-content: space-between;
      padding: 4px 2px 4px;
      font-size: 13px;
      color: #555;
      font-weight: 600;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 4px;
    }

    .list-header span {
      flex: 1;
    }

    .list-header span:last-child {
      text-align: right;
    }

    /* è¨‚å–®å¡ç‰‡ */
    .order-card {
      background: #ffffff;
      border-radius: 10px;
      margin-bottom: 8px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      font-size: 13px;
      line-height: 1.4;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .order-card:hover {
      background-color: #f9fbff;
    }

    .order-summary-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .order-summary-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .summary-date {
      font-weight: 600;
      color: #222;
    }

    .summary-service {
      color: #666;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .order-summary-right {
      text-align: right;
      min-width: 80px;
    }

    .summary-total {
      font-weight: 700;
      color: #333;
    }

.summary-status {
  font-size: 11px;
  margin-top: 2px;
}

/* å¾…æœå‹™ï¼šè—è‰² */
.summary-status.status-blue {
  color: #48a2e8;
}

/* æœªä»˜å°¾æ¬¾ï¼šæ©˜è‰²ï¼ˆä½ ä¹‹å¾Œè¦æ›åˆ¥çš„é¡è‰²ä¹Ÿå¯ä»¥æ”¹é€™è£¡ï¼‰ */
.summary-status.status-orange {
  color: #d97b00;
}

/* å®Œæˆï¼šç¶ è‰² */
.summary-status.status-green {
  color: #3c8b4c;
}


    .expand-icon {
      font-size: 16px;
      color: #999;
      margin-left: 4px;
    }

    .order-detail {
      display: none;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed #e0e0e0;
    }

    .order-card.expanded .order-detail {
      display: block;
    }

    .detail-row {
      margin-bottom: 4px;
      color: #555;
    }

    .detail-label {
      color: #888;
      font-size: 12px;
      margin-right: 4px;
    }

    .deposit-text {
      color: #c37b00;
      font-size: 12px;
      margin-top: 2px;
    }

    .order-id {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    footer {
      padding: 6px 10px 10px;
      box-sizing: border-box;
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    /* Loading å‹•ç•« */
    .loading {
      text-align: center;
      font-size: 12px;
      color: #666;
      padding: 16px 0;
    }

    .cat-running {
      width: 60px;
      height: 40px;
      margin: 0 auto 8px;
      position: relative;
    }

    .cat-running .cat {
      width: 60px;
      height: 40px;
      background-image: url('https://i.imgur.com/tGpumPl.gif');
      background-size: cover;
      animation: run-cycle 0.6s steps(6) infinite;
    }

    @keyframes run-cycle {
      0% { background-position: 0 0; }
      100% { background-position: -360px 0; }
    }
  </style>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="page">
    <header>æ­·å²è¨‚å–®</header>
    <div id="root">è¼‰å…¥ä¸­...</div>
    <footer>è‹¥è³‡æ–™æœ‰ç–‘å•ï¼Œæ­¡è¿ç§è¨Šå¿«æ¨‚å°ç‹— Pinyu ğŸ¾</footer>
  </div>

<script>
  const LIFF_ID = '2008600362-O4V8Aq10';
  const API_BASE =
    'https://script.google.com/macros/s/AKfycbzTAFTsgL3wrFN89GTuI_HtH2jbMyMV48InQVQXIH93dGT9ZDUYb2KIgVD0_jextau9cA/exec';

  let gLineUserId = '';
  let gOrdersAll  = [];

  // -----------------------------
  // åˆå§‹åŒ–
  // -----------------------------
  async function init() {
    try {
      // 1) æª¢æŸ¥æ˜¯ä¸æ˜¯åœ¨ LINE å…§
      if (!liff.isInClient()) {
        document.getElementById('root').innerText =
          'è«‹å¾ LINE å®˜æ–¹å¸³è™Ÿå…§çš„é¸å–®é–‹å•Ÿæ­¤ç•«é¢å”·ï½';
        return;
      }

      // 2) åˆå§‹åŒ– LIFF
      await liff.init({ liffId: LIFF_ID });

      // 3) æ²’ç™»å…¥å°±è¦æ±‚ç™»å…¥ï¼ˆä½†åœ¨ LINE å…§é€šå¸¸å·²ç¶“æ˜¯ç™»å…¥ç‹€æ…‹ï¼‰
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      // 4) å„ªå…ˆç”¨ getProfile æ‹¿ userIdï¼ˆæœ€ç©©ï¼‰
      const profile = await liff.getProfile();
      gLineUserId = profile && profile.userId ? profile.userId : '';

      // 5) å‚™ç”¨ï¼šå†è©¦ context / ID Tokenï¼ˆå¤šä¸€å±¤ä¿éšªï¼‰
      if (!gLineUserId) {
        const ctx = liff.getContext();
        if (ctx && ctx.userId) gLineUserId = ctx.userId;
      }
      if (!gLineUserId) {
        const decoded = liff.getDecodedIDToken();
        if (decoded && decoded.sub) gLineUserId = decoded.sub;
      }

      if (!gLineUserId) {
        document.getElementById('root').innerText =
          'ç›®å‰ç„¡æ³•å–å¾—æ‚¨çš„å¸³è™Ÿè³‡è¨Šï¼Œè«‹é—œé–‰æ­¤é é¢å¾Œå†å¾å¿«æ¨‚å°ç‹— Pinyu å®˜æ–¹å¸³è™Ÿçš„é¸å–®é‡æ–°é–‹å•Ÿä¸€æ¬¡ï½';
        return;
      }

      // 6) ç•«ç•«é¢ + æŠ“æ­·å²è¨‚å–®
      buildLayout();
      await fetchOrdersFromServer();

    } catch (err) {
      console.error('init error:', err);
      const msg = (err && err.message) ? err.message : String(err);
      document.getElementById('root').innerText =
        'åˆå§‹åŒ–ç™¼ç”ŸéŒ¯èª¤ï¼š' + msg + '\nè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
    }
  }

  // -----------------------------
  // ç•«å‡ºæœå°‹åˆ— + åˆ—è¡¨éª¨æ¶
  // -----------------------------
  function buildLayout() {
    const root = document.getElementById('root');
    root.innerHTML = `
      <div style="font-size:10px;color:#aaa;margin-bottom:4px;">
        Debug userIdï¼š${gLineUserId}
      </div>

      <div class="filter-bar">
        <div class="filter-row">
          <span class="filter-label">æœå°‹æ—¥æœŸ</span>
          <div class="filter-input">
            <input
              type="text"
              id="keyword"
              placeholder="ä¾‹å¦‚ï¼š01ã€01/28ã€2025-01-28"
            />
          </div>
        </div>
        <div class="filter-actions">
          <button class="btn btn-secondary" id="btnClear">æ¸…é™¤</button>
          <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
        </div>
        <div class="quick-dates" id="quickDates"></div>
      </div>

      <div class="list-header">
        <span>æœå‹™æ—¥æœŸ</span>
        <span>ç¸½é‡‘é¡</span>
      </div>

      <div id="orderList">è¼‰å…¥ä¸­...</div>
    `;

    document.getElementById('btnSearch').addEventListener('click', () => {
      applyFilter();
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      const input = document.getElementById('keyword');
      input.value = '';
      renderOrders(gOrdersAll);
    });

    document.getElementById('keyword').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') applyFilter();
    });
  }

  // -----------------------------
  // Loading ç•«é¢
  // -----------------------------
  function showLoading() {
    const listEl = document.getElementById('orderList');
    if (!listEl) return;

    listEl.innerHTML = `
      <div class="loading">
        <div class="cat-running">
          <div class="cat"></div>
        </div>
        <div>è²“å’ªå¥”è·‘ä¸­ï¼Œè«‹ç¨å€™...</div>
      </div>
    `;
  }

  // -----------------------------
  // å¾ Apps Script æŠ“æ­·å²è¨‚å–®
  // -----------------------------
  async function fetchOrdersFromServer() {
    const listEl = document.getElementById('orderList');
    showLoading();

    const params = new URLSearchParams();
    params.set('action', 'history');
    params.set('lineUserId', gLineUserId);

    const url = `${API_BASE}?${params.toString()}`;

    try {
      const res = await fetch(url);

      if (!res.ok) {
        const text = await res.text();
        console.error('API HTTP Error:', res.status, text);
        listEl.innerText =
          `æŸ¥è©¢å¤±æ•—ï¼ˆHTTP ${res.status}ï¼‰ï¼Œè«‹é€šçŸ¥ pinyu çœ‹å¾Œå°ï½`;
        return;
      }

      const data = await res.json();
      console.log('API å›å‚³ï¼š', data);

      if (!data.success) {
        listEl.innerText =
          'æŸ¥è©¢å¤±æ•—ï¼ˆsuccess=falseï¼‰ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
        return;
      }

      gOrdersAll = data.orders || [];

      // ä¾æ—¥æœŸæ’åºï¼ˆèˆŠâ†’æ–°ï¼‰
      gOrdersAll.sort((a, b) => {
        const da = (a.serviceDate || a.dateText || '').toString();
        const db = (b.serviceDate || b.dateText || '').toString();
        return da.localeCompare(db);
      });

      renderOrders(gOrdersAll);
      buildQuickDates();

    } catch (err) {
      console.error('fetchOrdersFromServer error:', err);
      const msg = (err && err.message) ? err.message : String(err);
      listEl.innerText =
        'æŸ¥è©¢å¤±æ•—ï¼ˆä¾‹å¤–ï¼‰ï¼š' + msg + 'ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
    }
  }

  // -----------------------------
  // æ¨¡ç³Šæœå°‹
  // -----------------------------
  function applyFilter() {
    const input = document.getElementById('keyword');
    const kwRaw = (input.value || '').trim();

    if (!kwRaw) {
      renderOrders(gOrdersAll);
      return;
    }

    const kw = kwRaw.replace(/\s/g, '');

    const filtered = gOrdersAll.filter((o) => {
      const dateText =
        (o.dateText || o.serviceDate || o.createdText || '').toString();
      const normalizedDate = dateText.replace(/\s/g, '');
      return normalizedDate.includes(kw);
    });

    renderOrders(filtered);
  }

  // -----------------------------
  // æ—¥æœŸå¿«é€Ÿé¸å–®
  // -----------------------------
  function buildQuickDates() {
    const container = document.getElementById('quickDates');
    if (!container) return;

    const allDates = gOrdersAll
      .map((o) => o.serviceDate || o.dateText || o.createdText || '')
      .filter((d) => !!d);

    const uniqueDates = Array.from(new Set(allDates));
    uniqueDates.sort();

    if (uniqueDates.length === 0) {
      container.innerHTML = '';
      return;
    }

    container.innerHTML = uniqueDates
      .map((d) => `<button class="quick-date-chip" data-date="${d}">${d}</button>`)
      .join('');

    container.querySelectorAll('.quick-date-chip').forEach((btn) => {
      btn.addEventListener('click', () => {
        const date = btn.getAttribute('data-date') || '';
        const input = document.getElementById('keyword');
        input.value = date;
        applyFilter();
      });
    });
  }

  // -----------------------------
  // ç‹€æ…‹æ–‡å­— / é¡è‰²å°æ‡‰
  // -----------------------------
  function mapOrderStatus(rawStatus) {
    const s = (rawStatus || '').trim();

    // é€™è£¡ä½ å¯ä»¥ä¾ä½ è¡¨å–®çš„å¯¦éš›æ–‡å­—å†å¾®èª¿
    if (['å®Œæˆ', 'å·²å®Œæˆ', 'å·²æœå‹™', 'çµæ¡ˆ'].includes(s)) {
      return { label: s || 'å·²å®Œæˆ', className: 'status-green' };
    }
    if (['æœªä»˜å°¾æ¬¾', 'å¾…ä»˜æ¬¾', 'å°¾æ¬¾æœªä»˜'].includes(s)) {
      return { label: s || 'æœªä»˜å°¾æ¬¾', className: 'status-orange' };
    }
    if (['å¾…åŸ·è¡Œ', 'å¾…æœå‹™', 'å·²ç¢ºèª', 'æˆç«‹'].includes(s)) {
      return { label: s || 'å¾…æœå‹™', className: 'status-blue' };
    }

    // é è¨­ç•¶æˆã€Œå¾…æœå‹™ã€
    return { label: s || 'è™•ç†ä¸­', className: 'status-blue' };
  }

  // -----------------------------
  // å–®ä¸€è¨‚å–®å¡ç‰‡
  // -----------------------------
  function renderOrderCard(order) {
    const dateText =
      order.serviceDate || order.dateText || order.createdText || '';
    const totalText =
      order.total != null && order.total !== ''
        ? `${order.total} å…ƒ`
        : '-';
    const serviceSummary =
      order.serviceSummary || order.services || order.remark || '';
    const orderId = order.orderId || order.id || '';
    const statusInfo = mapOrderStatus(order.status || '');

    return `
      <div class="order-card">
        <div class="order-summary-row">
          <div class="order-summary-left">
            <div class="summary-date">${dateText}</div>
            <div class="summary-service">${serviceSummary}</div>
            <div class="summary-status ${statusInfo.className}">
              ${statusInfo.label}
            </div>
          </div>
          <div class="order-summary-right">
            <div class="summary-total">${totalText}</div>
          </div>
        </div>
        ${
          orderId
            ? `<div class="order-id">è¨‚å–®ç·¨è™Ÿï¼š${orderId}</div>`
            : ''
        }
      </div>
    `;
  }

  // -----------------------------
  // ç•«è¨‚å–®åˆ—è¡¨
  // -----------------------------
  function renderOrders(orders) {
    const listEl = document.getElementById('orderList');
    if (!listEl) return;

    if (!orders || orders.length === 0) {
      listEl.innerHTML =
        '<div style="padding:8px;color:#888;font-size:12px;">ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ï½</div>';
      return;
    }

    const html = orders.map((order) => renderOrderCard(order)).join('');
    listEl.innerHTML = html;
  }

  // -----------------------------
  // å•Ÿå‹•ï¼
  // -----------------------------
  init();
</script>
