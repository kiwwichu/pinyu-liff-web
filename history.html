<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æ­·å²è¨‚å–®æŸ¥è©¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* æ•´é«”ç‰ˆå‹ï¼šé–å®šåœ¨æ‰‹æ©Ÿå¯¬åº¦ï¼Œä¸æœƒå¤ªç©º */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f5f5f5;
    }

    .page {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: #f5f5f5;
    }

    header {
      padding: 10px 16px;
      background: #48a2e8;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      letter-spacing: 2px;
    }

    #root {
      flex: 1;
      padding: 10px 10px 16px;
      box-sizing: border-box;
    }

    /* ä¸Šæ–¹æœå°‹åˆ—ï¼šå–®ä¸€é—œéµå­—æœå°‹ï¼ˆæ¨¡ç³Šæœå°‹æ—¥æœŸï¼‰ */
    .filter-bar {
      background: #ffffff;
      border-radius: 10px;
      padding: 8px 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
      margin-bottom: 10px;
      font-size: 12px;
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-label {
      white-space: nowrap;
      color: #555;
      font-size: 12px;
    }

    .filter-input {
      flex: 1;
    }

    .filter-input input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .filter-input input::placeholder {
      color: #bbb;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 16px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #48a2e8;
      color: #fff;
    }

    .btn-secondary {
      background-color: #e5e5e5;
      color: #444;
    }

    /* è‡ªå‹•ç”¢ç”Ÿçš„æ—¥æœŸå¿«é€Ÿé¸å–® */
    .quick-dates {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-date-chip {
      border: none;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      background-color: #f2f7ff;
      color: #336699;
      cursor: pointer;
      white-space: nowrap;
    }

    .quick-date-chip:hover {
      background-color: #e0efff;
    }

    /* åˆ—è¡¨æ¨™é¡Œåˆ—ï¼ˆæœå‹™æ—¥æœŸï¼ç¸½é‡‘é¡ï¼‰ */
    .list-header {
      display: flex;
      justify-content: space-between;
      padding: 4px 2px 4px;
      font-size: 13px;
      color: #555;
      font-weight: 600;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 4px;
    }

    .list-header span {
      flex: 1;
    }

    .list-header span:last-child {
      text-align: right;
    }

    /* è¨‚å–®å¡ç‰‡ (ç¸®èµ·ä¾†æ™‚åªæ˜¯ä¸€è¡Œæ‘˜è¦ï¼Œé»é–‹æ‰é¡¯ç¤ºå…§å®¹) */
    .order-card {
      background: #ffffff;
      border-radius: 10px;
      margin-bottom: 8px;
      padding: 8px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      font-size: 13px;
      line-height: 1.4;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .order-card:hover {
      background-color: #f9fbff;
    }

    /* ä¸ŠåŠéƒ¨ï¼šä¸€è¡Œæ‘˜è¦ï¼ˆæœå‹™æ—¥æœŸï¼‹ç¸½é‡‘é¡ï¼‹ç‹€æ…‹ï¼‰ */
    .order-summary-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .order-summary-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .summary-date {
      font-weight: 600;
      color: #222;
    }

    .summary-service {
      color: #666;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .order-summary-right {
      text-align: right;
      min-width: 80px;
    }

    .summary-total {
      font-weight: 700;
      color: #333;
    }

    .summary-status {
      font-size: 11px;
      color: #48a2e8;
      margin-top: 2px;
    }

    /* å±•é–‹æ”¶åˆçš„å°ç®­é ­ */
    .expand-icon {
      font-size: 16px;
      color: #999;
      margin-left: 4px;
    }

    /* ä¸‹åŠéƒ¨ï¼šè©³ç´°å€åŸŸï¼ˆé è¨­éš±è—ï¼‰ */
    .order-detail {
      display: none;
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed #e0e0e0;
    }

    .order-card.expanded .order-detail {
      display: block;
    }

    .detail-row {
      margin-bottom: 4px;
      color: #555;
    }

    .detail-label {
      color: #888;
      font-size: 12px;
      margin-right: 4px;
    }

    .deposit-text {
      color: #c37b00;
      font-size: 12px;
      margin-top: 2px;
    }

    .order-id {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    footer {
      padding: 6px 10px 10px;
      box-sizing: border-box;
      font-size: 11px;
      color: #888;
      text-align: center;
    }

    /* è¼‰å…¥å‹•ç•« */
    .loading {
      text-align: center;
      padding: 20px 0;
      font-size: 13px;
      color: #666;
    }

    .loading-spinner {
      width: 20px;
      height: 20px;
      margin: 0 auto 6px;
      border-radius: 50%;
      border: 3px solid #ddd;
      border-top-color: #48a2e8;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
  </style>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <div class="page">
    <header>æ­·å²è¨‚å–®</header>
    <div id="root">è¼‰å…¥ä¸­...</div>
    <footer>è‹¥è³‡æ–™æœ‰ç–‘å•ï¼Œæ­¡è¿ç§è¨Šå¿«æ¨‚å°ç‹— Pinyu ğŸ¾</footer>
  </div>

  <script>
    // â˜… é€™è£¡æ”¾ä½ çš„ LIFF IDï¼ˆå·²æ˜¯ä½ ç¾åœ¨çš„ï¼‰
    const LIFF_ID = '2008567730';

    // â˜… é€™è£¡æ”¾ä½ çš„ Apps Script Web App URLï¼ˆè®€æ­·å²è¨‚å–®ï¼‰
    const API_BASE =
      'https://script.google.com/macros/s/AKfycbwh2tNbj_NKcy3tyw94HUb6-C_cu3C4llX1qrEmmW075oPwJ3savE8qMrwMVeSpJtMFHA/exec';

    let gLineUserId = '';      // å¾ LIFF æ‹¿åˆ°çš„ userId
    let gOrdersAll  = [];      // å…¨éƒ¨æ­·å²è¨‚å–®ï¼ˆç¬¬ä¸€æ¬¡è¼‰å…¥å¾Œéƒ½å­˜åœ¨é€™è£¡ï¼Œä¹‹å¾Œæœå°‹éƒ½åœ¨å‰ç«¯è™•ç†ï¼‰

    // -----------------------------
    // åˆå§‹åŒ–æµç¨‹
    // -----------------------------
    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });

        // è‹¥ä¸æ˜¯åœ¨ LINE å…§æ‰“é–‹ï¼Œå°±çµ¦æç¤º
        if (!liff.isInClient()) {
          document.getElementById('root').innerText =
            'è«‹å¾ LINE å®˜æ–¹å¸³è™Ÿå…§çš„é¸å–®é–‹å•Ÿæ­¤ç•«é¢å”·ï½';
          return;
        }

        const decoded = liff.getDecodedIDToken();
        gLineUserId = decoded ? decoded.sub : '';

        if (!gLineUserId) {
          document.getElementById('root').innerText =
            'ç„¡æ³•å–å¾—æ‚¨çš„å¸³è™Ÿè³‡è¨Šï¼Œè«‹é€šçŸ¥ pinyu å¹«å¿™æŸ¥çœ‹è¨­å®šï½';
          return;
        }

        // å…ˆæŠŠç‰ˆé¢éª¨æ¶ç•«å‡ºä¾†ï¼ˆæœå°‹åˆ— + ç©ºçš„åˆ—è¡¨ï¼‰
        buildLayout();

        // ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼šä¸€æ¬¡æŠ“å…¨éƒ¨æ­·å²è¨‚å–®
        await fetchOrdersFromServer();

      } catch (err) {
        console.error(err);
        document.getElementById('root').innerText =
          'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
      }
    }

    // -----------------------------
    // ç•«å‡ºæœå°‹åˆ— + åˆ—è¡¨å®¹å™¨
    // -----------------------------
    function buildLayout() {
      const root = document.getElementById('root');
      root.innerHTML = `
        <div class="filter-bar">
          <div class="filter-row">
            <span class="filter-label">æœå°‹æ—¥æœŸ</span>
            <div class="filter-input">
              <input
                type="text"
                id="keyword"
                placeholder="ä¾‹å¦‚ï¼š01ã€01/28ã€2025-01-28"
              />
            </div>
          </div>
          <div class="filter-actions">
            <button class="btn btn-secondary" id="btnClear">æ¸…é™¤</button>
            <button class="btn btn-primary" id="btnSearch">æœå°‹</button>
          </div>
          <div class="quick-dates" id="quickDates"></div>
        </div>

        <div class="list-header">
          <span>æœå‹™æ—¥æœŸ</span>
          <span>ç¸½é‡‘é¡</span>
        </div>

        <div id="orderList">è¼‰å…¥ä¸­...</div>
      `;

      // ç¶å®šæŒ‰éˆ•äº‹ä»¶
      document.getElementById('btnSearch').addEventListener('click', () => {
        applyFilter();
      });

      document.getElementById('btnClear').addEventListener('click', () => {
        const input = document.getElementById('keyword');
        input.value = '';
        renderOrders(gOrdersAll);
      });

      // Enter ç›´æ¥æœå°‹
      document.getElementById('keyword').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          applyFilter();
        }
      });
    }

    // -----------------------------
    // é¡¯ç¤ºè¼‰å…¥å‹•ç•«
    // -----------------------------
    function showLoading() {
      const listEl = document.getElementById('orderList');
      if (!listEl) return;

      listEl.innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <div>æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™...</div>
        </div>
      `;
    }

    // -----------------------------
    // å¾ Apps Script å–å¾—å…¨éƒ¨æ­·å²è¨‚å–®
    // -----------------------------
    async function fetchOrdersFromServer() {
      const listEl = document.getElementById('orderList');
      showLoading();

      const params = new URLSearchParams();
      params.set('action', 'history');
      params.set('lineUserId', gLineUserId);

      const url = `${API_BASE}?${params.toString()}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        console.log('API å›å‚³ï¼š', data);

        if (!data.success) {
          listEl.innerText = 'æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
          return;
        }

        gOrdersAll = data.orders || [];

        // ä¾ç…§æœå‹™æ—¥æœŸæ’åºï¼ˆè‹¥å¾Œç«¯æ²’æœ‰æ’ï¼‰
        gOrdersAll.sort((a, b) => {
          const da = (a.serviceDate || a.dateText || '').toString();
          const db = (b.serviceDate || b.dateText || '').toString();
          return da.localeCompare(db);
        });

        // å…ˆç•«å…¨éƒ¨
        renderOrders(gOrdersAll);
        // å†æ ¹æ“šè³‡æ–™è‡ªå‹•ç”¢ç”Ÿæ—¥æœŸå¿«é€Ÿé¸å–®
        buildQuickDates();

      } catch (err) {
        console.error(err);
        listEl.innerText = 'æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–é€šçŸ¥ pinyuï½';
      }
    }

    // -----------------------------
    // ä¾ç›®å‰è¼¸å…¥çš„é—œéµå­—åšã€Œæ¨¡ç³Šæœå°‹ã€
    // -----------------------------
    function applyFilter() {
      const input = document.getElementById('keyword');
      const kwRaw = (input.value || '').trim();

      // æ²’è¼¸å…¥å°±é¡¯ç¤ºå…¨éƒ¨
      if (!kwRaw) {
        renderOrders(gOrdersAll);
        return;
      }

      // æŠŠç©ºç™½æ‹¿æ‰ï¼Œè®“ã€Œ01  /  28ã€é€™ç¨®ä¹Ÿèƒ½æœåˆ°
      const kw = kwRaw.replace(/\s/g, '');

      const filtered = gOrdersAll.filter((o) => {
        const dateText = (o.serviceDate || o.dateText || '').toString();
        const normalizedDate = dateText.replace(/\s/g, '');
        // åªè¦æ—¥æœŸæ–‡å­—æœ‰åŒ…å«é—œéµå­—å°±ç®—ï¼ˆæ¨¡ç³Šæœå°‹ï¼‰
        return normalizedDate.includes(kw);
      });

      renderOrders(filtered);
    }

    // -----------------------------
    // ä¾ç…§æ­·å²è¨‚å–®ï¼Œè‡ªå‹•ç”¢ç”Ÿã€Œæ—¥æœŸå¿«é€Ÿé¸å–®ã€
    // -----------------------------
    function buildQuickDates() {
      const container = document.getElementById('quickDates');
      if (!container) return;

      const allDates = gOrdersAll
        .map((o) => o.serviceDate || o.dateText || '')
        .filter((d) => !!d);

      // å–å”¯ä¸€æ—¥æœŸ
      const uniqueDates = Array.from(new Set(allDates));
      uniqueDates.sort();

      if (uniqueDates.length === 0) {
        container.innerHTML = '';
        return;
      }

      container.innerHTML = uniqueDates
        .map(
          (d) =>
            `<button class="quick-date-chip" data-date="${d}">${d}</button>`
        )
        .join('');

      // é»æ—¥æœŸ chip â†’ è‡ªå‹•å¸¶å…¥æœå°‹ä¸¦å¥—ç”¨
      container.querySelectorAll('.quick-date-chip').forEach((btn) => {
        btn.addEventListener('click', () => {
          const date = btn.getAttribute('data-date') || '';
          const input = document.getElementById('keyword');
          input.value = date;
          applyFilter();
        });
      });
    }

    // -----------------------------
    // æŠŠè¨‚å–®åˆ—è¡¨ç•«å‡ºä¾†
    // -----------------------------
    function renderOrders(orders) {
      const listEl = document.getElementById('orderList');

      if (!orders || orders.length === 0) {
        listEl.innerText = 'ç›®å‰æŸ¥ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æ­·å²è¨‚å–®å”·ï½';
        return;
      }

      listEl.innerHTML = ''; // æ¸…ç©º

      orders.forEach((o) => {
        const status = o.status || 'â€”';
        const dateText = o.serviceDate || o.dateText || 'â€”';
        const serviceText =
          o.serviceText ||
          (o.services && o.services.join('ã€')) ||
          'â€”';
        const depositText = o.depositText || '';
        const total = o.total != null ? o.total : 'â€”';

        const card = document.createElement('div');
        card.className = 'order-card';

        // summary å€å¡Šï¼ˆæœå‹™æ—¥æœŸï¼‹ç¸½é‡‘é¡ï¼‰
        const summaryRow = document.createElement('div');
        summaryRow.className = 'order-summary-row';

        const summaryLeft = document.createElement('div');
        summaryLeft.className = 'order-summary-left';

        const dateSpan = document.createElement('div');
        dateSpan.className = 'summary-date';
        dateSpan.textContent = dateText;

        const serviceSpan = document.createElement('div');
        serviceSpan.className = 'summary-service';
        serviceSpan.textContent = serviceText;

        summaryLeft.appendChild(dateSpan);
        summaryLeft.appendChild(serviceSpan);

        const summaryRight = document.createElement('div');
        summaryRight.className = 'order-summary-right';

        const totalSpan = document.createElement('div');
        totalSpan.className = 'summary-total';
        totalSpan.textContent = total + ' å…ƒ';

        const statusSpan = document.createElement('div');
        statusSpan.className = 'summary-status';
        statusSpan.textContent = status;

        summaryRight.appendChild(totalSpan);
        summaryRight.appendChild(statusSpan);

        const expandIcon = document.createElement('div');
        expandIcon.className = 'expand-icon';
        expandIcon.textContent = 'âŒµ'; // æŠ˜ç–Šç®­é ­

        summaryRow.appendChild(summaryLeft);
        summaryRow.appendChild(summaryRight);
        summaryRow.appendChild(expandIcon);

        card.appendChild(summaryRow);

        // è©³ç´°å…§å®¹å€å¡Šï¼ˆå±•é–‹å¾Œå‡ºç¾ï¼‰
        const detail = document.createElement('div');
        detail.className = 'order-detail';

        const idRow = document.createElement('div');
        idRow.className = 'detail-row order-id';
        idRow.textContent = 'è¨‚å–®ç·¨è™Ÿï¼š' + (o.orderId || 'â€”');

        const dateRow = document.createElement('div');
        dateRow.className = 'detail-row';
        dateRow.innerHTML =
          `<span class="detail-label">æœå‹™æ—¥æœŸ</span>${dateText}`;

        const serviceRow = document.createElement('div');
        serviceRow.className = 'detail-row';
        serviceRow.innerHTML =
          `<span class="detail-label">æœå‹™å…§å®¹</span>${serviceText}`;

        const totalRow = document.createElement('div');
        totalRow.className = 'detail-row';
        totalRow.innerHTML =
          `<span class="detail-label">ç¸½é‡‘é¡</span>${total} å…ƒ`;

        const statusRow = document.createElement('div');
        statusRow.className = 'detail-row';
        statusRow.innerHTML =
          `<span class="detail-label">ç‹€æ…‹</span>${status}`;

        detail.appendChild(idRow);
        detail.appendChild(dateRow);
        detail.appendChild(serviceRow);
        detail.appendChild(totalRow);
        detail.appendChild(statusRow);

        if (depositText) {
          const depRow = document.createElement('div');
          depRow.className = 'detail-row deposit-text';
          depRow.textContent = depositText;
          detail.appendChild(depRow);
        }

        card.appendChild(detail);

        // é»æ•´å¼µå¡ç‰‡ â†’ å±•é–‹ / æ”¶åˆ
        card.addEventListener('click', () => {
          const expanded = card.classList.toggle('expanded');
          expandIcon.textContent = expanded ? 'âŒƒ' : 'âŒµ';
        });

        listEl.appendChild(card);
      });
    }

    // å•Ÿå‹•ï¼
    init();
  </script>
</body>
</html>
