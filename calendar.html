<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>可預約時間表</title>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --border:#e8edf6;
      --text:#24324a;
      --muted:#6b7a90;

      /* 品牌主色（藍） */
      --brand:#48a2e8;
      --brandBg:#eef8ff;

      /* 狀態色：開放=綠、少量=黃、額滿=紅 */
      --open:#20a56b;
      --openBg:#eafaf2;

      --yellow:#b78100;
      --yellowBg:#fff7e5;

      --red:#c43c3c;
      --redBg:#ffecec;

      --shadow: 0 10px 30px rgba(15, 23, 42, .06);
      --radius: 16px;
    }

    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      letter-spacing:.2px;
    }
    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* ===== top card ===== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title{
      font-size: 15px;
      font-weight: 600;
      margin: 0;
    }
    .sub{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .input{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      cursor:pointer;
    }
    .btn:hover{ background:#fafcff; }

    .legend{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      align-items:center;
    }
    .dot{
      width:10px;height:10px;border-radius:99px; display:inline-block;
      border:1px solid var(--border);
    }
    .dot.blue{ background: var(--openBg); border-color: rgba(32,165,107,.35); }
    .dot.yellow{ background:var(--yellowBg); border-color:#ffe2a3; }
    .dot.red{ background:var(--redBg); border-color:#ffd0d0; }

    /* ===== calendar container ===== */
    #calendar{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
    }

    /* FullCalendar typography soften */
    .fc .fc-button:focus,
    .fc .fc-button-primary:focus{
      box-shadow: 0 0 0 3px rgba(72,162,232,.18) !important;
    }
    .fc .fc-button:hover{
      border-color: rgba(72,162,232,.35) !important;
      background: var(--brandBg) !important;
    }
    .fc .fc-toolbar-title{
      color: var(--text);
    }

    /* 我們不要事件塊長條，改成「日格摘要」：所以事件本體隱藏 */
    .fc .fc-daygrid-event{
      display:none !important;
    }

    /* ===== day cell summary ===== */
    .daySummary{
      margin: 6px;
      padding: 8px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background:#fbfcff;
      display:grid;
      gap: 6px;
      cursor:pointer;
      user-select:none;
    }
    .daySummary:hover{
      border-color:#d7e3fb;
      background:#f7faff;
    }
    .sumRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--text);
    }
    .sumRow .left{
      display:flex; align-items:center; gap: 8px;
      color: var(--muted);
    }
    .chip{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background:#fff;
      color: var(--muted);
    }
    .mark{
      width: 18px; height: 18px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .mark.open{ color:var(--open); background:var(--openBg); border-color:#bfeedd; }
    .mark.tight{ color:var(--yellow); background:var(--yellowBg); border-color:#ffe2a3; }
    .mark.full{ color:var(--red); background:var(--redBg); border-color:#ffd0d0; }

    /* ===== drawer ===== */
    .mask{
      position:fixed; inset:0;
      background:rgba(16,24,40,.28);
      backdrop-filter: blur(2px);
      display:none;
      justify-content:flex-end;
    }
    .drawer{
      width:min(420px, 92vw);
      height:100%;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow: -12px 0 28px rgba(0,0,0,.10);
      padding:16px;
      overflow:auto;
      animation: slideIn .18s ease-out;
    }
    @keyframes slideIn { from { transform: translateX(10px); opacity:.7 } to { transform:none; opacity:1 } }

    .drawerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .drawerTitle{
      font-size: 14px;
      font-weight: 600;
      margin:0;
    }
    .drawerSub{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
      color: var(--text);
    }
    .iconBtn:hover{ background:#fafcff; }

    .list{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .rowCard{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }
    .rowLeft{
      display:grid;
      gap: 6px;
      font-size: 13px;
    }
    .rowTop{
      display:flex;
      gap: 8px;
      align-items:center;
      color: var(--text);
      font-weight: 500;
    }
    .rowMeta{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .badge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      white-space:nowrap;
      align-self:flex-start;
      font-weight: 500;
    }
    .badge.open{ color:var(--open); background:var(--openBg); border-color:#bfeedd; }
    .badge.tight{ color:var(--yellow); background:var(--yellowBg); border-color:#ffe2a3; }
    .badge.full{ color:var(--red); background:var(--redBg); border-color:#ffd0d0; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <div class="title">可預約時間表（分鐘制）</div>
          <div class="sub">點日期可查看「早上 / 下午 / 晚上 / 深夜」四段詳細資訊。</div>
        </div>

        <div class="controls">
          <input id="year" class="input" style="width:96px" placeholder="Year" />
          <input id="month" class="input" style="width:70px" placeholder="Month" />
          <button class="btn" id="btnReload">重新載入</button>
        </div>
      </div>

      <div class="legend">
        <span class="dot blue"></span><span>開放</span>
        <span class="dot yellow"></span><span>少量（分鐘偏緊）</span>
        <span class="dot red"></span><span>額滿</span>
      </div>
    </div>

    <div id="calendar"></div>
  </div>

  <!-- Drawer -->
  <div class="mask" id="mask">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerHead">
        <div>
          <div class="drawerTitle" id="dTitle">日期詳情</div>
          <div class="drawerSub" id="dSub">—</div>
        </div>
        <button class="iconBtn" id="closeX">關閉</button>
      </div>

      <div class="list" id="detailList"></div>

      <div class="drawerSub" style="margin-top:12px;">
        ＊介面不顯示緩衝時間，但分鐘已納入扣除。
      </div>
    </div>
  </div>

  <script>
    // ====== Vercel API ======
    const API_URL = "/api/avail";

    const slotLabel = {
      MORNING: "早上",
      AFTERNOON: "下午",
      EVENING: "晚上",
      LATE: "深夜"
    };
    const SLOT_ORDER = ["MORNING","AFTERNOON","EVENING","LATE"];
    const LOW_MIN_THRESHOLD = 60; // 少量門檻：<=60 分鐘 → 黃

    // drawer close
    const mask = document.getElementById('mask');
    const closeX = document.getElementById('closeX');
    closeX.onclick = () => mask.style.display = 'none';
    mask.onclick = (e) => { if (e.target === mask) mask.style.display = 'none'; };

    function stripBufferText(occupied) {
      if (!occupied) return '';
      return String(occupied)
        .split('；')
        .map(s => s.trim())
        .filter(s => s && !s.includes('緩衝'))
        .join('；');
    }

    function classify(status, mins){
      status = String(status || '').trim();
      mins = Number(mins || 0);

      if (status === '額滿' || mins <= 0) return 'full';
      if (status === '開放' && mins <= LOW_MIN_THRESHOLD) return 'tight';
      return 'open';
    }

    async function fetchMonth(year, month) {
      const url = `${API_URL}?year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`API error ${res.status}`);
      return await res.json();
    }

    // 資料整理：date -> {slot->item}
    function groupByDate(data){
      const map = new Map();
      for (const it of (Array.isArray(data) ? data : [])) {
        const date = it.date;
        if (!map.has(date)) map.set(date, {});
        map.get(date)[it.slot] = it;
      }
      return map;
    }

    function markIcon(cls){
      if (cls === 'open') return '✓';
      if (cls === 'tight') return '△';
      return '✕';
    }

    function openDrawer(dateStr, dayObj){
      const title = document.getElementById('dTitle');
      const sub = document.getElementById('dSub');
      const list = document.getElementById('detailList');

      title.textContent = dateStr;
      sub.textContent = '早上 / 下午 / 晚上 / 深夜';
      list.innerHTML = '';

      for (const s of SLOT_ORDER){
        const it = (dayObj && dayObj[s]) ? dayObj[s] : null;

        const start = it ? it.start : '—';
        const end = it ? it.end : '—';
        const mins = it ? Number(it.availableMinutes || 0) : 0;
        const status = it ? String(it.status || '').trim() : '額滿';

        const cls = classify(status, mins);

        const occ = it ? stripBufferText(it.occupied) : '';
        const note = it ? String(it.note || '') : '';

        const row = document.createElement('div');
        row.className = 'rowCard';

        const left = document.createElement('div');
        left.className = 'rowLeft';

        const top = document.createElement('div');
        top.className = 'rowTop';
        top.textContent = `${slotLabel[s]}  ·  ${start}–${end}`;

        const meta = document.createElement('div');
        meta.className = 'rowMeta';
        const metaLines = [];
        metaLines.push(`可用：${mins} 分鐘`);
        if (occ) metaLines.push(`占用：${occ}`);
        if (note) metaLines.push(`備註：${note}`);
        meta.textContent = metaLines.join('｜');

        left.appendChild(top);
        left.appendChild(meta);

        const badge = document.createElement('div');
        badge.className = `badge ${cls}`;
        badge.textContent = (cls === 'open') ? '開放' : (cls === 'tight' ? '少量' : '額滿');

        row.appendChild(left);
        row.appendChild(badge);
        list.appendChild(row);
      }

      mask.style.display = 'flex';
    }

    // 自訂：在月曆格子內放「摘要卡」
    function renderDayCellSummary(dateStr, cell, grouped){
      const dayObj = grouped.get(dateStr);
      if (!dayObj) return;

      const frame = cell.querySelector('.fc-daygrid-day-frame');
      if (!frame) return;

      // 避免重複
      if (frame.querySelector('.daySummary')) return;

      const box = document.createElement('div');
      box.className = 'daySummary';
      box.title = '點擊查看四個時段詳細';

      for (const s of SLOT_ORDER){
        const it = dayObj[s];
        const mins = it ? Number(it.availableMinutes || 0) : 0;
        const status = it ? String(it.status || '').trim() : '額滿';
        const cls = classify(status, mins);

        const r = document.createElement('div');
        r.className = 'sumRow';

        const left = document.createElement('div');
        left.className = 'left';

        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = slotLabel[s];

        left.appendChild(chip);

        const mark = document.createElement('span');
        mark.className = `mark ${cls}`;
        mark.textContent = markIcon(cls);

        r.appendChild(left);
        r.appendChild(mark);

        box.appendChild(r);
      }

      box.onclick = (e) => {
        e.stopPropagation();
        openDrawer(dateStr, dayObj);
      };

      frame.appendChild(box);
    }

    function renderAllSummaries(){
      if (!calendar) return;

      // 先清掉舊摘要（避免殘留）
      document.querySelectorAll('.daySummary').forEach(el => el.remove());

      // 找到畫面上每個 day cell（FullCalendar dayGridMonth 每格都有 data-date）
      document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(cell => {
        const dateStr = cell.getAttribute('data-date');
        renderDayCellSummary(dateStr, cell, groupedData);
      });
    }

    let calendar;
    let groupedData = new Map();

    async function loadAndRender(year, month) {
      const data = await fetchMonth(year, month);
      groupedData = groupByDate(data);

      const el = document.getElementById('calendar');
      if (!calendar) {
        calendar = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          height: 'auto',
          locale: 'zh-tw',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
          },
          events: [],
          datesSet: function(){
            // 等 DOM 真的畫完，再塞摘要（很重要）
            setTimeout(renderAllSummaries, 0);
          },
          dateClick: function(info){
            const dayObj = groupedData.get(info.dateStr);
            if (dayObj) openDrawer(info.dateStr, dayObj);
          }
        });

        calendar.render();
      }

      // 同步到指定月份
      calendar.gotoDate(`${year}-${String(month).padStart(2,'0')}-01`);
      renderAllSummaries();
    }

    // UI init（✅ 一定要在 loadAndRender 外面）
    const yearInput = document.getElementById('year');
    const monthInput = document.getElementById('month');
    yearInput.value = 2026;
    monthInput.value = 1;

    document.getElementById('btnReload').onclick = async () => {
      try {
        await loadAndRender(Number(yearInput.value), Number(monthInput.value));
      } catch (err) {
        alert('載入失敗：' + err.message);
        console.error(err);
      }
    };

    (async () => {
      try {
        await loadAndRender(Number(yearInput.value), Number(monthInput.value));
      } catch (err) {
        alert('載入失敗：' + err.message + '\n\n請確認 /api/avail 是否可回傳 JSON');
        console.error(err);
      }
    })();
  </script>
</body>
</html>
