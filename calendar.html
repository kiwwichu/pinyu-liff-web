<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¯é ç´„æ™‚é–“è¡¨</title>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; background:#f6f8fb; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 14px; }
    .topbar { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-bottom: 12px; }
    .card { background:#fff; border:1px solid #e5e9f2; border-radius: 12px; box-shadow: 0 1px 6px rgba(0,0,0,.04); padding: 12px; }
    .btn { border:1px solid #cfd8ea; background:#fff; padding:10px 12px; border-radius: 10px; cursor:pointer; }
    .btn:active { transform: translateY(1px); }
    .muted { color:#667085; font-size: 13px; }
    #calendar { background:#fff; border-radius: 12px; border:1px solid #e5e9f2; padding: 10px; }

    /* event ç‹€æ…‹æ¨£å¼ï¼šå…ˆç”¨ class æ§åˆ¶ï¼Œé¡è‰²ä½ ä¹‹å¾Œå¯æ›æˆå“ç‰Œè‰² */
    .ev-open   { border: 1px solid #8bb6ff; background: #eaf2ff; color:#123a66; }
    .ev-tight  { border: 1px solid #ffcf70; background: #fff7e5; color:#6a4300; }
    .ev-full   { border: 1px solid #f1a3a3; background: #ffecec; color:#7a1d1d; text-decoration: line-through; opacity:.75; }
    .ev-closed { border: 1px solid #c7c7c7; background: #f2f2f2; color:#555; text-decoration: line-through; opacity:.75; }

    /* ç°¡æ˜“ modal */
    .modalMask { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; padding:12px; }
    .modal { width:min(520px, 96vw); background:#fff; border-radius:14px; border:1px solid #e5e9f2; box-shadow: 0 8px 28px rgba(0,0,0,.18); padding:14px; }
    .modal h3 { margin:0 0 8px; font-size:16px; }
    .row { margin: 6px 0; }
    .k { display:inline-block; width: 86px; color:#667085; }
    .closeX { float:right; cursor:pointer; font-size:18px; padding: 2px 6px; border-radius: 8px; }
    .closeX:hover { background:#f2f4f7; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; font-size: 12px; border:1px solid #e5e9f2; background:#f8fafc; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="card" style="flex:1; min-width: 280px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <div>
            <div style="font-weight:700;">å¯é ç´„æ™‚é–“è¡¨ï¼ˆåˆ†é˜åˆ¶ï¼‰</div>
            <div class="muted">è³‡æ–™ä¾†æºï¼šå¯é ç´„è¡¨ï¼ˆApps Script APIï¼‰</div>
          </div>
          <button class="btn" id="btnReload">é‡æ–°è¼‰å…¥</button>
        </div>

        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <label class="muted">Year</label>
          <input id="year" class="btn" style="width:100px;" />
          <label class="muted">Month</label>
          <input id="month" class="btn" style="width:70px;" />
          <span class="muted">ï¼ˆä¾‹ï¼š2026 / 1ï¼‰</span>
        </div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <span class="pill">é–‹æ”¾</span>
          <span class="pill">é»ƒï¼šåˆ†é˜åç·Š</span>
          <span class="pill">é¡æ»¿/ä¸é–‹æ”¾</span>
        </div>
      </div>
    </div>

    <div id="calendar"></div>
  </div>

  <!-- Modal -->
  <div class="modalMask" id="mask">
    <div class="modal">
      <div class="closeX" id="closeX">âœ•</div>
      <h3 id="mTitle">æ™‚æ®µè³‡è¨Š</h3>
      <div class="row"><span class="k">æ—¥æœŸ</span><span id="mDate"></span></div>
      <div class="row"><span class="k">æ™‚æ®µ</span><span id="mSlot"></span></div>
      <div class="row"><span class="k">æ™‚é–“</span><span id="mTime"></span></div>
      <div class="row"><span class="k">å¯ç”¨åˆ†é˜</span><span id="mMin"></span></div>
      <div class="row"><span class="k">ç‹€æ…‹</span><span id="mStatus"></span></div>
      <div class="row"><span class="k">å ç”¨</span><span id="mOcc"></span></div>
      <div class="row"><span class="k">å‚™è¨»</span><span id="mNote"></span></div>
      <div style="margin-top:12px;" class="muted">ï¼Šä¸‹ä¸€æ­¥å¯åŠ ï¼šé»æ“Šç›´æ¥é€²é ç´„æµç¨‹ï¼ˆé¸ 30/45/60 åˆ†ï¼‰</div>
    </div>
  </div>
  
  <script>
  // ====== ä½ åªè¦æ”¹é€™è¡Œ ======
  const API_URL = "/api/avail";
  // ========================

  const slotLabel = {
    MORNING: "æ—©ä¸Š",
    AFTERNOON: "ä¸‹åˆ",
    EVENING: "æ™šä¸Š",
    LATE: "æ·±å¤œ"
  };
  const LOW_MIN_THRESHOLD = 60;
  // ===== Drawer close =====
  const mask = document.getElementById('mask');
  const closeX = document.getElementById('closeX');
  closeX.onclick = () => mask.style.display = 'none';
  mask.onclick = (e) => { if (e.target === mask) mask.style.display = 'none'; };

  function ymdToday() {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth() + 1 };
  }

  function stripBufferText(occupied) {
    if (!occupied) return '';
    // occupied ç”¨ "ï¼›" ä¸²èµ·ä¾†ï¼šæŠŠå«ã€Œç·©è¡ã€çš„æ®µè½æ¿¾æ‰
    return String(occupied)
      .split('ï¼›')
      .map(s => s.trim())
      .filter(s => s && !s.includes('ç·©è¡'))
      .join('ï¼›');
  }

function statusBadgeClass(status, mins){
  status = String(status || '').trim();
  mins = Number(mins || 0);

  if (status === 'é¡æ»¿' || mins <= 0) return 'full';     // ğŸ”´
  if (status === 'é–‹æ”¾' && mins <= LOW_MIN_THRESHOLD) return 'tight'; // ğŸŸ¡
  return 'open'; // ğŸ”µ
}

  function openDrawer(info) {
    const mins = Number(info.availableMinutes || 0);
    const status = String(info.status || '').trim();

    document.getElementById('dDate').textContent = info.date;
    document.getElementById('dSlot').innerHTML =
      `${slotLabel[info.slot] || info.slot} <span class="muted">(${info.slot})</span>`;

    document.getElementById('dTime').textContent = `${info.start}â€“${info.end}`;
    document.getElementById('dMin').textContent = `${mins} åˆ†é˜`;

    const cls = statusBadgeClass(status, mins);
    document.getElementById('dStatus').innerHTML =
      `<span class="badge ${cls}">${status}</span>`;

    // å ç”¨ï¼šä¸é¡¯ç¤ºç·©è¡
    const occ = stripBufferText(info.occupied);
    document.getElementById('dOcc').textContent = occ || 'â€”';

    // å‚™è¨»ï¼šä¹Ÿä¸é¡¯ç¤ºç·©è¡å­—çœ¼ï¼ˆæ›´ä¹¾æ·¨ï¼‰
    const note = String(info.note || '').replace(/ç·©è¡.*$/g,'').trim();
    document.getElementById('dNote').textContent = note;

    mask.style.display = 'flex';
  }

  async function fetchMonth(year, month) {
    const url = `${API_URL}?year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return await res.json();
  }

  // ä½ è¦çš„é¡è‰²å°æ‡‰ï¼š
  // é–‹æ”¾=è—ã€é¡æ»¿=é»ƒã€æš«ä¸é–‹æ”¾=ç´…
function classByStatus(status, mins){
  status = String(status || '').trim();
  mins = Number(mins || 0);

  if (status === 'é¡æ»¿' || mins <= 0) return 'ev-full';          // ğŸ”´ é¡æ»¿
  if (status === 'é–‹æ”¾' && mins <= LOW_MIN_THRESHOLD) return 'ev-tight'; // ğŸŸ¡ å°‘é‡
  return 'ev-open';                                             // ğŸ”µ é–‹æ”¾
}


  function toEvent(item) {
    const startISO = `${item.date}T${item.start}:00`;
    const endISO   = `${item.date}T${item.end}:00`;

    const mins = Number(item.availableMinutes || 0);
    const status = String(item.status || '').trim();

    const className = classByStatus(status, mins);

    // é¡¯ç¤ºï¼šã€Œ13:00 ä¸‹åˆï½œ240mã€â†’ æˆ‘å€‘ç”¨ eventContent è‡ªè¨‚ï¼Œä¸ç”¨ title æ“ çˆ†
    const title = `${slotLabel[item.slot] || item.slot}ï½œ${mins}m`;

    return {
      title,
      start: startISO,
      end: endISO,
      allDay: false,
      classNames: [className],
      extendedProps: item
    };
  }

  let calendar;

  async function loadAndRender(year, month) {
    const data = await fetchMonth(year, month);
    const events = Array.isArray(data) ? data.map(toEvent) : [];

    const el = document.getElementById('calendar');
    if (!calendar) {
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'zh-tw',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        // âœ… é€™è£¡æ‰æ˜¯ eventContent æ­£ç¢ºä½ç½®
        eventContent: function(arg){
          const p = arg.event.extendedProps;
          const mins = Number(p.availableMinutes || 0);
          const label = slotLabel[p.slot] || p.slot;
          const text = `${p.start} ${label}ï½œ${mins}m`;

          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.alignItems = 'center';
          wrap.style.gap = '6px';

          const dot = document.createElement('span');
          dot.style.width = '8px';
          dot.style.height = '8px';
          dot.style.borderRadius = '999px';
          dot.style.background = 'currentColor';
          dot.style.opacity = '0.7';

          const txt = document.createElement('div');
          txt.style.whiteSpace = 'nowrap';
          txt.style.overflow = 'hidden';
          txt.style.textOverflow = 'ellipsis';
          txt.style.fontWeight = '750';
          txt.textContent = text;

          wrap.appendChild(dot);
          wrap.appendChild(txt);
          return { domNodes: [wrap] };
        },

        events,

        eventClick: function(arg) {
          openDrawer(arg.event.extendedProps);
        },

        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false }
      });

      calendar.render();
    } else {
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      calendar.gotoDate(`${year}-${String(month).padStart(2,'0')}-01`);
    }
  }
  // ===== UI init =====
  const yearInput = document.getElementById('year');
  const monthInput = document.getElementById('month');

  yearInput.value = 2026;
  monthInput.value = 1;

  document.getElementById('btnReload').onclick = async () => {
    const year = Number(yearInput.value);
    const month = Number(monthInput.value);
    try {
      await loadAndRender(year, month);
    } catch (err) {
      alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
      console.error(err);
    }
  };

  // é¦–æ¬¡è¼‰å…¥
  (async () => {
    try {
      await loadAndRender(Number(yearInput.value), Number(monthInput.value));
    } catch (err) {
      alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message + '\n\nè«‹ç¢ºèª API_URL / Web App æ¬Šé™');
      console.error(err);
    }
  })();
  
</script>
