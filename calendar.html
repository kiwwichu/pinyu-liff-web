<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>ÂèØÈ†êÁ¥ÑÊôÇÈñìË°®</title>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
:root{
  --brand:#48a2e8; --brandBg:#eef8ff;
  --open:#20a56b; --openBg:#eafaf2;
  --yellow:#b78100; --yellowBg:#fff7e5;
  --red:#c43c3c; --redBg:#ffecec;
  --border:#e8edf6; --text:#24324a; --muted:#6b7a90;
}
body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Arial; background:#f6f8fb; }
#calendar{ margin:16px; background:#fff; border:1px solid var(--border); border-radius:16px; padding:10px; }

/* Êó•ÊúüÊï∏Â≠ó */
.fc .fc-daygrid-day-top{ justify-content:center }
.fc .fc-daygrid-day-number{
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:800;color:var(--muted);
}
.fc .fc-day-today .fc-daygrid-day-number{
  background:var(--brandBg); border:1px solid rgba(72,162,232,.35);
}

/* ÊúàÊõÜÊ†º */
.fc .fc-daygrid-day-frame{ min-height:64px; padding:4px }
.appSlots{ display:flex; flex-direction:column; gap:4px; margin:4px }
.appSlot{
  height:12px; font-size:11px; font-weight:900;
  display:flex; align-items:center; justify-content:center;
  border-radius:6px; border:1px solid transparent;
}
.appSlot.open{ background:var(--openBg); color:var(--open) }
.appSlot.tight{ background:var(--yellowBg); color:var(--yellow) }
.appSlot.full{ background:var(--redBg); color:var(--red) }

/* ÈªûÈÅ∏ */
.fc .fc-daygrid-day.is-selected{ background:var(--brandBg) }

/* Êò•ÁØÄ */
.fc .fc-daygrid-day.is-cny{ background:rgba(196,60,60,.06) }
.fc .fc-daygrid-day.is-cny .fc-daygrid-day-frame{
  outline:2px solid rgba(196,60,60,.35); outline-offset:-2px; border-radius:14px;
}
.cnyBadge{
  position:absolute; top:2px; right:4px; font-size:14px;
}

/* Drawer */
.mask{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; justify-content:flex-end }
.drawer{ width:min(420px,92vw); background:#fff; height:100%; padding:16px; overflow:auto }
.rowCard{ border:1px solid var(--border); border-radius:14px; padding:12px; margin-bottom:10px; display:flex; justify-content:space-between }
.badge.open{ color:var(--open) }
.badge.tight{ color:var(--yellow) }
.badge.full{ color:var(--red) }
</style>
</head>

<body>
<div id="calendar"></div>

<div class="mask" id="mask">
  <div class="drawer">
    <h3 id="dTitle"></h3>
    <div id="dSub" style="color:#666;font-size:13px;margin-bottom:12px"></div>
    <div id="detailList"></div>
  </div>
</div>

<script>
/* ===== ÂÖ®ÂüüË®≠ÂÆö ===== */
const API_URL = "/api/avail";
const SLOT_ORDER = ["MORNING","AFTERNOON","EVENING"];
const slotLabel = { MORNING:"Êó©‰∏ä", AFTERNOON:"‰∏ãÂçà", EVENING:"Êôö‰∏ä" };
const CNY_START = "2026-02-16";
const CNY_END   = "2026-02-22";

const mask = document.getElementById('mask');
mask.onclick = e => { if(e.target===mask) mask.style.display='none' };

function classify(status){
  if(status==="ÈñãÊîæ") return "open";
  if(status==="Â∞ëÈáè") return "tight";
  return "full";
}
function icon(cls){ return cls==="open"?"‚úì":cls==="tight"?"‚ñ≥":"‚úï" }
function isCny(d){ return d>=CNY_START && d<=CNY_END }

async function fetchMonth(y,m){
  const r = await fetch(`${API_URL}?year=${y}&month=${m}`);
  return await r.json();
}

function group(data){
  const map=new Map();
  data.forEach(it=>{
    if(!map.has(it.date)) map.set(it.date,{});
    map.get(it.date)[it.slot]=it;
  });
  return map;
}

/* ===== Drawer ===== */
function openDrawer(dateStr, day){
  document.getElementById('dTitle').textContent = dateStr;
  document.getElementById('dSub').textContent =
    isCny(dateStr) ? "Êò•ÁØÄÊúüÈñìÔºàÁâπÂà•ÂÉπÊ†ºÔºâ" : "Êó©‰∏ä / ‰∏ãÂçà / Êôö‰∏ä";

  const list=document.getElementById('detailList');
  list.innerHTML="";
  SLOT_ORDER.forEach(s=>{
    const it=day[s]||{};
    const cls=classify(it.status);
    const row=document.createElement('div');
    row.className='rowCard';
    row.innerHTML=`<div>${slotLabel[s]}</div><div class="badge ${cls}">${it.status||"È°çÊªø"}</div>`;
    list.appendChild(row);
  });
  mask.style.display='flex';
}

/* ===== Calendar ===== */
let calendar, groupedData=new Map(), selected=null;

calendar=new FullCalendar.Calendar(document.getElementById('calendar'),{
  initialView:"dayGridMonth",
  locale:"zh-tw",
  dayCellContent: arg=>{
    const n=String(arg.dayNumberText).match(/\d+/)?.[0]||"";
    return { html:`<span class="fc-daygrid-day-number">${n}</span>` };
  },
  dayCellDidMount: arg=>{
    const d=arg.date.toISOString().slice(0,10);
    if(isCny(d)){
      arg.el.classList.add('is-cny');
      const f=arg.el.querySelector('.fc-daygrid-day-frame');
      if(f){
        f.style.position='relative';
        f.insertAdjacentHTML('beforeend','<div class="cnyBadge">üßß</div>');
      }
    }
  },
  datesSet: async info=>{
    const y=info.start.getFullYear();
    const m=info.start.getMonth()+1;
    groupedData=group(await fetchMonth(y,m));
    document.querySelectorAll('.appSlots').forEach(e=>e.remove());
    document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(cell=>{
      const d=cell.dataset.date;
      const day=groupedData.get(d); if(!day) return;
      const f=cell.querySelector('.fc-daygrid-day-frame');
      const w=document.createElement('div'); w.className='appSlots';
      SLOT_ORDER.forEach(s=>{
        const cls=classify(day[s]?.status);
        w.innerHTML+=`<div class="appSlot ${cls}">${icon(cls)}</div>`;
      });
      w.onclick=e=>{ e.stopPropagation(); selected=d; openDrawer(d,day) };
      f.appendChild(w);
    });
  },
  dateClick: info=>{
    selected=info.dateStr;
    const day=groupedData.get(info.dateStr);
    if(day) openDrawer(info.dateStr,day);
  }
});
calendar.render();
</script>
</body>
</html>
