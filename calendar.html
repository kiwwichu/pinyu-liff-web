<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>å¯é ç´„æ™‚é–“è¡¨</title>

  <!-- FullCalendar (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

  <style>
    /* è¢å…‰ç­† highlightï¼ˆå“ç‰Œè—æ·¡åº• + åœ“è§’ï¼‰ */
    .hl{
      display: inline;
      padding: 0 .22em;
      border-radius: .45em;
      background: linear-gradient(transparent 55%, rgba(72,162,232,.22) 55%);
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
    }
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --border:#e8edf6;
      --text:#24324a;
      --muted:#6b7a90;

      /* å“ç‰Œä¸»è‰²ï¼ˆè—ï¼‰ */
      --brand:#48a2e8;
      --brandBg:#eef8ff;

      /* ç‹€æ…‹è‰²ï¼šé–‹æ”¾=ç¶ ã€å°‘é‡=é»ƒã€é¡æ»¿=ç´… */
      --open:#20a56b;
      --openBg:#eafaf2;

      --yellow:#b78100;
      --yellowBg:#fff7e5;

      --red:#c43c3c;
      --redBg:#ffecec;

      --shadow: 0 10px 30px rgba(15, 23, 42, .06);
      --radius: 16px;
    }
/* âœ… é¿å…é–‹ drawer é€ æˆ scrollbar æ¶ˆå¤±â†’é é¢å¯¬åº¦è®Šå‹•â†’FullCalendar é‡ç•« */
html { overflow-y: scroll; }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      letter-spacing:.2px;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }

    .wrap{
      max-width: 1120px;
      margin: 0 auto;
      padding: 16px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    /* ===== top card ===== */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .title{
      font-size: 15px;
      font-weight: 700;
      margin: 0;
    }
    .sub{
      margin-top:6px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .controls{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap: wrap;
    }
    .input{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      outline: none;
      -webkit-appearance:none;
      appearance:none;
    }
    .btn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      color: var(--text);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
      font-weight: 700;
    }
    .btn:hover{ background:#fafcff; }

    .legend{
      margin-top: 10px;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 12px;
      color: var(--muted);
      align-items:center;
    }
    .legendMark{
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 12px;
      border: 1px solid transparent;
      margin-right: 2px;
    }
    .legendMark.open{
      background: var(--openBg);
      color: var(--open);
      border-color: rgba(32,165,107,.22);
    }
    .legendMark.tight{
      background: var(--yellowBg);
      color: var(--yellow);
      border-color: rgba(183,129,0,.18);
    }
    .legendMark.full{
      background: var(--redBg);
      color: var(--red);
      border-color: rgba(196,60,60,.18);
    }

    /* ===== calendar container ===== */
    #calendar{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      overflow:hidden;
    }

    /* FullCalendar typography soften */
    .fc .fc-button:focus,
    .fc .fc-button-primary:focus{
      box-shadow: 0 0 0 3px rgba(72,162,232,.18) !important;
    }

    /* æŒ‰éˆ•åƒ App chip */
    .fc .fc-button{
      border-radius: 12px !important;
      border: 1px solid var(--border) !important;
      background: #fff !important;
      color: var(--text) !important;
      padding: 8px 10px !important;
      font-weight: 800 !important;
    }
    .fc .fc-button:hover{
      border-color: rgba(72,162,232,.35) !important;
      background: var(--brandBg) !important;
    }

    /* Today æ”¹å“ç‰Œè‰² */
    .fc .fc-today-button{
      background: var(--brand) !important;
      border-color: rgba(72,162,232,.35) !important;
      color: #fff !important;
    }
    .fc .fc-today-button:disabled{ opacity:.55 !important; }

    .fc .fc-toolbar-title{
      color: var(--text);
      font-size: 16px !important;
      font-weight: 900 !important;
    }

    /* ä¸é¡¯ç¤ºäº‹ä»¶å¡Š */
    .fc .fc-daygrid-event{ display:none !important; }

    /* é»é¸æ—¥æœŸï¼šåªäº®é‚£ä¸€æ ¼ */
    .fc .fc-daygrid-day.is-selected{
      background: var(--brandBg);
    }
    .fc .fc-daygrid-day.is-selected .fc-daygrid-day-frame{
      outline: 2px solid rgba(72,162,232,.45);
      outline-offset: -2px;
      border-radius: 14px;
    }

    /* è®“æ¯æ ¼å¯¬åº¦æ›´å¹³å‡ */
    .fc .fc-daygrid-body,
    .fc .fc-scrollgrid,
    .fc .fc-scrollgrid-section-body table{
      table-layout: fixed !important;
    }

    /* æ ¼å­æ•´é«”è®ŠçŸ® */
    .fc .fc-daygrid-day-frame{
      min-height: 64px;
      padding: 4px 4px 2px !important;
    }

    /* æ—¥æœŸæ•¸å­—ï¼šç½®ä¸­/è®Šå° */
    .fc .fc-daygrid-day-top{
      justify-content: center !important;
    }
    .fc .fc-daygrid-day-number{
      float: none !important;
      display: inline-flex !important;
      align-items: center !important;
      justify-content: center !important;

      width: 22px;
      height: 22px;
      border-radius: 999px;
      margin: 2px auto 0 !important;
      padding: 0 !important;

      font-size: 12px !important;
      font-weight: 900 !important;
      color: var(--muted) !important;

      letter-spacing: 0 !important;
      font-variant-numeric: tabular-nums;
    }

    /* ä»Šå¤©æ—¥æœŸï¼šæ·¡è—åœ“é» */
    .fc .fc-day-today .fc-daygrid-day-number{
      background: var(--brandBg) !important;
      color: var(--text) !important;
      border: 1px solid rgba(72,162,232,.35) !important;
    }

    /* ä¸‰æ’å®¹å™¨ */
    .appSlots{
      margin: 4px 4px 2px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* å–®åˆ—ç¬¦è™Ÿ */
    .appSlot{
      height: 12px;
      border-radius: 6px;
      font-size: 11px;
      line-height: 12px;
      font-weight: 900;
      display:flex;
      align-items:center;
      justify-content:center;
      letter-spacing: .5px;
      border: 1px solid transparent;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      cursor: pointer;
    }

    .appSlot.open{
      background: var(--openBg);
      color: var(--open);
      border-color: rgba(32,165,107,.22);
    }
    .appSlot.tight{
      background: var(--yellowBg);
      color: var(--yellow);
      border-color: rgba(183,129,0,.18);
    }
    .appSlot.full{
      background: var(--redBg);
      color: var(--red);
      border-color: rgba(196,60,60,.18);
    }

    /* é¿å…èˆŠç‰ˆå…ƒç´ æ··å…¥ */
    .daySummary, .mBars{ display:none !important; }

    /* ===== drawer ===== */
    .mask{
      position:fixed; inset:0;
      background:rgba(16,24,40,.28);
      backdrop-filter: blur(2px);
      display:none;
      justify-content:flex-end;
      padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
      z-index: 9999;
    }
    .drawer{
      width:min(420px, 92vw);
      height:100%;
      background:#fff;
      border-left:1px solid var(--border);
      box-shadow: -12px 0 28px rgba(0,0,0,.10);
      padding:16px;
      overflow:auto;
      animation: slideIn .18s ease-out;
      -webkit-overflow-scrolling: touch;
    }
    @keyframes slideIn { from { transform: translateX(10px); opacity:.7 } to { transform:none; opacity:1 } }

    .drawerHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .drawerTitle{
      font-size: 14px;
      font-weight: 900;
      margin:0;
    }
    .drawerSub{
      margin-top:6px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.45;
    }
    .iconBtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      font-weight: 800;
    }
    .iconBtn:hover{ background:#fafcff; }

    .list{
      margin-top: 12px;
      display:grid;
      gap: 10px;
    }
    .rowCard{
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      gap: 12px;
      align-items:flex-start;
    }
    .rowLeft{
      display:grid;
      gap: 6px;
      font-size: 13px;
      min-width: 0;
    }
    .rowTop{
      display:flex;
      gap: 8px;
      align-items:center;
      color: var(--text);
      font-weight: 900;
      flex-wrap: wrap;
    }
    .rowMeta{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      word-break: break-word;
    }
    .badge{
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      white-space:nowrap;
      align-self:flex-start;
      font-weight: 900;
    }
    .badge.open{ color:var(--open); background:var(--openBg); border-color:#bfeedd; }
    .badge.tight{ color:var(--yellow); background:var(--yellowBg); border-color:#ffe2a3; }
    .badge.full{ color:var(--red); background:var(--redBg); border-color:#ffd0d0; }

    /* ===== Mobile ===== */
    @media (max-width: 520px){
      .wrap{ padding: 12px; }
      .card{ padding: 12px; }
      .controls{ width: 100%; }
      .input{ flex: 1; min-width: 0; }
      .btn{ width: 100%; }

      .fc .fc-header-toolbar{
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 10px !important;
        align-items: center !important;
      }
      .fc .fc-toolbar-chunk:nth-child(2){
        justify-self: center !important;
      }
      .fc .fc-toolbar-chunk:nth-child(1),
      .fc .fc-toolbar-chunk:nth-child(3){
        display: flex !important;
        justify-content: space-between !important;
        gap: 8px !important;
        width: 100% !important;
      }

      .fc .fc-col-header-cell-cushion{
        font-size: 12px !important;
        color: var(--muted) !important;
        font-weight: 800 !important;
      }

      .mask{ justify-content:flex-end; align-items:flex-end; }
      .drawer{
        width: 100%;
        height: min(78dvh, 78vh);
        height: min(78dvh, -webkit-fill-available);
        border-left: none;
        border-top: 1px solid var(--border);
        border-radius: 18px 18px 0 0;
        animation: slideUp .18s ease-out;
        padding-bottom: calc(16px + env(safe-area-inset-bottom));
      }
      @keyframes slideUp { from { transform: translateY(14px); opacity:.7 } to { transform:none; opacity:1 } }

      .fc .fc-daygrid-day-frame{ min-height: 58px; }
      .appSlot{ height: 11px; line-height: 11px; font-size: 10px; }
    }

    /* ===== æ˜¥ç¯€æœŸé–“æ¨™è¨˜ï¼ˆ2/16â€“2/22ï¼‰ ===== */
    .fc .fc-daygrid-day.is-cny{
      background: rgba(196,60,60,.06);
    }
    .fc .fc-daygrid-day.is-cny .fc-daygrid-day-frame{
      outline: 2px solid rgba(196,60,60,.35);
      outline-offset: -2px;
      border-radius: 14px;
    }

    /* æ˜¥ç¯€è§’æ¨™ï¼ˆå³ä¸Šè§’ï¼‰ */
    .cnyBadge{
      position:absolute;
      top: 2px;
      right: 4px;
      font-size: 14px;
      line-height: 1;
      transform: rotate(8deg);
      filter: drop-shadow(0 1px 0 rgba(0,0,0,.06));
      pointer-events:none;
      z-index: 2;
    }

    /* ä»Šå¤©/é¸å–åŒæ™‚åˆæ˜¯æ˜¥ç¯€ï¼šé¸å–æ¡†å„ªå…ˆ */
    .fc .fc-daygrid-day.is-selected.is-cny .fc-daygrid-day-frame{
      outline: 2px solid rgba(72,162,232,.45);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div>
          <div class="title">å¯é ç´„æ™‚é–“è¡¨ï¼ˆåˆ†é˜åˆ¶ï¼‰</div>
          <div class="sub">é»æ—¥æœŸå¯æŸ¥çœ‹ã€Œæ—©ä¸Š / ä¸‹åˆ / æ™šä¸Šã€è©³ç´°è³‡è¨Šã€‚</div>
        </div>

        <div class="controls">
          <input id="year" class="input" style="width:96px" inputmode="numeric" placeholder="Year" />
          <input id="month" class="input" style="width:70px" inputmode="numeric" placeholder="Month" />
          <button class="btn" id="btnReload" type="button">é‡æ–°è¼‰å…¥</button>
        </div>
      </div>

      <div class="legend">
        <span class="legendMark open">âœ“</span><span>é–‹æ”¾</span>
        <span class="legendMark tight">â–³</span><span>å°‘é‡ï¼ˆåˆ†é˜åç·Šï¼‰</span>
        <span class="legendMark full">âœ•</span><span>é¡æ»¿ / ä¸é–‹æ”¾</span>
      </div>
    </div>

    <div id="calendar"></div>
  </div>

  <!-- Drawer -->
  <div class="mask" id="mask">
    <div class="drawer" role="dialog" aria-modal="true">
      <div class="drawerHead">
        <div>
          <div class="drawerTitle" id="dTitle">æ—¥æœŸè©³æƒ…</div>
          <div class="drawerSub" id="dSub">â€”</div>
        </div>
        <button class="iconBtn" id="closeX" type="button">é—œé–‰</button>
      </div>

      <div class="list" id="detailList"></div>

      <div class="drawerSub" style="margin-top:12px;">
        ï¼Šç‚ºç¢ºä¿æ¯ä½æ¯›å­©éƒ½èƒ½ç²å¾—ç©©å®šä¸”å¦¥å–„çš„ç…§é¡§<br>
        é ç´„å®‰æ’å°‡ä»¥ã€Œæ—©ï¼ä¸­ï¼æ™šã€ä¸‰å€‹æ™‚æ®µå€æ®µç‚ºä¸»ã€‚<br>
        <span class="hl">è¡Œç¨‹åŸå‰‡ä¸Šæœƒç›¡é‡é¿é–‹ä¸Šä¸‹ç­å°–å³°æ™‚æ®µå®‰æ’ã€‚</span><br><br>

        <span class="hl">è‹¥æœ‰æŒ‡å®šåˆ°åºœæ™‚é–“çš„éœ€æ±‚ï¼Œ<br>
        è«‹æ–¼æœå‹™æ—¥å‰åŠå€‹æœˆè‡³ä¸€å€‹æœˆæå‰é ç´„å”·ï½</span><br>
        <span class="hl">è‹¥éœ€æŒ‡å®šæ–¼å°–å³°æ™‚æ®µï¼ˆ17:00â€“19:00ï¼‰åˆ°åºœ<br>
        å°‡é…Œæ”¶ NT$200ï¼æ¬¡ ä¹‹æ™‚æ®µè£œè²¼ã€‚</span><br><br>

        ï¼Šå¯¦éš›æœå‹™æ™‚é–“ä»ä»¥ Pinyu æœ€çµ‚ç¢ºèªç‚ºæº–ã€‚<br><br>

        ï¼Šæœ¬ç¶²é ç›®å‰ä»ç‚ºæ¸¬è©¦éšæ®µï¼Œ
        è‹¥æœ‰ä»»ä½•ç–‘å•æˆ–ç™¼ç¾éŒ¯èª¤ï¼Œ
        æ­¡è¿éš¨æ™‚å‘Šè¨´ Pinyuï¼Œè¬è¬æ‚¨çš„é«”è«’èˆ‡é…åˆ ğŸ¤<br><br>
      </div>
    </div>
  </div>

  <script>
    // ====== Vercel API ======
    const API_URL = "/api/avail";

    // âœ… æ˜¥ç¯€æœŸé–“ï¼ˆå«èµ·è¨–ï¼‰â€”â€”ç§»åˆ°å…¨åŸŸï¼Œé¿å… openDrawer è®€ä¸åˆ°
    const CNY_START = '2026-02-16';
    const CNY_END   = '2026-02-22';

    function isBetweenInclusive(dateStr, startStr, endStr){
      return dateStr >= startStr && dateStr <= endStr; // YYYY-MM-DD å¯ç›´æ¥æ¯”å­—ä¸²
    }

    // é¿å…ç”¨ toISOString é€ æˆæ™‚å€åä¸€å¤©ï¼šç”¨æœ¬åœ°å¹´æœˆæ—¥çµ„å­—ä¸²
    function toLocalDateStr(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // âœ… åªæœ‰ 3 æ®µï¼ˆç„¡æ·±å¤œï¼‰
    const slotLabel = {
      MORNING: "æ—©ä¸Š",
      AFTERNOON: "ä¸‹åˆ",
      EVENING: "æ™šä¸Š"
    };
    const SLOT_ORDER = ["MORNING","AFTERNOON","EVENING"];

    const LOW_MIN_THRESHOLD = 60; // å°‘é‡é–€æª»ï¼š<=60 åˆ†é˜ â†’ é»ƒ

   // drawer close/open flag
let isModalOpen = false;

function afterOverlayChangeRerender(){
  // è®“ FullCalendar æœ‰æ©Ÿæœƒé‡ç•«å¾Œï¼Œå†æŠŠ appSlots è£œå›å»
  requestAnimationFrame(() => {
    renderAllSummaries();
    applySelectedStyle();
  });
}

const mask = document.getElementById('mask');
const closeX = document.getElementById('closeX');

function closeDrawer(){
  isModalOpen = false;
  mask.style.display = 'none';
  afterOverlayChangeRerender();
}

closeX.onclick = closeDrawer;
mask.onclick = (e) => { if (e.target === mask) closeDrawer(); };

    // è³‡æ–™æ•´ç†ï¼šdate -> {slot->item}
    function groupByDate(data){
      const map = new Map();
      for (const it of (Array.isArray(data) ? data : [])) {
        const date = it.date;
        if (!map.has(date)) map.set(date, {});
        map.get(date)[it.slot] = it;
      }
      return map;
    }

    function markIcon(cls){
      if (cls === 'open') return 'âœ“';
      if (cls === 'tight') return 'â–³';
      return 'âœ•';
    }

    // âœ… æ°¸é å¯é–‹ drawerï¼ˆå°±ç®—ç•¶å¤©æ²’è³‡æ–™ï¼Œä¹Ÿé¡¯ç¤ºé è¨­é¡æ»¿ï¼‰
    function openDrawer(dateStr, dayObj){
      const title = document.getElementById('dTitle');
      const sub = document.getElementById('dSub');
      const list = document.getElementById('detailList');

      title.textContent = dateStr;

      const isCny = isBetweenInclusive(dateStr, CNY_START, CNY_END);
      sub.textContent = isCny
        ? 'æ—©ä¸Š / ä¸‹åˆ / æ™šä¸Šï½œæ˜¥ç¯€æœŸé–“ï¼ˆç‰¹åˆ¥åƒ¹æ ¼ï¼‰'
        : 'æ—©ä¸Š / ä¸‹åˆ / æ™šä¸Š';

      list.innerHTML = '';

      for (const s of SLOT_ORDER){
        const it = (dayObj && dayObj[s]) ? dayObj[s] : null;

        const start = it ? it.start : 'â€”';
        const end = it ? it.end : 'â€”';
        const mins = it ? Number(it.availableMinutes || 0) : 0;
        const status = it ? String(it.status || '').trim() : 'é¡æ»¿';

        const cls = classify(status, mins);

        // âœ… ç›¸å®¹æ–°èˆŠæ¬„ä½
        const blocked = it ? String(it.blocked ?? it.occupied ?? '') : '';
        const remaining = it ? String(it.remaining ?? it.note ?? '') : '';
        const blockedText = blocked ? blocked : '';
        const remainingText = remaining ? remaining : '';

        const row = document.createElement('div');
        row.className = 'rowCard';

        const left = document.createElement('div');
        left.className = 'rowLeft';

        const top = document.createElement('div');
        top.className = 'rowTop';
        top.textContent = `${slotLabel[s]}  Â·  ${start}â€“${end}`;

        const meta = document.createElement('div');
        meta.className = 'rowMeta';

        const metaLines = [];
        if (remainingText) metaLines.push(`å‰©é¤˜ï¼š${remainingText}`);
        if (blockedText && blockedText !== 'â€”') metaLines.push(`ä¸å¯é ç´„ï¼š${blockedText}`);
        meta.textContent = metaLines.join('ï½œ');

        left.appendChild(top);
        left.appendChild(meta);

        const badge = document.createElement('div');
        badge.className = `badge ${cls}`;
        badge.textContent = (cls === 'open') ? 'é–‹æ”¾' : (cls === 'tight' ? 'å°‘é‡' : 'é¡æ»¿');

        row.appendChild(left);
        row.appendChild(badge);
        list.appendChild(row);
      }

      mask.style.display = 'flex';
    }

    // ===== æœˆæ›†æ ¼å…§ä¸‰æ’ç¬¦è™Ÿ =====
    function renderDayCellSummary(dateStr, cell, grouped){
      const dayObj = grouped.get(dateStr);

      const frame = cell.querySelector('.fc-daygrid-day-frame');
      if (!frame) return;

      // é¿å…é‡è¤‡æ¸²æŸ“
      if (frame.querySelector('.appSlots')) return;

      // âœ… å³ä½¿æ²’æœ‰è³‡æ–™ï¼Œä»ç„¶å¯é»æ—¥æœŸæ ¼é–‹ drawerï¼ˆä½†ä¸å¼·è¿«æ¸²æŸ“ä¸‰æ’ï¼‰
      if (!dayObj) return;

      const wrap = document.createElement('div');
      wrap.className = 'appSlots';

      for (const key of SLOT_ORDER){
        const it = dayObj[key] || null;
        const mins = it ? Number(it.availableMinutes || 0) : 0;
        const status = it ? String(it.status || '').trim() : 'é¡æ»¿';

        const cls = classify(status, mins);
        const icon = markIcon(cls);

        const bar = document.createElement('div');
        bar.className = `appSlot ${cls}`;
        bar.textContent = icon;

        wrap.appendChild(bar);
      }

      wrap.onclick = (e) => {
        e.stopPropagation();
        selectedDateStr = dateStr;
        applySelectedStyle();
        openDrawer(dateStr, dayObj || {});
      };

      frame.appendChild(wrap);
    }

    function renderAllSummaries(){
      if (!calendar) return;

      document.querySelectorAll('.appSlots').forEach(el => el.remove());

      document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(cell => {
        const dateStr = cell.getAttribute('data-date');
        renderDayCellSummary(dateStr, cell, groupedData);
      });
    }

    let selectedDateStr = null;

    function applySelectedStyle(){
      document.querySelectorAll('.fc-daygrid-day.is-selected')
        .forEach(el => el.classList.remove('is-selected'));

      if (!selectedDateStr) return;

      const cell = document.querySelector(`.fc-daygrid-day[data-date="${selectedDateStr}"]`);
      if (cell) cell.classList.add('is-selected');
    }

    let calendar;
    let groupedData = new Map();

    async function loadAndRender(year, month) {
      const data = await fetchMonth(year, month);
      groupedData = groupByDate(data);

      const el = document.getElementById('calendar');
      if (!calendar) {
        calendar = new FullCalendar.Calendar(el, {
          initialView: 'dayGridMonth',
          height: 'auto',
          locale: 'zh-tw',

          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
          },

          dayCellContent: function(arg){
            const n = String(arg.dayNumberText).match(/\d+/)?.[0] || '';
            return { html: `<span class="fc-daygrid-day-number">${n}</span>` };
          },

          // âœ… æ˜¥ç¯€æ¨™è¨˜ + è§’æ¨™ï¼ˆæ¯æ ¼æ¸²æŸ“æ™‚åšï¼‰
          dayCellDidMount: function(arg){
            const dateStr = toLocalDateStr(arg.date);
            const isCny = isBetweenInclusive(dateStr, CNY_START, CNY_END);

            if (isCny){
              arg.el.classList.add('is-cny');

              const frame = arg.el.querySelector('.fc-daygrid-day-frame');
              if (frame && !frame.querySelector('.cnyBadge')){
                const badge = document.createElement('div');
                badge.className = 'cnyBadge';
                badge.textContent = 'ğŸ§§';
                frame.appendChild(badge);
              }
            } else {
              arg.el.classList.remove('is-cny');
              const frame = arg.el.querySelector('.fc-daygrid-day-frame');
              const badge = frame ? frame.querySelector('.cnyBadge') : null;
              if (badge) badge.remove();
            }
          },

          events: [],

                  datesSet: async function(info){
  if (isModalOpen) return; // âœ… drawer é–‹å•Ÿæ™‚ä¸è¦å›  re-render å»é‡æŠ“/æœˆè¼¸å…¥æ¡†è·³æ‰
            const d = info.start;
            const y = d.getFullYear();
            const m = d.getMonth() + 1;

            yearInput.value = y;
            monthInput.value = m;

            try {
              const data = await fetchMonth(y, m);
              groupedData = groupByDate(data);

              renderAllSummaries();
              applySelectedStyle();
            } catch (e) {
              console.error('è¼‰å…¥æœˆä»½å¤±æ•—', e);
            }
          },
windowResize: function(){
  renderAllSummaries();
  applySelectedStyle();
}

          // âœ… ä¿®æ­£ï¼šä¸ç®¡æœ‰æ²’æœ‰è³‡æ–™ï¼Œéƒ½è¦èƒ½è·³å‡º drawer
          dateClick: function(info){
            selectedDateStr = info.dateStr;
            applySelectedStyle();

            const dayObj = groupedData.get(info.dateStr) || {};
            openDrawer(info.dateStr, dayObj);
          }
        });

        calendar.render();
      }

      calendar.gotoDate(`${year}-${String(month).padStart(2,'0')}-01`);
      renderAllSummaries();
      applySelectedStyle();
    }

    // UI init
    const yearInput = document.getElementById('year');
    const monthInput = document.getElementById('month');

    yearInput.value = 2026;
    monthInput.value = 1;

    document.getElementById('btnReload').onclick = async () => {
      try {
        await loadAndRender(Number(yearInput.value), Number(monthInput.value));
      } catch (err) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
        console.error(err);
      }
    };

    (async () => {
      try {
        await loadAndRender(Number(yearInput.value), Number(monthInput.value));
      } catch (err) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message + '\n\nè«‹ç¢ºèª /api/avail æ˜¯å¦å¯å›å‚³ JSON');
        console.error(err);
      }
    })();
  </script>
</body>
</html>
