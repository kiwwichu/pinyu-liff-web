<script>
  // ====== 你只要改這行 ======
  const API_URL = "https://script.google.com/macros/s/AKfycbwLPWcww8-b4IFrNLTksQo2KrxfW5hjoiTdFfhmybH-Tb-xmzWd5sP8bCYwaKWo_Xz02w/exec";
  // ========================

  const slotLabel = {
    MORNING: "早上",
    AFTERNOON: "下午",
    EVENING: "晚上",
    LATE: "深夜"
  };

  // ===== Drawer close =====
  const mask = document.getElementById('mask');
  const closeX = document.getElementById('closeX');
  closeX.onclick = () => mask.style.display = 'none';
  mask.onclick = (e) => { if (e.target === mask) mask.style.display = 'none'; };

  function ymdToday() {
    const d = new Date();
    return { y: d.getFullYear(), m: d.getMonth() + 1 };
  }

  function stripBufferText(occupied) {
    if (!occupied) return '';
    // occupied 用 "；" 串起來：把含「緩衝」的段落濾掉
    return String(occupied)
      .split('；')
      .map(s => s.trim())
      .filter(s => s && !s.includes('緩衝'))
      .join('；');
  }

  function statusBadgeClass(status){
    // 你要：藍=開放、黃=額滿、紅=暫不開放
    if (status === '開放') return 'open';
    if (status === '額滿') return 'full';
    return 'closed'; // 不開放 / 暫不開放
  }

  function openDrawer(info) {
    const mins = Number(info.availableMinutes || 0);
    const status = String(info.status || '').trim();

    document.getElementById('dDate').textContent = info.date;
    document.getElementById('dSlot').innerHTML =
      `${slotLabel[info.slot] || info.slot} <span class="muted">(${info.slot})</span>`;

    document.getElementById('dTime').textContent = `${info.start}–${info.end}`;
    document.getElementById('dMin').textContent = `${mins} 分鐘`;

    const cls = statusBadgeClass(status);
    document.getElementById('dStatus').innerHTML =
      `<span class="badge ${cls}">${status}</span>`;

    // 占用：不顯示緩衝
    const occ = stripBufferText(info.occupied);
    document.getElementById('dOcc').textContent = occ || '—';

    // 備註：也不顯示緩衝字眼（更乾淨）
    const note = String(info.note || '').replace(/緩衝.*$/g,'').trim();
    document.getElementById('dNote').textContent = note;

    mask.style.display = 'flex';
  }

  async function fetchMonth(year, month) {
    const url = `${API_URL}?year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`API error ${res.status}`);
    return await res.json();
  }

  // 你要的顏色對應：
  // 開放=藍、額滿=黃、暫不開放=紅
  function classByStatus(status){
    status = String(status || '').trim();
    if (status === '開放') return 'ev-open';
    if (status === '額滿') return 'ev-full';     // 黃（我下面會把 ev-full 改成黃）
    return 'ev-closed';                           // 紅（暫不開放）
  }

  function toEvent(item) {
    const startISO = `${item.date}T${item.start}:00`;
    const endISO   = `${item.date}T${item.end}:00`;

    const mins = Number(item.availableMinutes || 0);
    const status = String(item.status || '').trim();

    const className = classByStatus(status);

    // 顯示：「13:00 下午｜240m」→ 我們用 eventContent 自訂，不用 title 擠爆
    const title = `${slotLabel[item.slot] || item.slot}｜${mins}m`;

    return {
      title,
      start: startISO,
      end: endISO,
      allDay: false,
      classNames: [className],
      extendedProps: item
    };
  }

  let calendar;

  async function loadAndRender(year, month) {
    const data = await fetchMonth(year, month);
    const events = Array.isArray(data) ? data.map(toEvent) : [];

    const el = document.getElementById('calendar');
    if (!calendar) {
      calendar = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        height: 'auto',
        locale: 'zh-tw',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },

        // ✅ 這裡才是 eventContent 正確位置
        eventContent: function(arg){
          const p = arg.event.extendedProps;
          const mins = Number(p.availableMinutes || 0);
          const label = slotLabel[p.slot] || p.slot;
          const text = `${p.start} ${label}｜${mins}m`;

          const wrap = document.createElement('div');
          wrap.style.display = 'flex';
          wrap.style.alignItems = 'center';
          wrap.style.gap = '6px';

          const dot = document.createElement('span');
          dot.style.width = '8px';
          dot.style.height = '8px';
          dot.style.borderRadius = '999px';
          dot.style.background = 'currentColor';
          dot.style.opacity = '0.7';

          const txt = document.createElement('div');
          txt.style.whiteSpace = 'nowrap';
          txt.style.overflow = 'hidden';
          txt.style.textOverflow = 'ellipsis';
          txt.style.fontWeight = '750';
          txt.textContent = text;

          wrap.appendChild(dot);
          wrap.appendChild(txt);
          return { domNodes: [wrap] };
        },

        events,

        eventClick: function(arg) {
          openDrawer(arg.event.extendedProps);
        },

        eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false }
      });

      calendar.render();
    } else {
      calendar.removeAllEvents();
      calendar.addEventSource(events);
      calendar.gotoDate(`${year}-${String(month).padStart(2,'0')}-01`);
    }
  }

  // ===== UI init =====
  const yearInput = document.getElementById('year');
  const monthInput = document.getElementById('month');

  yearInput.value = 2026;
  monthInput.value = 1;

  document.getElementById('btnReload').onclick = async () => {
    const year = Number(yearInput.value);
    const month = Number(monthInput.value);
    try {
      await loadAndRender(year, month);
    } catch (err) {
      alert('載入失敗：' + err.message);
      console.error(err);
    }
  };

  // 首次載入
  (async () => {
    try {
      await loadAndRender(Number(yearInput.value), Number(monthInput.value));
    } catch (err) {
      alert('載入失敗：' + err.message + '\n\n請確認 API_URL / Web App 權限');
      console.error(err);
    }
  })();
</script>
