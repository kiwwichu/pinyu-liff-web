<!doctype html> 
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å¯é ç´„æ™‚é–“è¡¨</title>

<!-- FullCalendar (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<style>
/* è¢å…‰ç­† highlightï¼ˆå“ç‰Œè—æ·¡åº• + åœ“è§’ï¼‰ */
.hl{
display: inline;
padding: 0 .22em;
border-radius: .45em;
background: linear-gradient(transparent 55%, rgba(72,162,232,.22) 55%);
box-decoration-break: clone;
-webkit-box-decoration-break: clone;
}
:root{
--bg:#f6f8fb;
--card:#ffffff;
--border:#e8edf6;
--text:#24324a;
--muted:#6b7a90;

/* å“ç‰Œä¸»è‰²ï¼ˆè—ï¼‰ */
--brand:#48a2e8;
--brandBg:#eef8ff;

/* ç‹€æ…‹è‰²ï¼šé–‹æ”¾=ç¶ ã€å°‘é‡=é»ƒã€é¡æ»¿=ç´… */
--open:#20a56b;
--openBg:#eafaf2;

--yellow:#b78100;
--yellowBg:#fff7e5;

--red:#c43c3c;
--redBg:#ffecec;

--shadow: 0 10px 30px rgba(15, 23, 42, .06);
--radius: 16px;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
margin:0;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
background:var(--bg);
color:var(--text);
letter-spacing:.2px;
-webkit-text-size-adjust: 100%;
overscroll-behavior: none;
}

.wrap{
max-width: 1120px;
margin: 0 auto;
padding: 16px;
display:grid;
grid-template-columns: 1fr;
gap: 12px;
}

/* ===== top card ===== */
.card{
background:var(--card);
border:1px solid var(--border);
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 14px;
}
.topbar{
display:flex;
justify-content:space-between;
align-items:flex-start;
gap: 12px;
flex-wrap: wrap;
}
.title{
font-size: 15px;
font-weight: 700;
margin: 0;
}
.sub{
margin-top:6px;
font-size: 12px;
color: var(--muted);
line-height: 1.45;
}
.controls{
display:flex;
gap:8px;
align-items:center;
flex-wrap: wrap;
}
.input{
border:1px solid var(--border);
background:#fff;
border-radius: 12px;
padding: 10px 12px;
font-size: 13px;
color: var(--text);
outline: none;
-webkit-appearance:none;
appearance:none;
}
.btn{
border:1px solid var(--border);
background:#fff;
border-radius: 12px;
padding: 10px 12px;
font-size: 13px;
color: var(--text);
cursor:pointer;
-webkit-tap-highlight-color: transparent;
font-weight: 700;
}
.btn:hover{ background:#fafcff; }

.legend{
margin-top: 10px;
display:flex;
gap: 8px;
flex-wrap: wrap;
font-size: 12px;
color: var(--muted);
align-items:center;
}
.legendMark{
width: 18px;
height: 18px;
border-radius: 999px;
display:inline-flex;
align-items:center;
justify-content:center;
font-weight: 900;
font-size: 12px;
border: 1px solid transparent;
margin-right: 2px;
}
.legendMark.open{
background: var(--openBg);
color: var(--open);
border-color: rgba(32,165,107,.22);
}
.legendMark.tight{
background: var(--yellowBg);
color: var(--yellow);
border-color: rgba(183,129,0,.18);
}
.legendMark.full{
background: var(--redBg);
color: var(--red);
border-color: rgba(196,60,60,.18);
}

.dot{
width:10px;height:10px;border-radius:99px; display:inline-block;
border:1px solid var(--border);
}
.dot.blue{ background: var(--openBg); border-color: rgba(32,165,107,.35); }
.dot.yellow{ background:var(--yellowBg); border-color:#ffe2a3; }
.dot.red{ background:var(--redBg); border-color:#ffd0d0; }

/* ===== calendar container ===== */
#calendar{
background:#fff;
border:1px solid var(--border);
border-radius: var(--radius);
box-shadow: var(--shadow);
padding: 10px;
overflow:hidden;
}

/* FullCalendar typography soften */
.fc .fc-button:focus,
.fc .fc-button-primary:focus{
box-shadow: 0 0 0 3px rgba(72,162,232,.18) !important;
}

/* æŒ‰éˆ•åƒ App chip */
.fc .fc-button{
border-radius: 12px !important;
border: 1px solid var(--border) !important;
background: #fff !important;
color: var(--text) !important;
padding: 8px 10px !important;
font-weight: 800 !important;
}
.fc .fc-button:hover{
border-color: rgba(72,162,232,.35) !important;
background: var(--brandBg) !important;
}

/* Today æ”¹å“ç‰Œè‰² */
.fc .fc-today-button{
background: var(--brand) !important;
border-color: rgba(72,162,232,.35) !important;
color: #fff !important;
}
.fc .fc-today-button:disabled{ opacity:.55 !important; }

.fc .fc-toolbar-title{
color: var(--text);
font-size: 16px !important;
font-weight: 900 !important;
}

/* ä¸é¡¯ç¤ºäº‹ä»¶å¡Š */
.fc .fc-daygrid-event{ display:none !important; }

/* é»é¸æ—¥æœŸï¼šåªäº®é‚£ä¸€æ ¼ */
.fc .fc-daygrid-day.is-selected{
background: var(--brandBg);
}
.fc .fc-daygrid-day.is-selected .fc-daygrid-day-frame{
outline: 2px solid rgba(72,162,232,.45);
outline-offset: -2px;
border-radius: 14px;
}

/* ===============================
      âœ… App æœˆæ›†ï¼šæ ¼å­æ›´çŸ®(è¦–è¦ºæ›´å¯¬) + æ—¥æœŸæ•¸å­—ç½®ä¸­è®Šå° + ä¸‰æ’ç¬¦è™Ÿæ¢
      =============================== */

/* è®“æ¯æ ¼å¯¬åº¦æ›´å¹³å‡ï¼ˆè¦–è¦ºæ›´åƒ Appï¼‰ */
.fc .fc-daygrid-body,
.fc .fc-scrollgrid,
.fc .fc-scrollgrid-section-body table{
table-layout: fixed !important;
}

/* æ ¼å­æ•´é«”è®ŠçŸ® â†’ è¦–è¦ºå°±æœƒè®Šå¯¬ã€ä¸æ“  */
.fc .fc-daygrid-day-frame{
min-height: 64px;
padding: 4px 4px 2px !important;
}

/* ===== æ—¥æœŸæ•¸å­—ï¼šç½®ä¸­/è®Šå°ï¼ˆå¯¦éš›å»æ‰ã€Œæ—¥ã€ç”¨ dayCellContent è™•ç†ï¼‰ ===== */
.fc .fc-daygrid-day-top{
justify-content: center !important;
}
.fc .fc-daygrid-day-number{
float: none !important;
display: inline-flex !important;
align-items: center !important;
justify-content: center !important;

width: 22px;
height: 22px;
border-radius: 999px;
margin: 2px auto 0 !important;
padding: 0 !important;

font-size: 12px !important;
font-weight: 900 !important;
color: var(--muted) !important;

letter-spacing: 0 !important;
font-variant-numeric: tabular-nums;
}

/* ä»Šå¤©æ—¥æœŸï¼šæ·¡è—åœ“é» */
.fc .fc-day-today .fc-daygrid-day-number{
background: var(--brandBg) !important;
color: var(--text) !important;
border: 1px solid rgba(72,162,232,.35) !important;
}

/* ä¸‰æ’å®¹å™¨ */
.appSlots{
margin: 4px 4px 2px;
display: flex;
flex-direction: column;
gap: 4px;
}

/* å–®åˆ—ç¬¦è™Ÿï¼šç½®ä¸­ */
.appSlot{
height: 12px;
border-radius: 6px;
font-size: 11px;
line-height: 12px;
font-weight: 900;
display:flex;
align-items:center;
justify-content:center;
letter-spacing: .5px;
border: 1px solid transparent;
user-select:none;
-webkit-tap-highlight-color: transparent;
}

/* é–‹æ”¾ï¼ˆç¶ ï¼‰ */
.appSlot.open{
background: var(--openBg);
color: var(--open);
border-color: rgba(32,165,107,.22);
}

/* å°‘é‡ï¼ˆé»ƒï¼‰ */
.appSlot.tight{
background: var(--yellowBg);
color: var(--yellow);
border-color: rgba(183,129,0,.18);
}

/* é¡æ»¿/ä¸é–‹æ”¾ï¼ˆç´…ï¼‰ */
.appSlot.full{
background: var(--redBg);
color: var(--red);
border-color: rgba(196,60,60,.18);
}

/* é¿å…ä½ ä¹‹å‰ç‰ˆæœ¬çš„å…ƒç´ æ··é€²ä¾† */
.daySummary, .mBars{ display:none !important; }

/* ===== drawer ===== */
.mask{
position:fixed; inset:0;
background:rgba(16,24,40,.28);
backdrop-filter: blur(2px);
display:none;
justify-content:flex-end;
padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
z-index: 9999;
}
.drawer{
width:min(420px, 92vw);
height:100%;
background:#fff;
border-left:1px solid var(--border);
box-shadow: -12px 0 28px rgba(0,0,0,.10);
padding:16px;
overflow:auto;
animation: slideIn .18s ease-out;
-webkit-overflow-scrolling: touch;
}
@keyframes slideIn { from { transform: translateX(10px); opacity:.7 } to { transform:none; opacity:1 } }

.drawerHead{
display:flex;
align-items:flex-start;
justify-content:space-between;
gap:10px;
margin-bottom:10px;
}
.drawerTitle{
font-size: 14px;
font-weight: 900;
margin:0;
}
.drawerSub{
margin-top:6px;
color: var(--muted);
font-size: 12px;
line-height: 1.45;
}
.iconBtn{
border:1px solid var(--border);
background:#fff;
border-radius: 12px;
padding: 8px 10px;
cursor:pointer;
font-size: 12px;
color: var(--text);
-webkit-tap-highlight-color: transparent;
font-weight: 800;
}
.iconBtn:hover{ background:#fafcff; }

.list{
margin-top: 12px;
display:grid;
gap: 10px;
}
.rowCard{
border:1px solid var(--border);
border-radius: 14px;
padding: 12px;
background:#fff;
display:flex;
justify-content:space-between;
gap: 12px;
align-items:flex-start;
}
.rowLeft{
display:grid;
gap: 6px;
font-size: 13px;
min-width: 0;
}
.rowTop{
display:flex;
gap: 8px;
align-items:center;
color: var(--text);
font-weight: 900;
flex-wrap: wrap;
}
.rowMeta{
color: var(--muted);
font-size: 12px;
line-height: 1.4;
word-break: break-word;
}
.badge{
font-size: 11px;
padding: 6px 10px;
border-radius: 999px;
border:1px solid var(--border);
white-space:nowrap;
align-self:flex-start;
font-weight: 900;
}
.badge.open{ color:var(--open); background:var(--openBg); border-color:#bfeedd; }
.badge.tight{ color:var(--yellow); background:var(--yellowBg); border-color:#ffe2a3; }
.badge.full{ color:var(--red); background:var(--redBg); border-color:#ffd0d0; }

/* ===== âœ… Mobile / LINE in-app browser optimize ===== */
@media (max-width: 520px){
.wrap{ padding: 12px; }
.card{ padding: 12px; }
.controls{ width: 100%; }
.input{ flex: 1; min-width: 0; }
.btn{ width: 100%; }

/* å·¥å…·åˆ—æ”¹å…©è¡Œï¼šç¬¬ä¸€è¡Œ titleï¼Œç¬¬äºŒè¡Œ buttonsï¼ˆä¸æ“ ï¼‰ */
.fc .fc-header-toolbar{
display: grid !important;
grid-template-columns: 1fr !important;
gap: 10px !important;
align-items: center !important;
}
.fc .fc-toolbar-chunk:nth-child(2){
justify-self: center !important;
}
.fc .fc-toolbar-chunk:nth-child(1),
.fc .fc-toolbar-chunk:nth-child(3){
display: flex !important;
justify-content: space-between !important;
gap: 8px !important;
width: 100% !important;
}

/* é€±æ¨™é¡Œ */
.fc .fc-col-header-cell-cushion{
font-size: 12px !important;
color: var(--muted) !important;
font-weight: 800 !important;
}

/* drawer è®Šåº•éƒ¨ sheet */
.mask{ justify-content:flex-end; align-items:flex-end; }
.drawer{
width: 100%;
height: min(78dvh, 78vh);
height: min(78dvh, -webkit-fill-available);
border-left: none;
border-top: 1px solid var(--border);
border-radius: 18px 18px 0 0;
animation: slideUp .18s ease-out;
padding-bottom: calc(16px + env(safe-area-inset-bottom));
}
@keyframes slideUp { from { transform: translateY(14px); opacity:.7 } to { transform:none; opacity:1 } }

.fc .fc-daygrid-day-frame{ min-height: 58px; }
.appSlot{ height: 11px; line-height: 11px; font-size: 10px; }
}
</style>
</head>

<body>
<div class="wrap">
<div class="card">
<div class="topbar">
<div>
<div class="title">å¯é ç´„æ™‚é–“è¡¨ï¼ˆåˆ†é˜åˆ¶ï¼‰</div>
<div class="sub">é»æ—¥æœŸå¯æŸ¥çœ‹ã€Œæ—©ä¸Š / ä¸‹åˆ / æ™šä¸Šã€è©³ç´°è³‡è¨Šã€‚</div>
</div>

<div class="controls">
<input id="year" class="input" style="width:96px" inputmode="numeric" placeholder="Year" />
<input id="month" class="input" style="width:70px" inputmode="numeric" placeholder="Month" />
<button class="btn" id="btnReload" type="button">é‡æ–°è¼‰å…¥</button>
</div>
</div>

<div class="legend">
<span class="legendMark open">âœ“</span><span>é–‹æ”¾</span>
<span class="legendMark tight">â–³</span><span>å°‘é‡ï¼ˆåˆ†é˜åç·Šï¼‰</span>
<span class="legendMark full">âœ•</span><span>é¡æ»¿ / ä¸é–‹æ”¾</span>
</div>

</div>

<div id="calendar"></div>
</div>

<!-- Drawer -->
<div class="mask" id="mask">
<div class="drawer" role="dialog" aria-modal="true">
<div class="drawerHead">
<div>
<div class="drawerTitle" id="dTitle">æ—¥æœŸè©³æƒ…</div>
<div class="drawerSub" id="dSub">â€”</div>
</div>
<button class="iconBtn" id="closeX" type="button">é—œé–‰</button>
</div>

<div class="list" id="detailList"></div>

<div class="drawerSub" style="margin-top:12px;">
ï¼Šç‚ºç¢ºä¿æ¯ä½æ¯›å­©éƒ½èƒ½ç²å¾—ç©©å®šä¸”å¦¥å–„çš„ç…§é¡§<br>
é ç´„å®‰æ’å°‡ä»¥ã€Œæ—©ï¼ä¸­ï¼æ™šã€ä¸‰å€‹æ™‚æ®µå€æ®µç‚ºä¸»ã€‚<br>
<span class="hl">è¡Œç¨‹åŸå‰‡ä¸Šæœƒç›¡é‡é¿é–‹ä¸Šä¸‹ç­å°–å³°æ™‚æ®µå®‰æ’ã€‚</span><br><br>

<span class="hl"> è‹¥æœ‰æŒ‡å®šåˆ°åºœæ™‚é–“çš„éœ€æ±‚ï¼Œ<br>
è«‹æ–¼æœå‹™æ—¥å‰åŠå€‹æœˆè‡³ä¸€å€‹æœˆæå‰é ç´„å”·ï½ </span><br>
<span class="hl"> è‹¥éœ€æŒ‡å®šæ–¼å°–å³°æ™‚æ®µï¼ˆ17:00â€“19:00ï¼‰åˆ°åºœ<br>
å°‡é…Œæ”¶ NT$200ï¼æ¬¡ ä¹‹æ™‚æ®µè£œè²¼ã€‚ </span><br><br>

ï¼Šæœ¬ç¶²é ç›®å‰ä»ç‚ºæ¸¬è©¦éšæ®µï¼Œè‹¥æœ‰ä»»ä½•ç–‘å•æˆ–ç™¼ç¾éŒ¯èª¤ï¼Œæ­¡è¿éš¨æ™‚å‘Šè¨´ Pinyuï¼Œè¬è¬æ‚¨çš„é«”è«’èˆ‡é…åˆ ğŸ¤<br><br>
ï¼Šå¯¦éš›æœå‹™æ™‚é–“ä»ä»¥ Pinyu æœ€çµ‚ç¢ºèªç‚ºæº–ã€‚
</div>
</div>
</div>

<script>
// ====== Vercel API ======
const API_URL = "/api/avail";

// âœ… åªæœ‰ 3 æ®µï¼ˆç„¡æ·±å¤œï¼‰
const slotLabel = {
  MORNING: "æ—©ä¸Š",
  AFTERNOON: "ä¸‹åˆ",
  EVENING: "æ™šä¸Š"
};
const SLOT_ORDER = ["MORNING","AFTERNOON","EVENING"];

const LOW_MIN_THRESHOLD = 60; // å°‘é‡é–€æª»ï¼š<=60 åˆ†é˜ â†’ é»ƒ

// drawer close
const mask = document.getElementById('mask');
const closeX = document.getElementById('closeX');
closeX.onclick = () => mask.style.display = 'none';
mask.onclick = (e) => { if (e.target === mask) mask.style.display = 'none'; };

function classify(status, mins){
  status = String(status || '').trim();
  mins = Number(mins || 0);

  if (status === 'é¡æ»¿') return 'full';
  if (status === 'å°‘é‡') return 'tight';
  if (status === 'é–‹æ”¾') return 'open';

  // fallbackï¼šå¦‚æœå¾Œç«¯æ²’çµ¦ç‹€æ…‹ï¼Œæ‰ç”¨åˆ†é˜æ¨
  if (mins <= 0) return 'full';
  if (mins <= LOW_MIN_THRESHOLD) return 'tight';
  return 'open';
}

async function fetchMonth(year, month) {
  const url = `${API_URL}?year=${encodeURIComponent(year)}&month=${encodeURIComponent(month)}`;
  const res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error(`API error ${res.status}`);
  return await res.json();
}

// è³‡æ–™æ•´ç†ï¼šdate -> {slot->item}
function groupByDate(data){
  const map = new Map();
  for (const it of (Array.isArray(data) ? data : [])) {
    const date = it.date;
    if (!map.has(date)) map.set(date, {});
    map.get(date)[it.slot] = it;
  }
  return map;
}

function markIcon(cls){
  if (cls === 'open') return 'âœ“';
  if (cls === 'tight') return 'â–³';
  return 'âœ•';
}

function openDrawer(dateStr, dayObj){
  const title = document.getElementById('dTitle');
  const sub = document.getElementById('dSub');
  const list = document.getElementById('detailList');

  title.textContent = dateStr;
  sub.textContent = 'æ—©ä¸Š / ä¸‹åˆ / æ™šä¸Š';
  list.innerHTML = '';

  for (const s of SLOT_ORDER){
    const it = (dayObj && dayObj[s]) ? dayObj[s] : null;

    const start = it ? it.start : 'â€”';
    const end = it ? it.end : 'â€”';
    const mins = it ? Number(it.availableMinutes || 0) : 0;
    const status = it ? String(it.status || '').trim() : 'é¡æ»¿';

    const cls = classify(status, mins);

    // âœ… ç›¸å®¹æ–°èˆŠæ¬„ä½
    const blocked = it ? String(it.blocked ?? it.occupied ?? '') : '';
    const remaining = it ? String(it.remaining ?? it.note ?? '') : '';
    const blockedText = blocked ? blocked : '';
    const remainingText = remaining ? remaining : '';

    const row = document.createElement('div');
    row.className = 'rowCard';

    const left = document.createElement('div');
    left.className = 'rowLeft';

    const top = document.createElement('div');
    top.className = 'rowTop';
    top.textContent = `${slotLabel[s]}  Â·  ${start}â€“${end}`;

    const meta = document.createElement('div');
    meta.className = 'rowMeta';

    const metaLines = [];
    if (remainingText) metaLines.push(`å‰©é¤˜ï¼š${remainingText}`);
    if (blockedText && blockedText !== 'â€”') metaLines.push(`ä¸å¯é ç´„ï¼š${blockedText}`);
    meta.textContent = metaLines.join('ï½œ');

    left.appendChild(top);
    left.appendChild(meta);

    const badge = document.createElement('div');
    badge.className = `badge ${cls}`;
    badge.textContent = (cls === 'open') ? 'é–‹æ”¾' : (cls === 'tight' ? 'å°‘é‡' : 'é¡æ»¿');

    row.appendChild(left);
    row.appendChild(badge);
    list.appendChild(row);
  }

  mask.style.display = 'flex';
}

// ===== æœˆæ›†æ ¼å…§ä¸‰æ’ç¬¦è™Ÿï¼šèˆ‡ drawer åŒä¸€å¥— classifyï¼Œä¿è­‰ä¸€è‡´ =====
function renderDayCellSummary(dateStr, cell, grouped){
  const dayObj = grouped.get(dateStr);
  if (!dayObj) return;

  const frame = cell.querySelector('.fc-daygrid-day-frame');
  if (!frame) return;

  // é¿å…é‡è¤‡æ¸²æŸ“
  if (frame.querySelector('.appSlots')) return;

  const wrap = document.createElement('div');
  wrap.className = 'appSlots';

  for (const key of SLOT_ORDER){
    const it = dayObj[key] || null;
    const mins = it ? Number(it.availableMinutes || 0) : 0;
    const status = it ? String(it.status || '').trim() : 'é¡æ»¿';

    const cls = classify(status, mins);    // open/tight/full
    const icon = markIcon(cls);            // âœ“/â–³/âœ•

    const bar = document.createElement('div');
    bar.className = `appSlot ${cls}`;
    bar.textContent = icon;

    wrap.appendChild(bar);
  }

  wrap.onclick = (e) => {
    e.stopPropagation();
    selectedDateStr = dateStr;
    applySelectedStyle();
    openDrawer(dateStr, dayObj);
  };

  frame.appendChild(wrap);
}

function renderAllSummaries(){
  if (!calendar) return;

  // å…ˆæ¸…æ‰èˆŠæ‘˜è¦ï¼ˆé¿å…æ®˜ç•™ï¼‰
  document.querySelectorAll('.appSlots').forEach(el => el.remove());

  // æ¯å€‹ day cellï¼ˆFullCalendar dayGridMonth æ¯æ ¼éƒ½æœ‰ data-dateï¼‰
  document.querySelectorAll('.fc-daygrid-day[data-date]').forEach(cell => {
    const dateStr = cell.getAttribute('data-date');
    renderDayCellSummary(dateStr, cell, groupedData);
  });
}

let selectedDateStr = null;
function applySelectedStyle(){
  document.querySelectorAll('.fc-daygrid-day.is-selected')
    .forEach(el => el.classList.remove('is-selected'));

  if (!selectedDateStr) return;

  const cell = document.querySelector(`.fc-daygrid-day[data-date="${selectedDateStr}"]`);
  if (cell) cell.classList.add('is-selected');
}

// ======================
// âœ… æ ¸å¿ƒï¼šåˆ‡æœˆè‡ªå‹•è¼‰å…¥
// ======================
let calendar;
let groupedData = new Map();
let loadedYear = null;
let loadedMonth = null;
let monthFetchTimer = null;

function getViewYearMonth(){
  const d = calendar.getDate(); // view çš„åŸºæº–æ—¥æœŸ
  return { y: d.getFullYear(), m: d.getMonth() + 1 };
}

async function ensureMonthLoaded(year, month){
  // é¿å…é‡è¤‡æŠ“åŒä¸€å€‹æœˆ
  if (loadedYear === year && loadedMonth === month) {
    // ä»è¦é‡ç•«æ‘˜è¦ï¼ˆä¾‹å¦‚å‰› render æˆ–åˆ‡å›ä¾†ï¼‰
    renderAllSummaries();
    applySelectedStyle();
    return;
  }

  const data = await fetchMonth(year, month);
  groupedData = groupByDate(data);
  loadedYear = year;
  loadedMonth = month;

  // å¦‚æœé¸å–æ—¥æœŸä¸åœ¨é€™å€‹æœˆï¼Œå°±æ¸…æ‰é¿å…æ®˜ç•™
  if (selectedDateStr) {
    const [sy, sm] = selectedDateStr.split('-').map(Number);
    if (sy !== year || sm !== month) selectedDateStr = null;
  }

  renderAllSummaries();
  applySelectedStyle();
}

function syncInputsToView(){
  const { y, m } = getViewYearMonth();
  yearInput.value = y;
  monthInput.value = m;
}

// UI init
const yearInput = document.getElementById('year');
const monthInput = document.getElementById('month');

yearInput.value = 2026;
monthInput.value = 1;

async function initCalendar(){
  const el = document.getElementById('calendar');
  const initY = Number(yearInput.value);
  const initM = Number(monthInput.value);

  calendar = new FullCalendar.Calendar(el, {
    initialView: 'dayGridMonth',
    initialDate: `${initY}-${String(initM).padStart(2,'0')}-01`,
    height: 'auto',
    locale: 'zh-tw',

    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth'
    },

    // âœ… å¼·åˆ¶ day number åªé¡¯ç¤ºæ•¸å­—ï¼ˆå»æ‰ã€Œæ—¥ã€ï¼‰
    dayCellContent: function(arg){
      const n = String(arg.dayNumberText).match(/\d+/)?.[0] || '';
      return { html: `<span class="fc-daygrid-day-number">${n}</span>` };
    },

    events: [],

    // âœ… æ¯æ¬¡åˆ‡æœˆ/åˆ‡å› today éƒ½æœƒè§¸ç™¼ â†’ è‡ªå‹•è¼‰å…¥é‚£å€‹æœˆ
    datesSet: function(){
      // åŒæ­¥ä¸Šæ–¹ year/month
      syncInputsToView();

      // debounceï¼ˆé¿å…æŸäº›ç€è¦½å™¨é€£è§¸ç™¼ï¼‰
      clearTimeout(monthFetchTimer);
      monthFetchTimer = setTimeout(async () => {
        try{
          const { y, m } = getViewYearMonth();
          await ensureMonthLoaded(y, m);
        }catch(err){
          console.error(err);
          alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
        }
      }, 0);
    },

    dateClick: function(info){
      selectedDateStr = info.dateStr;
      applySelectedStyle();

      const dayObj = groupedData.get(info.dateStr);
      if (dayObj) openDrawer(info.dateStr, dayObj);
    }
  });

  calendar.render();

  // âœ… åˆæ¬¡è¼‰å…¥ç•¶æœˆ
  await ensureMonthLoaded(initY, initM);
}

document.getElementById('btnReload').onclick = async () => {
  try {
    const y = Number(yearInput.value);
    const m = Number(monthInput.value);
    calendar.gotoDate(`${y}-${String(m).padStart(2,'0')}-01`);
    // gotoDate æœƒè§¸ç™¼ datesSet â†’ è‡ªå‹• ensureMonthLoaded
  } catch (err) {
    alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message);
    console.error(err);
  }
};

// start
initCalendar().catch(err => {
  alert('è¼‰å…¥å¤±æ•—ï¼š' + err.message + '\n\nè«‹ç¢ºèª /api/avail æ˜¯å¦å¯å›å‚³ JSON');
  console.error(err);
});
</script>
</body>
</html>
